
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My code works, I don&#8217;t know why.</title>
  <meta name="author" content="Wen Liao">
  <meta property="og:image" content="https://wen00072.github.io/files/pb.jpg" />


  
  <meta name="description" content="感謝Scott 大大糾正，選錯平台，這篇使用了ARMv4指令集的測試平台。請大家忽略，正確的版本將會之後更新! 前情提要 上一篇提到，設定實習環境的目標有： 可以使用ARM 平台。一方面追求流行，一方面我不想再開x86這個副本
可以方便地建立ARM平台的Linux Rootfs和kernel版本 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wen00072.github.io/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My code works, I don't know why." type="application/atom+xml">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My code works, I don&#8217;t know why.</a></h1>
  
    <h2>國王的耳朵是驢耳朵</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="wen00072.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/01/linux-kernel-pratice-0-buildroot-2-customized-kernel/">(過期) Linux Kernel Pratice 0: Buildroot (2/2) - 自行編譯kernel</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-10-01T09:40:54+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2016</span></span> <span class='time'>9:40 am</span></time>
        
           | <a href="/blog/2016/10/01/linux-kernel-pratice-0-buildroot-2-customized-kernel/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/10/01/linux-kernel-pratice-0-buildroot-2-customized-kernel/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3><font color="red">感謝Scott 大大糾正，選錯平台，這篇使用了ARMv4指令集的測試平台。請大家忽略，正確的版本將會之後更新!</font></h3>

<h2>前情提要</h2>

<p><a href="blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu/">上一篇</a>提到，設定實習環境的目標有：</p>

<ol>
<li>可以使用ARM 平台。一方面追求流行，一方面我不想再開x86這個副本</li>
<li>可以方便地建立ARM平台的Linux Rootfs和kernel版本</li>
<li>可以方便地更改指定要編譯的Kernel版本</li>
<li>透過Qemu ，使用2的Rootfs和kernel開機</li>
<li>透過Qemu和搭配的工具可以分析Linux kernel的run time 行為</li>
</ol>


<p>今天就是來解決3 的項目。更細分的話，這次目標是</p>

<ol>
<li>使用官方Linux kernel 編譯Versatile</li>
<li>編譯出來的kernel binary可以在Qemu上順利載入</li>
<li>編譯出來的kernel binary可以順利的載入buildroot產生的rootfs，以及網路介面和相關設備</li>
</ol>


<h2>目錄</h2>

<ul>
<li><a href="#lk0_1_del_env">測試環境</a></li>
<li><a href="#lk0_1_del_dl">下載Linux Kernel Source</a></li>
<li><a href="#lk0_1_del_conf">設定和編譯</a>

<ul>
<li><a href="#lk0_1_del_conf_sw">切換版本</a></li>
<li><a href="#lk0_1_del_conf_arm_def">設定ARM Versatile預設config</a></li>
<li><a href="#lk0_1_del_conf_qemu">設定Qemu VM支援的硬體</a></li>
<li><a href="#lk0_1_del_conf_build">編譯</a>

<ul>
<li><a href="#lk0_1_del_conf_build_broot">Buildroot</a></li>
<li><a href="#lk0_1_del_conf_build_lk">Linux kernel</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#lk0_1_del_test">測試</a></li>
<li><a href="#lk0_1_del_ref">參考資料</a></li>
<li><a href="#lk0_1_del_app">附錄</a>

<ul>
<li><a href="#lk0_1_del_app_brot">使用Buildroot 內建套件指定編譯Linux kernel 4.2.2</a></li>
</ul>
</li>
</ul>


<p><a name="lk0_1_del_env"></a></p>

<h2>測試環境</h2>

<p>做組裝的最重要的原則之一就是要能夠reproduce，所以交代測試環境是一定要的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.5 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span><span class='line'>
</span><span class='line'>$ git --version
</span><span class='line'>git version 2.10.0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>buildroot 版本

<ul>
<li>commit hash: <code>14b24726a81b719b35fee70c8ba8be2d682a7313</code></li>
</ul>
</li>
</ul>


<p><a name="lk0_1_del_dl"></a></p>

<h2>下載Linux Kernel Source</h2>

<p>沒啥好講的，就剪貼指令吧</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git
</span></code></pre></td></tr></table></div></figure>


<p><a name="lk0_1_del_conf"></a></p>

<h2>設定和編譯</h2>

<p>東西下載完不是就閉著眼睛開幹，因為我們在開始編譯前需要</p>

<ol>
<li>切換到你想要研究的版本</li>
<li>如果不是x86，你需要指定平台</li>
<li>細項Kernel config設定</li>
</ol>


<p>那麼就來見招拆招吧</p>

<p><a name="lk0_1_del_conf_sw"></a></p>

<h3>切換版本</h3>

<p>非常簡單，先<code>git tag</code>，切過去就好。我要切到4.4.2就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git tag                 <span class="c"># 找你要的版本</span>
</span><span class='line'>git checkout v4.4.2     <span class="c"># 切到tag</span>
</span><span class='line'>git checkout -b v4.4.2  <span class="c"># 理論上會這邊改東改西，就先開branch吧</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="lk0_1_del_conf_arm_def"></a></p>

<h3>設定ARM Versatile預設config</h3>

<p>先講結論</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>make <span class="nv">ARCH</span><span class="o">=</span>arm versatile_defconfig
</span></code></pre></td></tr></table></div></figure>


<p>開始<del>沒人要看</del>的解釋吧。基本上也亂看找出來的，簡單講一下當初的「脈絡」</p>

<ol>
<li>我知道我們平台是versatile，所以就<code>find | grep versatile</code>。從一堆檔案中我看到有趣的檔案<code>./arch/arm/configs/versatile_defconfig</code>。</li>
<li>接下來就是要找make 的時候怎麼和這個檔案勾起來。網路上找一下會發現一個變數<code>ARCH</code>，剩下就試看看<code>make ARCH=arm versatile_defconfig</code>，能不能動，可以動所以打完收工。</li>
</ol>


<p>然後你就知道</p>

<ol>
<li>Linux kernel source中有些平台會提供default config</li>
<li>透過<code>ARCH</code>可以讓make時自動參考這些檔案產生config</li>
</ol>


<p><a name="lk0_1_del_conf_qemu"></a></p>

<h3>設定Qemu VM支援的硬體</h3>

<p><font color="red"><strong>建議不要把buildroot compile cache打開。我花了很多時間在kernel 編譯後Qemu還是沒有使用編譯後的kernel的問題，最後發現關閉buildroot compile cache問題就消失了。</strong></font></p>

<p>如果閉著眼睛開始<a href="#lk0_1_del_conf_build">編譯</a>，你會很高興地發現可以開機了，但是接下來就會很失望的發現kernel panic，原因是認不出開機的disk。</p>

<p>之所以會發生這樣的原因是因為Linux kernel 提供的default config選項和buildroot 給Qemu的kernel 選項不同(<a href="#lk0_1_del_app_brot">參考</a>)，比對buildroot 開機畫面，會發現他們有偵測到兩個硬體，分別是</p>

<ol>
<li>SCSI 控制器，用來辨認rootfs</li>
<li>Realtek 8139 網路卡，不用我解釋吧</li>
</ol>


<p>那麼我們這邊直接把這兩個加上去就收工沒錯吧？答案是對也不對，因為這兩個東西會和其他的部份有關。</p>

<p>以下是我用笨方式一個一個試出來需要開啟的東西，不一定最簡潔甚至正確，但是他可以開機就是了。要注意不要編成module，編譯的細節我假設讀者都知道，如果完全不懂可能要找一下新手入門資訊了。另外我列出的選項是Kernel <code>4.4.2</code>下的選項，請自行斟酌。</p>

<p>記得<strong>請用<code>make ARCH=arm menuconfig</code>更改設定</strong></p>

<ol>
<li>PCI bus，原因是SCSI控制器和網路卡是PCI bus介面，不開就沒有不會看到這些選項。</li>
<li>SCSI 包括

<ul>
<li>SSCI device</li>
<li>Disk</li>
<li>我有開Generic，懶得關掉看會不會出問題了</li>
<li>SCSI low-level drivers -> SYM53C8XX Version 2 SCSI support</li>
</ul>
</li>
<li>Network device support

<ul>
<li>Ethernet driver suppor -> Realtek devices

<ul>
<li>RealTek RTL-8139 C+ PCI Fast Ethernet Adapter support</li>
</ul>
</li>
</ul>
</li>
<li>要支援buildroot預設的device node管理方式。有興趣的可以看<a href="https://buildroot.org/downloads/manual/manual.html#_dev_management">這邊</a>

<ul>
<li>Device Drivers -> Generic Driver Options ->

<ul>
<li>Maintain a devtmpfs filesystem to mount at /dev</li>
<li>Automount devtmpfs at /dev, after the kernel mounted the rootfs</li>
</ul>
</li>
</ul>
</li>
<li>File system 要支援ext2，原因是buildroot產生的是ext2檔案格式</li>
<li>tmpfs要開啟

<ul>
<li>File systems -> Pseudo filesystems

<ul>
<li>Tmpfs virtual memory file system support (former shm fs)</li>
</ul>
</li>
</ul>
</li>
</ol>


<p>建議順便巡一下其他kernel選項，用不到的可以關一下。比如說<code>MTD</code>，一堆有的沒的網卡，音效支援之類的。</p>

<p><a name="lk0_1_del_conf_build"></a></p>

<h3>編譯</h3>

<p><a name="lk0_1_del_conf_build_broot"></a></p>

<h4>Buildroot</h4>

<ol>
<li><code>make menuconfig</code>

<ul>
<li>Toolchain -> Custom kernel headers series

<ul>
<li>改成你現在Linux 版本</li>
</ul>
</li>
</ul>
</li>
<li><code>make</code></li>
</ol>


<p><a name="lk0_1_del_conf_build_lk"></a></p>

<h4>Linux kernel</h4>

<p>指令如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>make <span class="nv">CROSS_COMPILE</span><span class="o">=</span>/tmp/buildroot/output/host/usr/bin/arm-buildroot-linux-gnueabi- <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">V</span><span class="o">=</span><span class="m">1</span> bzImage
</span></code></pre></td></tr></table></div></figure>


<p>這其實就是<code>make bzImage</code>的囉唆版，多了</p>

<ul>
<li><code>ARCH=arm</code>

<ul>
<li>指定ARM平台</li>
</ul>
</li>
<li><code>CROSS_COMPILE=..</code>

<ul>
<li>Cross compile prefix，既然我們使用buildroot內建toolchain，就用他們來編譯kernel</li>
</ul>
</li>
<li><code>V=1</code>

<ul>
<li>身為組裝工，沒看到編譯指令訊息跳出來就會沒安全感</li>
</ul>
</li>
</ul>


<p><a name="lk0_1_del_test"></a></p>

<h2>測試</h2>

<p>這邊卡關的原因是預設的buildroot (Linux kernel 4.7)使用qemu載入的時候需要指定device tree檔案。但是在Linux 4.4.2下面指定device tree檔案反而無法順利開機。我怎麼知道到的？撈git commit log去看的。</p>

<p>剩下就剪貼了</p>

<p><strong>我在buildroot top目錄執行的</strong>，你要嘛就切到buildroot目錄下，要嘛就指定<code>-drive file</code>到你自己rootfs的路徑</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>qemu-system-arm -M versatilepb -kernel /tmp/kernel/linux-stable/arch/arm/boot/zImage -drive <span class="nv">file</span><span class="o">=</span>output/images/rootfs.ext2,if<span class="o">=</span>scsi,format<span class="o">=</span>raw -append <span class="s2">&quot;root=/dev/sda console=ttyAMA0,115200&quot;</span> -serial stdio -net nic,model<span class="o">=</span>rtl8139 -net use
</span></code></pre></td></tr></table></div></figure>


<p>單純提出來一個參數表示這是我編譯出來的kernel而不是buildroot的</p>

<ul>
<li><code>-kernel /tmp/kernel/linux-stable/arch/arm/boot/zImage</code></li>
</ul>


<p>開機節錄畫面如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Uncompressing Linux... done, booting the kernel.
</span><span class='line'>Booting Linux on physical CPU 0x0
</span><span class='line'>Linux version 4.4.2 (user@host) (gcc version 4.8.5 (Buildroot 2016.11-git-00439-g14b2472) ) #2 Fri Sep 30 22:46:53 CST 2016
</span><span class='line'>CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
</span><span class='line'>CPU: VIVT data cache, VIVT instruction cache
</span><span class='line'>Machine: ARM-Versatile PB
</span><span class='line'>Memory policy: Data cache writeback
</span><span class='line'>sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns
</span><span class='line'>Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 32512
</span><span class='line'>Kernel command line: root=/dev/sda console=ttyAMA0,115200
</span><span class='line'>PID hash table entries: 512 (order: -1, 2048 bytes)
</span><span class='line'>Dentry cache hash table entries: 16384 (order: 4, 65536 bytes)
</span><span class='line'>Inode-cache hash table entries: 8192 (order: 3, 32768 bytes)
</span><span class='line'>Memory: 125956K/131072K available (2780K kernel code, 148K rwdata, 776K rodata, 128K init, 79K bss, 5116K reserved, 0K cma-reserved)
</span><span class='line'>Virtual kernel memory layout:
</span><span class='line'>    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
</span><span class='line'>    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
</span><span class='line'>    vmalloc : 0xc8800000 - 0xff800000   ( 880 MB)
</span><span class='line'>    lowmem  : 0xc0000000 - 0xc8000000   ( 128 MB)
</span><span class='line'>    modules : 0xbf000000 - 0xc0000000   (  16 MB)
</span><span class='line'>      .text : 0xc0008000 - 0xc038158c   (3558 kB)
</span><span class='line'>      .init : 0xc0382000 - 0xc03a2000   ( 128 kB)
</span><span class='line'>      .data : 0xc03a2000 - 0xc03c7300   ( 149 kB)
</span><span class='line'>       .bss : 0xc03c7300 - 0xc03daf2c   (  80 kB)
</span><span class='line'>NR_IRQS:224
</span><span class='line'>VIC @f1140000: id 0x00041190, vendor 0x41
</span><span class='line'>FPGA IRQ chip 0 &quot;SIC&quot; @ f1003000, 13 irqs, parent IRQ: 63
</span><span class='line'>clocksource: timer3: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275 ns
</span><span class='line'>Console: colour dummy device 80x30
</span><span class='line'>Calibrating delay loop... 641.43 BogoMIPS (lpj=3207168)
</span><span class='line'>pid_max: default: 32768 minimum: 301
</span><span class='line'>Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>CPU: Testing write buffer coherency: ok
</span><span class='line'>Setting up static identity map for 0x8400 - 0x8458
</span><span class='line'>devtmpfs: initialized
</span><span class='line'>VFP support v0.3: implementor 41 architecture 1 part 10 variant 9 rev 0
</span><span class='line'>clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
</span><span class='line'>NET: Registered protocol family 16
</span><span class='line'>DMA: preallocated 256 KiB pool for atomic coherent allocations
</span><span class='line'>Serial: AMBA PL011 UART driver
</span><span class='line'>dev:f1: ttyAMA0 at MMIO 0x101f1000 (irq = 44, base_baud = 0) is a PL011 rev1
</span><span class='line'>console [ttyAMA0] enabled
</span><span class='line'>dev:f2: ttyAMA1 at MMIO 0x101f2000 (irq = 45, base_baud = 0) is a PL011 rev1
</span><span class='line'>dev:f3: ttyAMA2 at MMIO 0x101f3000 (irq = 46, base_baud = 0) is a PL011 rev1
</span><span class='line'>fpga:09: ttyAMA3 at MMIO 0x10009000 (irq = 70, base_baud = 0) is a PL011 rev1
</span><span class='line'>PCI core found (slot 11)
</span><span class='line'>PCI host bridge to bus 0000:00
</span><span class='line'>pci_bus 0000:00: root bus resource [mem 0x50000000-0x5fffffff]
</span><span class='line'>pci_bus 0000:00: root bus resource [mem 0x60000000-0x6fffffff pref]
</span><span class='line'>pci_bus 0000:00: root bus resource [io  0x1000-0xffff]
</span><span class='line'>pci_bus 0000:00: No busn resource found for root bus, will use [bus 00-ff]
</span><span class='line'>PCI: bus0: Fast back to back transfers disabled
</span><span class='line'>pci 0000:00:0c.0: BAR 6: assigned [mem 0x60000000-0x6003ffff pref]
</span><span class='line'>pci 0000:00:0d.0: BAR 2: assigned [mem 0x50000000-0x50001fff]
</span><span class='line'>pci 0000:00:0d.0: BAR 1: assigned [mem 0x50002000-0x500023ff]
</span><span class='line'>pci 0000:00:0c.0: BAR 0: assigned [io  0x1000-0x10ff]
</span><span class='line'>pci 0000:00:0c.0: BAR 1: assigned [mem 0x50002400-0x500024ff]
</span><span class='line'>pci 0000:00:0d.0: BAR 0: assigned [io  0x1400-0x14ff]
</span><span class='line'>vgaarb: loaded
</span><span class='line'>SCSI subsystem initialized
</span><span class='line'>clocksource: Switched to clocksource timer3
</span><span class='line'>NET: Registered protocol family 2
</span><span class='line'>TCP established hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>TCP: Hash tables configured (established 1024 bind 1024)
</span><span class='line'>UDP hash table entries: 256 (order: 0, 4096 bytes)
</span><span class='line'>UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
</span><span class='line'>NET: Registered protocol family 1
</span><span class='line'>NetWinder Floating Point Emulator V0.97 (double precision)
</span><span class='line'>futex hash table entries: 256 (order: -1, 3072 bytes)
</span><span class='line'>Block layer SCSI generic (bsg) driver version 0.4 loaded (major 254)
</span><span class='line'>io scheduler noop registered
</span><span class='line'>io scheduler deadline registered
</span><span class='line'>io scheduler cfq registered (default)
</span><span class='line'>pl061_gpio dev:e4: PL061 GPIO chip @0x101e4000 registered
</span><span class='line'>pl061_gpio dev:e5: PL061 GPIO chip @0x101e5000 registered
</span><span class='line'>pl061_gpio dev:e6: PL061 GPIO chip @0x101e6000 registered
</span><span class='line'>pl061_gpio dev:e7: PL061 GPIO chip @0x101e7000 registered
</span><span class='line'>clcd-pl11x dev:20: PL110 rev0 at 0x10120000
</span><span class='line'>clcd-pl11x dev:20: Versatile hardware, VGA display
</span><span class='line'>Console: switching to colour frame buffer device 80x60
</span><span class='line'>sym53c8xx 0000:00:0d.0: enabling device (0100 -&gt; 0103)
</span><span class='line'>sym0: &lt;895a&gt; rev 0x0 at pci 0000:00:0d.0 irq 94
</span><span class='line'>sym0: No NVRAM, ID 7, Fast-40, LVD, parity checking
</span><span class='line'>sym0: SCSI BUS has been reset.
</span><span class='line'>scsi host0: sym-2.2.3
</span><span class='line'>sym0: unknown interrupt(s) ignored, ISTAT=0x5 DSTAT=0x80 SIST=0x0
</span><span class='line'>scsi 0:0:0:0: Direct-Access     QEMU     QEMU HARDDISK    2.0. PQ: 0 ANSI: 5
</span><span class='line'>scsi target0:0:0: tagged command queuing enabled, command queue depth 16.
</span><span class='line'>scsi target0:0:0: Beginning Domain Validation
</span><span class='line'>scsi target0:0:0: Domain Validation skipping write tests
</span><span class='line'>scsi target0:0:0: Ending Domain Validation
</span><span class='line'>scsi 0:0:2:0: CD-ROM            QEMU     QEMU CD-ROM      2.0. PQ: 0 ANSI: 5
</span><span class='line'>scsi target0:0:2: tagged command queuing enabled, command queue depth 16.
</span><span class='line'>scsi target0:0:2: Beginning Domain Validation
</span><span class='line'>scsi target0:0:2: Domain Validation skipping write tests
</span><span class='line'>scsi target0:0:2: Ending Domain Validation
</span><span class='line'>sd 0:0:0:0: Attached scsi generic sg0 type 0
</span><span class='line'>scsi 0:0:2:0: Attached scsi generic sg1 type 5
</span><span class='line'>8139cp: 8139cp: 10/100 PCI Ethernet driver v1.3 (Mar 22, 2004)
</span><span class='line'>8139cp 0000:00:0c.0: enabling device (0100 -&gt; 0103)
</span><span class='line'>8139cp 0000:00:0c.0 eth0: RTL-8139C+ at 0xc8974400, 52:54:00:12:34:56, IRQ 93
</span><span class='line'>sd 0:0:0:0: [sda] 12666 512-byte logical blocks: (6.48 MB/6.18 MiB)
</span><span class='line'>sd 0:0:0:0: [sda] Write Protect is off
</span><span class='line'>sd 0:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn&#39;t support DPO or FUA
</span><span class='line'>sd 0:0:0:0: [sda] Attached SCSI disk
</span><span class='line'>mousedev: PS/2 mouse device common for all mice
</span><span class='line'>NET: Registered protocol family 17
</span><span class='line'>input: AT Raw Set 2 keyboard as /devices/fpga:06/serio0/input/input0
</span><span class='line'>input: ImExPS/2 Generic Explorer Mouse as /devices/fpga:07/serio1/input/input2
</span><span class='line'>VFS: Mounted root (ext2 filesystem) readonly on device 8:0.
</span><span class='line'>devtmpfs: mounted
</span><span class='line'>Freeing unused kernel memory: 128K (c0382000 - c03a2000)
</span><span class='line'>EXT2-fs (sda): warning: mounting unchecked fs, running e2fsck is recommended
</span><span class='line'>Starting logging: OK
</span><span class='line'>Initializing random number generator... random: dd urandom read with 48 bits of entropy available
</span><span class='line'>done.
</span><span class='line'>Starting network: 8139cp 0000:00:0c.0 eth0: link up, 100Mbps, full-duplex, lpa 0x05E1
</span><span class='line'>udhcpc: started, v1.25.0
</span><span class='line'>udhcpc: sending discover
</span><span class='line'>udhcpc: sending select for 10.0.2.15
</span><span class='line'>udhcpc: lease of 10.0.2.15 obtained, lease time 86400
</span><span class='line'>deleting routers
</span><span class='line'>adding dns 10.0.2.3
</span><span class='line'>OK
</span><span class='line'>
</span><span class='line'>Welcome to Buildroot
</span><span class='line'>buildroot login: root
</span><span class='line'>#
</span><span class='line'>random: nonblocking pool is initialized
</span></code></pre></td></tr></table></div></figure>


<p><a name="lk0_1_del_ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="https://buildroot.org/downloads/manual/manual.html">Buildroot 官方手冊</a></li>
</ul>


<p><a name="lk0_1_del_app"></a></p>

<h2>附錄</h2>

<p><a name="lk0_1_del_app_brot"></a></p>

<h3>使用Buildroot 內建套件指定編譯Linux kernel 4.2.2</h3>

<p>當初會去做這個主要是因為開始編譯獨立的Linux kernel前要先驗證buildroot自己編的Linux 4.4.2是否可以用qemu開機。另外的好處的就是buildroot編譯出來的kernel config (在output/build/linux-4.4.2/.config) 可以和你自己的kernel config比對。</p>

<p>步驟如下</p>

<ol>
<li><a href="#lk0_1_del_app_brot_step1">找出buildroot 4.4.x的kernel config</a></li>
<li><a href="#lk0_1_del_app_brot_step2">更改buildroot config指定使用Linux 4.4.2</a></li>
<li><a href="#lk0_1_del_app_brot_step3">測試驗證</a></li>
</ol>


<p><a name="lk0_1_del_app_brot_step1"></a></p>

<h3>找出buildroot 4.4.x的kernel config</h3>

<p>前篇有<a href="blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu/#lk0_ins_set">提到</a><code>make qemu_arm_versatile_defconfig</code>這個指令和<code>buildroot/board/qemu/arm-versatile</code>這個目錄。我們進一步去看一下這個目錄</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ls -gG board/qemu/arm-versatile
</span><span class='line'>total 8
</span><span class='line'>-rw-rw-r-- <span class="m">1</span> <span class="m">890</span> Sep <span class="m">30</span> 21:32 linux-4.7.config
</span><span class='line'>-rw-rw-r-- <span class="m">1</span> <span class="m">404</span> Sep <span class="m">30</span> 21:32 readme.txt
</span></code></pre></td></tr></table></div></figure>


<p>直接破梗</p>

<ul>
<li>readme.txt 告訴你怎麼用qemu 開機</li>
<li>linux-4.7.config 是Linux kernel config</li>
</ul>


<p>所以我會去<code>git log .</code>，撈看看有沒有Linux kernel 4.4.x的資料。果然給我看到一個commit</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>commit 93c640f00537d40fd25280c4c2c60f3b30808256
</span><span class='line'>Author: Gustavo Zacarias &lt;gustavo@zacarias.com.ar&gt;
</span><span class='line'>Date:   Sun Feb 7 18:19:13 2016 -0300
</span><span class='line'>
</span><span class='line'>    configs/qemu: bump to the latest linux versions
</span><span class='line'>...
</span><span class='line'>    arm_versatile           4.4.1           2.3.0   YES     OK
</span></code></pre></td></tr></table></div></figure>


<p>剩下就是使用git切到該commit，撈出資料，另存新檔。我把他存在
<code>/tmp/linux-4.4.config</code></p>

<p><a name="lk0_1_del_app_brot_step2"></a></p>

<h3>更改buildroot config指定使用Linux 4.4.2</h3>

<ul>
<li>make menuconfig

<ul>
<li>Kernel -> Kernel version -> Custom version</li>
<li>Kernel -> Kernel version: 填 4.4.2</li>
<li>Kernel -> Kernel configuration -> Using a custom (def)config file</li>
<li>Kernel -> Configuration file path: 填<code>/tmp/linux-4.4.config</code></li>
</ul>
</li>
<li>make</li>
</ul>


<p><a name="lk0_1_del_app_brot_step3"></a></p>

<h3>測試驗證</h3>

<p>根據buildroot/board/qemu/arm-versatile中4.4.2版時的readme.txt，qemu指令執行如下，基本上就是不去載入device tree檔案。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>qemu-system-arm -M versatilepb -kernel output/images/zImage -drive <span class="nv">file</span><span class="o">=</span>output/images/rootfs.ext2,if<span class="o">=</span>scsi,format<span class="o">=</span>raw -append <span class="s2">&quot;root=/dev/sda console=ttyAMA0,115200&quot;</span> -serial stdio -net nic,model<span class="o">=</span>rtl8139 -net user
</span></code></pre></td></tr></table></div></figure>


<p>以下是開機畫面</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Uncompressing Linux... done, booting the kernel.
</span><span class='line'>Booting Linux on physical CPU 0x0
</span><span class='line'>Linux version 4.4.2 (user@host) (gcc version 4.8.5 (Buildroot 2016.11-git-00439-g14b2472) ) #1 Fri Sep 30 22:36:58 CST 2016
</span><span class='line'>CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
</span><span class='line'>CPU: VIVT data cache, VIVT instruction cache
</span><span class='line'>Machine: ARM-Versatile PB
</span><span class='line'>Memory policy: Data cache writeback
</span><span class='line'>sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns
</span><span class='line'>Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 32512
</span><span class='line'>Kernel command line: root=/dev/sda console=ttyAMA0,115200
</span><span class='line'>PID hash table entries: 512 (order: -1, 2048 bytes)
</span><span class='line'>Dentry cache hash table entries: 16384 (order: 4, 65536 bytes)
</span><span class='line'>Inode-cache hash table entries: 8192 (order: 3, 32768 bytes)
</span><span class='line'>Memory: 125264K/131072K available (3246K kernel code, 158K rwdata, 880K rodata, 120K init, 198K bss, 5808K reserved, 0K cma-reserved)
</span><span class='line'>Virtual kernel memory layout:
</span><span class='line'>    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
</span><span class='line'>    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
</span><span class='line'>    vmalloc : 0xc8800000 - 0xff800000   ( 880 MB)
</span><span class='line'>    lowmem  : 0xc0000000 - 0xc8000000   ( 128 MB)
</span><span class='line'>    modules : 0xbf000000 - 0xc0000000   (  16 MB)
</span><span class='line'>      .text : 0xc0008000 - 0xc040fdcc   (4128 kB)
</span><span class='line'>      .init : 0xc0410000 - 0xc042e000   ( 120 kB)
</span><span class='line'>      .data : 0xc042e000 - 0xc04559e0   ( 159 kB)
</span><span class='line'>       .bss : 0xc04559e0 - 0xc04873a8   ( 199 kB)
</span><span class='line'>SLUB: HWalign=32, Order=0-3, MinObjects=0, CPUs=1, Nodes=1
</span><span class='line'>NR_IRQS:224
</span><span class='line'>VIC @f1140000: id 0x00041190, vendor 0x41
</span><span class='line'>FPGA IRQ chip 0 &quot;SIC&quot; @ f1003000, 13 irqs, parent IRQ: 63
</span><span class='line'>clocksource: timer3: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275 ns
</span><span class='line'>Console: colour dummy device 80x30
</span><span class='line'>Calibrating delay loop... 637.74 BogoMIPS (lpj=3188736)
</span><span class='line'>pid_max: default: 32768 minimum: 301
</span><span class='line'>Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>CPU: Testing write buffer coherency: ok
</span><span class='line'>Setting up static identity map for 0x8400 - 0x8458
</span><span class='line'>devtmpfs: initialized
</span><span class='line'>clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
</span><span class='line'>NET: Registered protocol family 16
</span><span class='line'>DMA: preallocated 256 KiB pool for atomic coherent allocations
</span><span class='line'>Serial: AMBA PL011 UART driver
</span><span class='line'>dev:f1: ttyAMA0 at MMIO 0x101f1000 (irq = 44, base_baud = 0) is a PL011 rev1
</span><span class='line'>console [ttyAMA0] enabled
</span><span class='line'>dev:f2: ttyAMA1 at MMIO 0x101f2000 (irq = 45, base_baud = 0) is a PL011 rev1
</span><span class='line'>dev:f3: ttyAMA2 at MMIO 0x101f3000 (irq = 46, base_baud = 0) is a PL011 rev1
</span><span class='line'>fpga:09: ttyAMA3 at MMIO 0x10009000 (irq = 70, base_baud = 0) is a PL011 rev1
</span><span class='line'>PCI core found (slot 11)
</span><span class='line'>PCI host bridge to bus 0000:00
</span><span class='line'>pci_bus 0000:00: root bus resource [mem 0x50000000-0x5fffffff]
</span><span class='line'>pci_bus 0000:00: root bus resource [mem 0x60000000-0x6fffffff pref]
</span><span class='line'>pci_bus 0000:00: root bus resource [io  0x1000-0xffff]
</span><span class='line'>pci_bus 0000:00: No busn resource found for root bus, will use [bus 00-ff]
</span><span class='line'>PCI: bus0: Fast back to back transfers disabled
</span><span class='line'>pci 0000:00:0c.0: BAR 6: assigned [mem 0x60000000-0x6003ffff pref]
</span><span class='line'>pci 0000:00:0d.0: BAR 2: assigned [mem 0x50000000-0x50001fff]
</span><span class='line'>pci 0000:00:0d.0: BAR 1: assigned [mem 0x50002000-0x500023ff]
</span><span class='line'>pci 0000:00:0c.0: BAR 0: assigned [io  0x1000-0x10ff]
</span><span class='line'>pci 0000:00:0c.0: BAR 1: assigned [mem 0x50002400-0x500024ff]
</span><span class='line'>pci 0000:00:0d.0: BAR 0: assigned [io  0x1400-0x14ff]
</span><span class='line'>vgaarb: loaded
</span><span class='line'>SCSI subsystem initialized
</span><span class='line'>clocksource: Switched to clocksource timer3
</span><span class='line'>NET: Registered protocol family 2
</span><span class='line'>TCP established hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
</span><span class='line'>TCP: Hash tables configured (established 1024 bind 1024)
</span><span class='line'>UDP hash table entries: 256 (order: 0, 4096 bytes)
</span><span class='line'>UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
</span><span class='line'>NET: Registered protocol family 1
</span><span class='line'>futex hash table entries: 256 (order: -1, 3072 bytes)
</span><span class='line'>Block layer SCSI generic (bsg) driver version 0.4 loaded (major 254)
</span><span class='line'>io scheduler noop registered
</span><span class='line'>io scheduler deadline registered
</span><span class='line'>io scheduler cfq registered (default)
</span><span class='line'>clcd-pl11x dev:20: PL110 rev0 at 0x10120000
</span><span class='line'>clcd-pl11x dev:20: Versatile hardware, VGA display
</span><span class='line'>Console: switching to colour frame buffer device 80x30
</span><span class='line'>sym53c8xx 0000:00:0d.0: enabling device (0100 -&gt; 0103)
</span><span class='line'>sym0: &lt;895a&gt; rev 0x0 at pci 0000:00:0d.0 irq 94
</span><span class='line'>sym0: No NVRAM, ID 7, Fast-40, LVD, parity checking
</span><span class='line'>sym0: SCSI BUS has been reset.
</span><span class='line'>scsi host0: sym-2.2.3
</span><span class='line'>sym0: unknown interrupt(s) ignored, ISTAT=0x5 DSTAT=0x80 SIST=0x0
</span><span class='line'>scsi 0:0:0:0: Direct-Access     QEMU     QEMU HARDDISK    2.0. PQ: 0 ANSI: 5
</span><span class='line'>scsi target0:0:0: tagged command queuing enabled, command queue depth 16.
</span><span class='line'>scsi target0:0:0: Beginning Domain Validation
</span><span class='line'>scsi target0:0:0: Domain Validation skipping write tests
</span><span class='line'>scsi target0:0:0: Ending Domain Validation
</span><span class='line'>scsi 0:0:2:0: CD-ROM            QEMU     QEMU CD-ROM      2.0. PQ: 0 ANSI: 5
</span><span class='line'>scsi target0:0:2: tagged command queuing enabled, command queue depth 16.
</span><span class='line'>scsi target0:0:2: Beginning Domain Validation
</span><span class='line'>scsi target0:0:2: Domain Validation skipping write tests
</span><span class='line'>scsi target0:0:2: Ending Domain Validation
</span><span class='line'>8139cp: 8139cp: 10/100 PCI Ethernet driver v1.3 (Mar 22, 2004)
</span><span class='line'>8139cp 0000:00:0c.0: enabling device (0100 -&gt; 0103)
</span><span class='line'>8139cp 0000:00:0c.0 eth0: RTL-8139C+ at 0xc8978400, 52:54:00:12:34:56, IRQ 93
</span><span class='line'>sd 0:0:0:0: [sda] 12666 512-byte logical blocks: (6.48 MB/6.18 MiB)
</span><span class='line'>sd 0:0:0:0: [sda] Write Protect is off
</span><span class='line'>sd 0:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn&#39;t support DPO or FUA
</span><span class='line'>mousedev: PS/2 mouse device common for all mice
</span><span class='line'>sd 0:0:0:0: [sda] Attached SCSI disk
</span><span class='line'>NET: Registered protocol family 10
</span><span class='line'>sit: IPv6 over IPv4 tunneling driver
</span><span class='line'>NET: Registered protocol family 17
</span><span class='line'>input: AT Raw Set 2 keyboard as /devices/fpga:06/serio0/input/input0
</span><span class='line'>input: ImExPS/2 Generic Explorer Mouse as /devices/fpga:07/serio1/input/input2
</span><span class='line'>EXT4-fs (sda): couldn&#39;t mount as ext3 due to feature incompatibilities
</span><span class='line'>EXT4-fs (sda): mounting ext2 file system using the ext4 subsystem
</span><span class='line'>EXT4-fs (sda): mounted filesystem without journal. Opts: (null)
</span><span class='line'>VFS: Mounted root (ext2 filesystem) readonly on device 8:0.
</span><span class='line'>devtmpfs: mounted
</span><span class='line'>Freeing unused kernel memory: 120K (c0410000 - c042e000)
</span><span class='line'>EXT4-fs (sda): warning: mounting unchecked fs, running e2fsck is recommended
</span><span class='line'>EXT4-fs warning (device sda): ext4_update_dynamic_rev:717: updating to rev 1 because of new feature flag, running e2fsck is recommended
</span><span class='line'>EXT4-fs (sda): re-mounted. Opts: block_validity,barrier,user_xattr,errors=remount-ro
</span><span class='line'>Starting logging: OK
</span><span class='line'>Initializing random number generator... random: dd urandom read with 43 bits of entropy available
</span><span class='line'>done.
</span><span class='line'>Starting network: 8139cp 0000:00:0c.0 eth0: link up, 100Mbps, full-duplex, lpa 0x05E1
</span><span class='line'>udhcpc: started, v1.25.0
</span><span class='line'>udhcpc: sending discover
</span><span class='line'>udhcpc: sending select for 10.0.2.15
</span><span class='line'>udhcpc: lease of 10.0.2.15 obtained, lease time 86400
</span><span class='line'>deleting routers
</span><span class='line'>adding dns 10.0.2.3
</span><span class='line'>OK
</span><span class='line'>
</span><span class='line'>Welcome to Buildroot
</span><span class='line'>buildroot login: root
</span><span class='line'>#
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu/">(過期) Linux Kernel Pratice 0: Buildroot (1/2)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-27T09:43:20+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:43 am</span></time>
        
           | <a href="/blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3><font color="red">感謝Scott 大大糾正，選錯平台，這篇使用了ARMv4指令集的測試平台。請大家忽略，正確的版本將會之後更新!</font></h3>

<p>理論上不應該要邊移動邊開火，延長戰線。不過計劃趕不上變化，既來之則安之。</p>

<p>最近因為特別因素開始學習Linux kernel，看能不能Linux kernel和STM32兩邊都不要漏掉。不管怎樣，學習和實習絕對分不開，所以還是從環境架設開始吧。這次的實習環境架設的目標是：</p>

<ol>
<li>可以使用ARM 平台。一方面追求流行，一方面我不想再開x86這個副本</li>
<li>可以方便地建立ARM平台的Linux Rootfs和kernel版本</li>
<li>可以方便地更改指定要編譯的Kernel版本</li>
<li>透過Qemu ，使用2的Rootfs和kernel開機</li>
<li>透過Qemu和搭配的工具可以分析Linux kernel的run time 行為</li>
</ol>


<p>今天只有辦到1, 2和4而已，剩下的還要繼續努力。</p>

<h2>目錄</h2>

<ul>
<li><a href="#de_lk0_env">測試環境</a></li>
<li><a href="#de_lk0_ins">安裝Buildroot</a>

<ul>
<li><a href="#de_lk0_ins_dl">下載Buildroot</a></li>
<li><a href="#de_lk0_ins_set">設定ARM 環境</a></li>
<li><a href="#de_lk0_ins_build">編譯及輸出</a></li>
</ul>
</li>
<li><a href="#de_lk0_test">測試</a></li>
<li><a href="#de_lk0_ref">參考資料</a>

<ul>
<li><a href="#de_lk0_ref_data">下次準備看的資料</a></li>
</ul>
</li>
</ul>


<p><a name="de_lk0_env"></a></p>

<h2>測試環境</h2>

<p>因為我已經裝過開發相關的套件，因此如果您是新手可能要自行摸索也許有需要另外安裝的套件如<code>git</code>。嘛，練習解讀錯誤訊息也是一種學習。</p>

<pre>
$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 14.04.5 LTS
Release:    14.04
Codename:   trusty
</pre>


<p><a name="de_lk0_ins"></a></p>

<h2>安裝Buildroot</h2>

<p>主要分成下面三個步驟</p>

<ul>
<li><a href="#de_lk0_ins_dl">下載Buildroot</a></li>
<li><a href="#de_lk0_ins_set">設定ARM 環境</a></li>
<li><a href="#de_lk0_ins_build">編譯及輸出</a></li>
</ul>


<p><a name="de_lk0_ins_dl"></a></p>

<h3>下載Buildroot</h3>

<p>直接看例子，剪下貼上就好</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mkdir buildroot
</span><span class='line'><span class="nb">cd </span>buildroot
</span><span class='line'>git clone git://git.buildroot.net/buildroot
</span></code></pre></td></tr></table></div></figure>


<p><a name="de_lk0_ins_set"></a></p>

<h3>設定ARM 環境</h3>

<p>網路上查到大部分都是從<code>make menuconfig</code>開始。不過我是很<strong>明確地</strong>要用<code>Qemu</code>跑ARM的系統。所以就找了一下發現有下面的指令</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>make qemu_x86_defconfig
</span></code></pre></td></tr></table></div></figure>


<p>想說既然有<code>x86_defconfig</code>，那應該有<code>arm_defconfig</code>吧? 錯！那我就去<code>buildroot/board/qemu</code>目錄下找，有看到<code>arm-versatile</code>。印象中<a href="blog/2015/02/07/by-qemu-arm-installation-of-debian-systems/">以前</a>有用過Qemu跑的Debian系統也是<code>versatile</code>。所以就很高興地下了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>make qemu_arm-versatile_defconfig
</span></code></pre></td></tr></table></div></figure>


<p>結果一樣GG，估狗查才知道正確的用法是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>make qemu_arm_versatile_defconfig
</span></code></pre></td></tr></table></div></figure>


<p><strong>更新:</strong> 後來看手冊才知道有<code>make list-defconfigs</code>可以查詢有哪些default config，果然前輩說要RTFM是對的，唉。</p>

<p>接下來就用<code>make menuconfig</code>做細項調整，我主要是改成</p>

<ol>
<li>使用glibc</li>
<li>使用gcc 4.8

<ul>
<li>預設5.x，因為我想要編Linux kernel 4.4.2。以前PC經驗使用gcc 5.x極端痛苦，後來還是換回gcc 4.8</li>
</ul>
</li>
<li>一些除錯設定</li>
</ol>


<p>另外本來想要嘗試設定更動Kernel版本，但是發現需要更進一步的了解buildroot才能夠達成。當作下次目標吧。</p>

<p><a name="de_lk0_ins_build"></a></p>

<h3>編譯及輸出</h3>

<p>編譯只要下<code>make</code>就會幫你下載和編譯開機需要的</p>

<ol>
<li>套件和一些常用工具，並封裝到<code>output/image/roofs.ext2</code></li>
<li>Kernel(預設4.7)，編譯成<code>zImage</code>，放在<code>output/image/zImage</code></li>
</ol>


<p><a name="de_lk0_test"></a></p>

<h2>測試</h2>

<p>接下來也不難，可以參考<code>board/qemu/arm-versatile/readme.txt</code>
簡單來說就是執行下面指令，開機完使用<code>root</code>登入不用密碼，使用<code>poweroff</code>後再手動離開qemu。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>qemu-system-arm -M versatilepb -kernel output/images/zImage -dtb output/images/versatile-pb.dtb -drive <span class="nv">file</span><span class="o">=</span>output/images/rootfs.ext2,if<span class="o">=</span>scsi,format<span class="o">=</span>raw -append <span class="s2">&quot;root=/dev/sda console=ttyAMA0,115200&quot;</span> -serial stdio -net nic,model<span class="o">=</span>rtl8139 -net user
</span></code></pre></td></tr></table></div></figure>


<p>執行畫面如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ qemu-system-arm -M versatilepb -kernel output/images/zImage -dtb output/images/versatile-pb.dtb -drive file=output/images/rootfs.ext2,if=scsi,format=raw -append &quot;root=/dev/sda console=ttyAMA0,115200&quot; -serial stdio -net nic,model=rtl8139 -net user
</span><span class='line'>...
</span><span class='line'>Booting Linux on physical CPU 0x0
</span><span class='line'>Linux version 4.7.0 (user@host) (gcc version 4.8.5 (Buildroot 2016.11-git-00439-g14b2472) ) #1 Mon Sep 26 22:36:42 CST 2016
</span><span class='line'>CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
</span><span class='line'>CPU: VIVT data cache, VIVT instruction cache
</span><span class='line'>Machine model: ARM Versatile PB
</span><span class='line'>....
</span><span class='line'>EXT4-fs (sda): re-mounted. Opts: block_validity,barrier,user_xattr,errors=remount-ro
</span><span class='line'>Starting logging: OK
</span><span class='line'>Initializing random number generator... random: dd urandom read with 46 bits of entropy available
</span><span class='line'>done.
</span><span class='line'>Starting network: 8139cp 0000:00:0c.0 eth0: link up, 100Mbps, full-duplex, lpa 0x05E1
</span><span class='line'>...
</span><span class='line'>adding dns 10.0.2.3
</span><span class='line'>OK
</span><span class='line'>
</span><span class='line'>Welcome to Buildroot
</span><span class='line'>buildroot login: root
</span><span class='line'>#
</span></code></pre></td></tr></table></div></figure>


<p><a name="de_lk0_ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="https://buildroot.org/downloads/manual/manual.html">The Buildroot user manual</a>

<ul>
<li>只有看部份，不過官方文件本來就是應該放在第一位</li>
</ul>
</li>
<li><a href="http://pressreset.net/2013/09/buildroot-and-qemu-the-quickest-receipe-for-your-own-linux/">Buildroot and QEMU – the quickest receipe for your own Linux</a>

<ul>
<li>東西弄完才看到的文章，入門好文</li>
</ul>
</li>
</ul>


<p><a name="de_lk0_ref_data"></a></p>

<h3>下次準備看的資料</h3>

<ul>
<li><a href="http://www.linux-magazine.com/Online/Features/Qemu-and-the-Kernel">Qemu and the Kernel</a>

<ul>
<li>使用Qemu debug kernel的資料</li>
</ul>
</li>
<li><a href="http://unix.stackexchange.com/questions/90423/can-virtfs-9p-be-used-as-root-file-system">Stackoverflow: Can virtfs/9p be used as root file system?</a>

<ul>
<li>Qemu和Host主機共享資料，甚至直接把rootfs放host讓qemu去讀取的方式</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/10/arm-cm4-pratice-4-semihosting/">ARM CM4 Pratice (4): Semihosting</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-10T12:51:46+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:51 pm</span></time>
        
           | <a href="/blog/2016/08/10/arm-cm4-pratice-4-semihosting/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/08/10/arm-cm4-pratice-4-semihosting/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Semihosting 是一種讓開發版透過除錯介面執行主機上的服務。透過semihosting，使用者可以快速驗證功能。舉例來說，在USART還沒搞定前先把訊息透過semihosting印到主機上觀看程式的行為。</p>

<p>本次練習使用<code>openocd</code>提供主機上的服務。以下是這次的練習</p>

<h2>目錄</h2>

<ul>
<li><a href="#stm-4-env">測試環境</a></li>
<li><a href="#stm-4-semi">使用Semihosting</a>

<ul>
<li><a href="#stm-4-semi-target">開發版</a></li>
<li><a href="#stm-4-semi-host">主機 (openocd)</a></li>
</ul>
</li>
<li><a href="#stm-4-test">實驗：Echo</a>

<ul>
<li><a href="#stm-4-test-code">程式</a>

<ul>
<li><a href="#stm-4-test-code-main">主程式</a></li>
<li><a href="#stm-4-test-code-semi">Semihosting 程式</a></li>
</ul>
</li>
<li><a href="#stm-4-test-makefile">Makefile</a></li>
<li><a href="#stm-4-test-result">執行結果</a></li>
</ul>
</li>
<li><a href="#stm-4-ref">參考資料</a></li>
</ul>


<p><a name="stm-4-env"></a></p>

<h2>測試環境</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.4 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span><span class='line'>
</span><span class='line'>$ arm-none-eabi-gcc --version
</span><span class='line'>arm-none-eabi-gcc (GNU Tools for ARM Embedded Processors) 5.4.1 20160609 (release) [ARM/embedded-5-branch revision 237715]
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$ openocd --version
</span><span class='line'>Open On-Chip Debugger 0.10.0-dev-00250-g9c37747 (2016-04-07-22:20)
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p></p>

<ul>
<li>SPL版本： STM32F4xx_DSP_StdPeriph_Lib_V1.6.1</li>
<li>開發板： STM32F4 Dicovery, <a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">STM32F429-Disco</a></li>
</ul>


<p><a name="stm-4-semi"></a></p>

<h2>使用Semihosting</h2>

<p><a name="stm-4-semi-target"></a></p>

<h3>開發版</h3>

<p>ARM官方網站有說，在ARMv6-M 和 ARMv7-M (Cortex M4是ARMv7E-M)架構中，使用break point指令並帶入參數<code>0xab</code>即可。詳細的使用範例會在<a href="#stm-4-test">後面</a>說明。</p>

<p>以下是ARM規範的Semihosting服務</p>

<ul>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/BEIDFAEH.html">angel_SWIreason_EnterSVC (0x17)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/BEIGEDFE.html">angel_SWIreason_ReportException (0x18)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Baccdcef.html">SYS_CLOSE (0x02)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdcfje.html">SYS_CLOCK (0x10)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdgdcc.html">SYS_ELAPSED (0x30)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdhfgc.html">SYS_ERRNO (0x13)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdgdic.html">SYS_FLEN (0x0C)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Baccbcbe.html">SYS_GET_CMDLINE (0x15)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacbefaa.html">SYS_HEAPINFO (0x16)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Baccjafh.html">SYS_ISERROR (0x08)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacbhcee.html">SYS_ISTTY (0x09)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdagge.html">SYS_OPEN (0x01)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Baceahbd.html">SYS_READ (0x06)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Baccbaba.html">SYS_READC (0x07)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacbffjf.html">SYS_REMOVE (0x0E)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdjebc.html">SYS_RENAME (0x0F)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdfgcg.html">SYS_SEEK (0x0A)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdijcb.html">SYS_SYSTEM (0x12)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacchdbe.html">SYS_TICKFREQ (0x31)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacebdhg.html">SYS_TIME (0x11)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Baccafja.html">SYS_TMPNAM (0x0D)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacbedji.html">SYS_WRITE (0x05)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacbejbe.html">SYS_WRITEC (0x03)</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/Bacdhdcd.html">SYS_WRITE0 (0x04)</a></li>
</ul>


<p><a name="stm-4-semi-host"></a></p>

<h3>主機 (openocd)</h3>

<p>其實非常簡單，就是啟動openocd的時候要把semihosting打開。單獨指令如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>arm semihosting enable
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-4-test"></a></p>

<h2>實驗：Echo</h2>

<p>完整可以編譯的程式碼在<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice/tree/master/labs/2_semihosting">這邊</a></p>

<p>這個實驗行為和<a href="http://wen00072.github.io/blog/2016/08/05/arm-cm4-pratice-3-lab-usart/">前一個實驗</a>很類似，就是透過semihosting的read服務主機端輸入資料，然後再透過semihosting的write服務印到螢幕上。</p>

<p><a name="stm-4-test-code"></a></p>

<h3>程式</h3>

<p><a name="stm-4-test-code-main"></a></p>

<h4>主程式</h4>

<p>非常簡單，唯一要說明的是在微處理器中，所有的東西都要自己來，也就是說下面的<code>memset</code>、<code>strlen</code>都是自己寫的。</p>

<figure class='code'><figcaption><span>semihosting.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &quot;my_utils.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define GREETING_STR  &quot;Hello World\n\r&quot;</span>
</span><span class='line'><span class="cp">#define PROMPT_STR    &quot;\r&gt; &quot;</span>
</span><span class='line'><span class="cp">#define LINE_MAX_CHAR (64)</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="n">LINE_MAX_CHAR</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Greeting */</span>
</span><span class='line'>    <span class="n">host_write</span><span class="p">(</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">GREETING_STR</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">GREETING_STR</span><span class="p">));</span>
</span><span class='line'>    <span class="n">host_write</span><span class="p">(</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">PROMPT_STR</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PROMPT_STR</span><span class="p">));</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">LINE_MAX_CHAR</span><span class="p">);</span>
</span><span class='line'>        <span class="n">host_read</span><span class="p">(</span><span class="n">STDIN</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">LINE_MAX_CHAR</span><span class="p">);</span>
</span><span class='line'>        <span class="n">host_write</span><span class="p">(</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Show prompt */</span>
</span><span class='line'>        <span class="n">host_write</span><span class="p">(</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">PROMPT_STR</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PROMPT_STR</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-4-test-code-semi"></a></p>

<h4>semihosting 程式</h4>

<p>首先我們從手冊中知道read/write的semihosting對應代號，<font color="red">用hardcode是不道德的</font>，所以我們使用有意義的文字代替。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">enum</span> <span class="n">HOST_SYSCALL</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">HOSTCALL_WRITE</span>       <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
</span><span class='line'>    <span class="n">HOSTCALL_READ</span>        <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下來我們發現read/write參數的型態有整數(file descriptor)
和位址這兩種，而手冊中說明參數傳遞的方式是將參數全部放在一個連續的記憶體空間，再將該記憶體空間位址存放在<code>R1</code>暫存器中。也就是說我們需要</p>

<ol>
<li>連續的空間</li>
<li>空間中的參數可能有多個，而且它們的型態可能都不同</li>
</ol>


<p>要達到這樣的方式，以前上課看來的方式就是做一個<code>union</code>。每次使用時建立陣列、指令參數型態和值，接下來把該陣列的位址傳給semihosting就可以了。</p>

<p>以下是這次用的<code>union</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Semihost system call parameters */</span>
</span><span class='line'><span class="k">union</span> <span class="kt">param_t</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span>   <span class="n">pdInt</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">pdPtr</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">union</span> <span class="kt">param_t</span> <span class="n">param</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下來是實際的呼叫semihosting服務。就是前面提到下break point指令。你可能會問這邊怎麼沒有參數傳遞？傻孩子，這就是ABI存在的目的了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">host_call</span><span class="p">(</span><span class="k">enum</span> <span class="n">HOST_SYSCALL</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="kr">naked</span><span class="p">));</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">host_call</span><span class="p">(</span><span class="k">enum</span> <span class="n">HOST_SYSCALL</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="n">__asm__</span><span class="p">(</span> \
</span><span class='line'>      <span class="s">&quot;bkpt 0xAB</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>      <span class="s">&quot;nop</span><span class="se">\n</span><span class="s">&quot;</span> \
</span><span class='line'>      <span class="s">&quot;bx lr</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>        <span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">::</span>\
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>剩下就簡單了，設定好參數呼叫semihosting的介面收工。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">size_t</span> <span class="nf">host_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">param</span> <span class="n">semi_param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">{</span> <span class="p">.</span><span class="n">pdInt</span> <span class="o">=</span> <span class="n">fd</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="p">.</span><span class="n">pdPtr</span> <span class="o">=</span> <span class="n">buf</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="p">.</span><span class="n">pdInt</span> <span class="o">=</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">host_call</span><span class="p">(</span><span class="n">HOSTCALL_READ</span><span class="p">,</span> <span class="n">semi_param</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">size_t</span> <span class="nf">host_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">param</span> <span class="n">semi_param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">{</span> <span class="p">.</span><span class="n">pdInt</span> <span class="o">=</span> <span class="n">fd</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="p">.</span><span class="n">pdPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="p">.</span><span class="n">pdInt</span> <span class="o">=</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">host_call</span><span class="p">(</span><span class="n">HOSTCALL_WRITE</span><span class="p">,</span> <span class="n">semi_param</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-4-test-makefile"></a></p>

<h3>Makefile</h3>

<p>最主要的是要透過openocd提供semihosting服務。如果想要在gdb測試時打開可以參考<a href="http://electronics.stackexchange.com/questions/149387/how-do-i-print-debug-messages-to-gdb-console-with-stm32-discovery-board-using-gd">這邊</a>的資料。</p>

<p>Makefile相關描述如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nf">run</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OUT_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">TARGET</span><span class="k">)</span>.<span class="n">bin</span>
</span><span class='line'>  openocd -f interface/stlink-v2.cfg  <span class="se">\</span>
</span><span class='line'>            -f target/stm32f4x.cfg      <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;init&quot;</span>                   <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;reset init&quot;</span>             <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;arm semihosting enable&quot;</span> <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;reset run&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-4-test-result"></a></p>

<h3>執行結果</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ make run
</span><span class='line'>openocd -f interface/stlink-v2.cfg  \
</span><span class='line'>            -f target/stm32f4x.cfg      \
</span><span class='line'>            -c &quot;init&quot;                   \
</span><span class='line'>            -c &quot;reset init&quot;             \
</span><span class='line'>            -c &quot;arm semihosting enable&quot; \
</span><span class='line'>            -c &quot;reset run&quot;
</span><span class='line'>Open On-Chip Debugger 0.10.0-dev-00250-g9c37747 (2016-04-07-22:20)
</span><span class='line'>Licensed under GNU GPL v2
</span><span class='line'>For bug reports, read
</span><span class='line'>  http://openocd.org/doc/doxygen/bugs.html
</span><span class='line'>Info : auto-selecting first available session transport &quot;hla_swd&quot;. To override use &#39;transport select &lt;transport&gt;&#39;.
</span><span class='line'>Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
</span><span class='line'>adapter speed: 2000 kHz
</span><span class='line'>adapter_nsrst_delay: 100
</span><span class='line'>none separate
</span><span class='line'>Info : Unable to match requested speed 2000 kHz, using 1800 kHz
</span><span class='line'>Info : Unable to match requested speed 2000 kHz, using 1800 kHz
</span><span class='line'>Info : clock speed 1800 kHz
</span><span class='line'>Info : STLINK v2 JTAG v17 API v2 SWIM v0 VID 0x0483 PID 0x3748
</span><span class='line'>Info : using stlink api v2
</span><span class='line'>Info : Target voltage: 2.883392
</span><span class='line'>Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints
</span><span class='line'>adapter speed: 2000 kHz
</span><span class='line'>stm32f4x.cpu: target state: halted
</span><span class='line'>target halted due to debug-request, current mode: Thread
</span><span class='line'>xPSR: 0x01000000 pc: 0x080005c4 msp: 0x20030000
</span><span class='line'>adapter speed: 8000 kHz
</span><span class='line'>semihosting is enabled
</span><span class='line'>adapter speed: 2000 kHz
</span><span class='line'>Hello World
</span><span class='line'>&gt; My test
</span><span class='line'>My test
</span><span class='line'>&gt; !!!!
</span><span class='line'>!!!!
</span><span class='line'>&gt;
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-4-ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0471g/CHDJHHDI.html">ARM Compiler toolchain Developing Software for ARM Processors: Semihosting</a></li>
<li><a href="http://openocd.org/doc/html/Architecture-and-Core-Commands.html">OpenOCD User&rsquo;s Guide: Architecture and Core Commands</a></li>
<li><a href="http://bgamari.github.io/posts/2014-10-31-semihosting.html">Semihosting on ARM with GCC and OpenOCD</a>

<ul>
<li>這個很有趣，可以用Semihosting直接使用glibc的stdio，不過做實驗就是要吃原味，要又痛又爽才是最高境界，所以這個我就沒去嘗試了</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/05/arm-cm4-pratice-3-lab-usart/">ARM CM4 Pratice (3): USART 初探</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-05T15:53:47+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>3:53 pm</span></time>
        
           | <a href="/blog/2016/08/05/arm-cm4-pratice-3-lab-usart/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/08/05/arm-cm4-pratice-3-lab-usart/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>致謝</h2>

<p>感謝網友<a href="https://github.com/starnight">Zack</a>，<a href="http://vh21.github.io/">Villar</a>，學弟Joe Ho，還有其他大大的幫忙，不然這次應該是撞牆撞到死吧。</p>

<h2>前言</h2>

<p>這次實驗有卡關，不然其實不算難。卡關的點如下：</p>

<ul>
<li>一開始使用USART1，可是USART1接到STLink 接腳，最後用USART6代替。(<a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">STM32F4 Discovry Disco 開發版手冊</a>，p19, SB11那段)</li>
<li>SPL的HSE 設定和版子不合，造成Baud rate計算錯誤。</li>
</ul>


<p>這次的實驗是一個ECHO程式，透過版子上的USART6和電腦連線，電腦送出什麼字元，版子就傳回什麼字元。</p>

<h2>目錄</h2>

<ul>
<li><a href="#stm-3-prepare">事前準備</a></li>
<li><a href="#stm-3-env">測試環境</a></li>
<li><a href="#stm-3-usart">USART 控制</a></li>
<li><a href="#stm-3-code">程式碼</a>

<ul>
<li><a href="#stm-3-code-code">完整程式碼</a></li>
<li><a href="#stm-3-code-make">Makefile</a></li>
</ul>
</li>
<li><a href="#stm-3-test">功能驗證</a></li>
<li><a href="#stm-3-ref">參考資料</a></li>
</ul>


<p><a name="stm-3-prepare"></a></p>

<h2>事前準備</h2>

<ul>
<li><p>Saleae 邏輯分析儀 (一千新台幣有找）</p>

<ul>
<li>需要自行到Saleae官方網站下載安裝Linux版軟體
<img src="/files/stm32/STM_LG.jpg"/></li>
</ul>
</li>
<li><p>USB 轉 RS232 TTL 轉接線
<img src="/files/banana_pi/DSC_0026.jpg"/></p></li>
</ul>


<p><a name="stm-3-env"></a></p>

<h2>測試環境</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.4 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span><span class='line'>
</span><span class='line'>$ arm-none-eabi-gcc --version
</span><span class='line'>arm-none-eabi-gcc (GNU Tools for ARM Embedded Processors) 5.4.1 20160609 (release) [ARM/embedded-5-branch revision 237715]
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p></p>

<ul>
<li>SPL版本： STM32F4xx_DSP_StdPeriph_Lib_V1.6.1</li>
<li>開發板： STM32F4 Dicovery, <a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">STM32F429-Disco</a></li>
</ul>


<p><a name="stm-3-usart"></a></p>

<h2>USART 控制</h2>

<p>對於組裝工來說，我想要理解的不是電位差之這些電器信號。甚至在組裝時我也不在意暫存器設定等東西和背後的原理（好孩子不要學）。我關心的是</p>

<ol>
<li>我們要用哪些資源？</li>
<li>這些資源對應的實體腳位是？</li>
<li>軟體中怎麼樣設定和啟動設備？</li>
<li>軟體中怎麼樣傳輸資料？</li>
</ol>


<p>我們針對這四個問題一一處理</p>

<h3>我們要用哪些資源？</h3>

<p>從手冊可以看到有八個USART可以用。我原本是挑USART1來用，不過後來卡關經過網友提醒發現要避開USART1。後來發現APB2上面除了USART1外另外一個USART是USART6。懶得太多程式碼的情況下就挑了USART6。</p>

<h3>這些資源對應的實體腳位是？</h3>

<p>一樣要翻手冊。</p>

<ul>
<li>PC6: UASRT6 TX</li>
<li>PC7: USART6 RX</li>
</ul>


<h3>軟體中怎麼樣設定和啟動設備？</h3>

<p>要分兩個部份討論</p>

<h4>a. GPIOC 設定</h4>

<p>要設定</p>

<ul>
<li>開啟GPIOC的clock</li>
<li>設定Pin腳，設定PC6和PC7這兩個腳位。為什麼是這兩個腳位請查手冊

<ul>
<li>PC6: 設成Alternate function，也就是USART6 TX</li>
<li>PC7: 設成Alternate function，也就是USART6 RX</li>
<li>其他

<ul>
<li>設定為Pull UP，這和USART通訊協定有關，在IDLE時維持高電位</li>
<li>設定Push-Pull輸出模式，這個我完全不懂只是閉著眼睛抄的</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>來看大家最討厭看的程式碼片斷吧</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Enable GPIOC clock */</span>
</span><span class='line'><span class="n">RCC_AHB1PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHB1Periph_GPIOC</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Connect USART6_Tx instead of PC6 */</span>
</span><span class='line'><span class="n">GPIO_PinAFConfig</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span> <span class="n">GPIO_PinSource6</span><span class="p">,</span> <span class="n">GPIO_AF_USART6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Connect USART6_Rx instead of PC7 */</span>
</span><span class='line'><span class="n">GPIO_PinAFConfig</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span> <span class="n">GPIO_PinSource7</span><span class="p">,</span> <span class="n">GPIO_AF_USART6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Configure USART Tx (PC6) and Rx (PC7) as alternate function  */</span>
</span><span class='line'><span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span>  <span class="o">=</span> <span class="n">GPIO_Mode_AF</span><span class="p">;</span>
</span><span class='line'><span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span>   <span class="o">=</span> <span class="n">GPIO_Pin_6</span> <span class="o">|</span> <span class="n">GPIO_Pin_7</span><span class="p">;</span>
</span><span class='line'><span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_100MHz</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_OType</span> <span class="o">=</span> <span class="n">GPIO_OType_PP</span><span class="p">;</span>
</span><span class='line'><span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_PuPd</span>  <span class="o">=</span> <span class="n">GPIO_PuPd_UP</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>b. USART6 設定</h4>

<p>依下列步驟</p>

<ol>
<li>開啟USART6的clock</li>
<li>設定USART6

<ul>
<li>115200 BPS</li>
<li>No parity bit</li>
<li>8-bit 資料</li>
<li>1 Stop bit</li>
<li>關閉硬體流量控制</li>
<li>TX/RX模式都打開</li>
</ul>
</li>
<li>啟動UASRT6</li>
</ol>


<p>一樣來看大家最討厭看的程式碼片斷吧</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">USART_InitTypeDef</span> <span class="n">USART_InitStruct</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Enable USART6 clock */</span>
</span><span class='line'><span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_USART6</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 115200, N81  */</span>
</span><span class='line'><span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_BaudRate</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
</span><span class='line'><span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_WordLength</span> <span class="o">=</span> <span class="n">USART_WordLength_8b</span><span class="p">;</span>
</span><span class='line'><span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_StopBits</span> <span class="o">=</span> <span class="n">USART_StopBits_1</span><span class="p">;</span>
</span><span class='line'><span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_Parity</span> <span class="o">=</span> <span class="n">USART_Parity_No</span><span class="p">;</span>
</span><span class='line'><span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_HardwareFlowControl</span> <span class="o">=</span> <span class="n">USART_HardwareFlowControl_None</span><span class="p">;</span>
</span><span class='line'><span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_Mode</span> <span class="o">=</span> <span class="n">USART_Mode_Rx</span> <span class="o">|</span> <span class="n">USART_Mode_Tx</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Apply USART settings */</span>
</span><span class='line'><span class="n">USART_Init</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">USART_InitStruct</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Enable USART */</span>
</span><span class='line'><span class="n">USART_Cmd</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>軟體中怎麼樣傳輸資料？</h3>

<p>這部份還蠻直覺的，就是檢查狀態。可以送的時候就寫資料到暫存器去；有資料時從暫存器讀出資料。程式碼夠短應該不會那麼討厭吧？另外SPL也有提供USART傳輸接收的函數，請自行查詢。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="nf">getchar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">USART_GetFlagStatus</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="n">USART_FLAG_RXNE</span><span class="p">)</span> <span class="o">==</span> <span class="n">RESET</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">USART6</span><span class="o">-&gt;</span><span class="n">DR</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* Wait until data was tranferred */</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">USART_GetFlagStatus</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="n">USART_FLAG_TXE</span><span class="p">)</span> <span class="o">==</span> <span class="n">RESET</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">USART6</span><span class="o">-&gt;</span><span class="n">DR</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-3-code"></a></p>

<h2>程式碼</h2>

<p>最完整可編譯程式碼放在<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice/tree/master/labs/1_usart">這邊</a>。</p>

<p>前面有提到HSE設定需要更動為8MHz。我是在<code>stm32f4xx_conf.h</code>加入以下片斷。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#if defined  (HSE_VALUE)</span>
</span><span class='line'><span class="cm">/* Redefine the HSE value; it&#39;s equal to 8 MHz on the STM32F4-DISCOVERY Kit */</span>
</span><span class='line'> <span class="cp">#undef HSE_VALUE</span>
</span><span class='line'> <span class="cp">#define HSE_VALUE    ((uint32_t)8000000) </span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* HSE_VALUE */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-3-code-code"></a></p>

<h3>完整程式碼</h3>

<p>就是把前面的設定合體再加上一些helper就是了。這個程式也不難，就是印出你打的字。當你按enter後會自動塞入<code>\r</code>並且印出提示符號。</p>

<figure class='code'><figcaption><span>usart.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &quot;stm32f4xx_conf.h&quot;</span>
</span><span class='line'><span class="cp">#include &lt;stm32f4xx.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stm32f4xx_gpio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stm32f4xx_usart.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setupUSART</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* helper functions */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'><span class="kt">char</span> <span class="nf">getchar</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* Setup USART */</span>
</span><span class='line'>    <span class="n">setupUSART</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Greeting */</span>
</span><span class='line'>    <span class="n">print</span><span class="p">(</span><span class="s">&quot;Hello World</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&gt; &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* Echo a character */</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
</span><span class='line'>        <span class="n">putchar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Show prompt with enter */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&gt; &quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setupUSART</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Enable GPIOC clock */</span>
</span><span class='line'>    <span class="n">RCC_AHB1PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHB1Periph_GPIOC</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Connect USART6_Tx instead of PC6 */</span>
</span><span class='line'>    <span class="n">GPIO_PinAFConfig</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span> <span class="n">GPIO_PinSource6</span><span class="p">,</span> <span class="n">GPIO_AF_USART6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Connect USART6_Rx instead of PC7 */</span>
</span><span class='line'>    <span class="n">GPIO_PinAFConfig</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span> <span class="n">GPIO_PinSource7</span><span class="p">,</span> <span class="n">GPIO_AF_USART6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Configure USART Tx (PC6) and Rx (PC7) as alternate function  */</span>
</span><span class='line'>    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span>  <span class="o">=</span> <span class="n">GPIO_Mode_AF</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span>   <span class="o">=</span> <span class="n">GPIO_Pin_6</span> <span class="o">|</span> <span class="n">GPIO_Pin_7</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_100MHz</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_OType</span> <span class="o">=</span> <span class="n">GPIO_OType_PP</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_PuPd</span>  <span class="o">=</span> <span class="n">GPIO_PuPd_UP</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/********************************************</span>
</span><span class='line'><span class="cm">     * USART set started here</span>
</span><span class='line'><span class="cm">     ********************************************/</span>
</span><span class='line'>    <span class="n">USART_InitTypeDef</span> <span class="n">USART_InitStruct</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Enable USART6 clock */</span>
</span><span class='line'>    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_USART6</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* 115200, N81  */</span>
</span><span class='line'>    <span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_BaudRate</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
</span><span class='line'>    <span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_WordLength</span> <span class="o">=</span> <span class="n">USART_WordLength_8b</span><span class="p">;</span>
</span><span class='line'>    <span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_StopBits</span> <span class="o">=</span> <span class="n">USART_StopBits_1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_Parity</span> <span class="o">=</span> <span class="n">USART_Parity_No</span><span class="p">;</span>
</span><span class='line'>    <span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_HardwareFlowControl</span> <span class="o">=</span> <span class="n">USART_HardwareFlowControl_None</span><span class="p">;</span>
</span><span class='line'>    <span class="n">USART_InitStruct</span><span class="p">.</span><span class="n">USART_Mode</span> <span class="o">=</span> <span class="n">USART_Mode_Rx</span> <span class="o">|</span> <span class="n">USART_Mode_Tx</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Apply USART settings */</span>
</span><span class='line'>    <span class="n">USART_Init</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">USART_InitStruct</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Enable USART */</span>
</span><span class='line'>    <span class="n">USART_Cmd</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="nf">getchar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">USART_GetFlagStatus</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="n">USART_FLAG_RXNE</span><span class="p">)</span> <span class="o">==</span> <span class="n">RESET</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">USART6</span><span class="o">-&gt;</span><span class="n">DR</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* Wait until data was tranferred */</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">USART_GetFlagStatus</span><span class="p">(</span><span class="n">USART6</span><span class="p">,</span> <span class="n">USART_FLAG_TXE</span><span class="p">)</span> <span class="o">==</span> <span class="n">RESET</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">USART6</span><span class="o">-&gt;</span><span class="n">DR</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert_param</span><span class="p">(</span><span class="n">str</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>        <span class="n">str</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Trap here for gdb if asserted */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">assert_failed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">line</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-3-code-make"></a></p>

<h3>Makefile</h3>

<p>有兩點要說明</p>

<ol>
<li>加入<code>stm32f4xx_usart.c</code></li>
<li>加入make flash自動燒錄

<ul>
<li>目前發現使用st-flash燒錄有時候顯示燒錄完成，但是實際上測試還是燒錄前的行為，換成openocd測試中</li>
</ul>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="c">#----------------------------------------------------------------------------------</span>
</span><span class='line'><span class="c"># Commom settings</span>
</span><span class='line'><span class="c">#----------------------------------------------------------------------------------</span>
</span><span class='line'><span class="nv">TARGET</span><span class="o">=</span>usart
</span><span class='line'><span class="nv">PRJ_ROOT</span><span class="o">=</span><span class="k">$(</span>shell <span class="nb">cd</span> ../../ <span class="p">;</span> <span class="nb">pwd</span><span class="k">)</span>
</span><span class='line'><span class="cp">include $(PRJ_ROOT)/conf/build.def</span>
</span><span class='line'>
</span><span class='line'><span class="c">#----------------------------------------------------------------------------------</span>
</span><span class='line'><span class="c"># Files to build</span>
</span><span class='line'><span class="c">#----------------------------------------------------------------------------------</span>
</span><span class='line'><span class="nv">SRCS</span>  <span class="o">=</span> <span class="k">$(</span>CMSIS_STARTUP_SRC<span class="k">)</span> <span class="k">$(</span>CMSIS_SYSTEM_SRC<span class="k">)</span>
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> <span class="k">$(</span>STM_DIR<span class="k">)</span>/src/stm32f4xx_gpio.c
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> <span class="k">$(</span>STM_DIR<span class="k">)</span>/src/stm32f4xx_rcc.c
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> <span class="k">$(</span>STM_DIR<span class="k">)</span>/src/stm32f4xx_usart.c
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> usart.c
</span><span class='line'>
</span><span class='line'><span class="nv">C_OBJS</span> <span class="o">=</span> <span class="k">$(</span>patsubst %.c, %.o, <span class="k">$(</span>SRCS<span class="k">))</span>   <span class="c"># translate *.c to *.o</span>
</span><span class='line'><span class="nv">OBJS</span>   <span class="o">=</span> <span class="k">$(</span>patsubst %.s, %.o, <span class="k">$(</span>C_OBJS<span class="k">))</span> <span class="c"># also *.s to *.o files</span>
</span><span class='line'>
</span><span class='line'><span class="nv">OUT_OBJS</span> <span class="o">=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>OUT_DIR<span class="k">)</span>/, <span class="k">$(</span>OBJS<span class="k">))</span>
</span><span class='line'>
</span><span class='line'><span class="c">#----------------------------------------------------------------------------------</span>
</span><span class='line'><span class="c"># Build here</span>
</span><span class='line'><span class="c">#----------------------------------------------------------------------------------</span>
</span><span class='line'><span class="nf">$(OUT_DIR)/$(TARGET).bin</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OUT_OBJS</span><span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-gcc -Wl,-Map<span class="o">=</span><span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.map,-T<span class="k">$(</span>TARGET<span class="k">)</span>.ld -nostartfiles <span class="se">\</span>
</span><span class='line'>      <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>OUT_OBJS<span class="k">)</span> -o <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.elf
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-objcopy -Obinary <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.elf <span class="nv">$@</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-objdump -S <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.elf &gt; <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.list
</span><span class='line'>
</span><span class='line'><span class="nf">$(OUT_DIR)/%.o</span><span class="o">:</span> %.<span class="n">s</span>
</span><span class='line'>  mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-gcc -c <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="nv">$&lt;</span> -o <span class="nv">$@</span>
</span><span class='line'>
</span><span class='line'><span class="nf">$(OUT_DIR)/%.o</span><span class="o">:</span> %.<span class="n">c</span>
</span><span class='line'>  mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-gcc -c <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="nv">$&lt;</span> -o <span class="nv">$@</span>
</span><span class='line'>
</span><span class='line'><span class="nf">flash</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OUT_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">TARGET</span><span class="k">)</span>.<span class="n">bin</span>
</span><span class='line'>  openocd -f interface/stlink-v2.cfg  <span class="se">\</span>
</span><span class='line'>            -f target/stm32f4x.cfg      <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;init&quot;</span>                   <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;reset init&quot;</span>             <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;stm32f2x unlock 0&quot;</span>      <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;flash probe 0&quot;</span>          <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;flash info 0&quot;</span>           <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;flash write_image erase $&lt; 0x8000000&quot;</span> <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;reset run&quot;</span> -c shutdown
</span><span class='line'>
</span><span class='line'><span class="nf">clean</span><span class="o">:</span>
</span><span class='line'>  rm -fr <span class="k">$(</span>OUT_DIR<span class="k">)</span> gdb.txt
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-3-test"></a></p>

<h2>功能驗證</h2>

<h3>邏輯分析儀驗證</h3>

<p>現在邏輯分析儀已經可以自動幫你抓波形分析了。當你下載並解壓縮檔案後，記得更新udev的Rule讓電腦可以認得邏輯分析儀。</p>

<p>接下來你要設定邏輯分析儀的分析通訊協定為Async Serial 如下圖
<img src="/files/stm32/LG_SP1.jpg"/></p>

<p>選了Async Serial會有選單出現，你需要設定用第幾個Channel以及USART通訊參數如下圖
<img src="/files/stm32/LG_SP2.jpg"/></p>

<p>如果需要的話，你可以進一步設定取樣速度、取樣時間如下圖
<img src="/files/stm32/LG_SP3.jpg"/></p>

<p>假設你的邏輯分析儀接腳都接好了就可以按開始分析訊號了
<img src="/files/stm32/LG_SP4.jpg"/></p>

<p>這是一個成功的Hello World波形分析，圖可能有點小，全圖在<a href="/files/stm32/usart2.jpg">這邊</a>。
<img src="/files/stm32/usart2.jpg"/></p>

<h3>實際驗證</h3>

<p>你需要先把USB 轉 RS232 TTL 轉接線接到版子上如下圖
<img src="/files/stm32/STM_USART_Pin.jpg"/></p>

<p>我是使用mintern，執行畫面如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ miniterm.py -b 115200 -p /dev/ttyUSB0
</span><span class='line'>--- Miniterm on /dev/ttyUSB0: 115200,8,N,1 ---
</span><span class='line'>--- Quit: Ctrl+]  |  Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---
</span><span class='line'>test
</span><span class='line'>&gt; test
</span><span class='line'>&gt; test
</span><span class='line'>&gt; test
</span><span class='line'>&gt; testast
</span><span class='line'>&gt; teadsatdsasd
</span></code></pre></td></tr></table></div></figure>


<p><a name="stm-3-ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://homes.soic.indiana.edu/geobrown/index.cgi/teaching">Geoffrey Brown: Teaching </a>

<ul>
<li>請找 Lab Manual 裏面的link, 書名是<code>Discovering the STM32 Microcontroller</code></li>
</ul>
</li>
<li><a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">STM32F4 Discovry Disco 開發版手冊</a></li>
<li><a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32065.html">STM32F4 DSP and standard peripherals library</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/02/auto-photo-watermarking-script/">Auto Photo Watermarking Script</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-02T16:53:13+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>4:53 pm</span></time>
        
           | <a href="/blog/2016/08/02/auto-photo-watermarking-script/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/08/02/auto-photo-watermarking-script/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>因故需要對大量圖片調整解析度並加入浮水印，查了網路找到非常好的<a href="http://www.linuxjournal.com/content/easy-watermarking-imagemagick">範例文章</a>。這篇<a href="http://www.linuxjournal.com/content/easy-watermarking-imagemagick">文章</a>裏面也有script，和我的不太一樣，有興趣的人可以去參考。</p>

<p>更改後寫成script如下，它做了：</p>

<ol>
<li>開了<code>processed_pictures</code>目錄，把改過的檔案存到該目錄</li>
<li>將新的圖案解析度寬度轉成1024</li>
<li>將產生的圖片quality設成80%</li>
<li>加入浮水印字串</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nv">TARGET_DIR</span><span class="o">=</span>processed_pictures
</span><span class='line'><span class="nv">NEW_WIDTH</span><span class="o">=</span>1024
</span><span class='line'><span class="nv">CAP</span><span class="o">=</span><span class="s2">&quot;Wen Liao&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p <span class="nv">$TARGET_DIR</span>
</span><span class='line'><span class="k">for</span> i in <span class="k">$(</span>ls<span class="k">)</span> <span class="p">;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">echo </span>convert <span class="nv">$i</span> to <span class="nv">$TARGET_DIR</span>
</span><span class='line'>    convert -background <span class="s1">&#39;#0008&#39;</span> -quality <span class="m">80</span> -resize <span class="nv">$NEW_WIDTH</span> -fill white -gravity center -size <span class="k">$(</span>identify -format %w <span class="nv">$i</span><span class="k">)</span>x120 caption:<span class="s2">&quot;$CAP&quot;</span> <span class="nv">$i</span> +swap -gravity south -composite <span class="nv">$TARGET_DIR</span>/<span class="nv">$i</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>要注意</p>

<ol>
<li>本script假設目前目錄都是圖檔，所以不判斷檔名是否為<code>.jpg</code>或是<code>.png</code></li>
<li>無法處理檔名有空白的檔案</li>
<li>你需要自行安裝imagemagick</li>
<li>由於相片landscape 和 portrait的關係，浮水印的位址不一定會和你想的一樣，目前為止我不在意這個問題就是了。附上範例轉出的landscape 和 portrait照片各一張</li>
</ol>


<h4>Landscape</h4>

<p><img src="/files/dog.jpg" title="landscape"></p>

<h4>Portrait</h4>

<p><img src="/files/cat.jpg" title="portrait"></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://www.linuxjournal.com/content/easy-watermarking-imagemagick">Linux Journal Easy Watermarking with ImageMagick</a></li>
<li><a href="http://www.xoogu.com/2013/how-to-automatically-watermark-or-batch-watermark-photos-using-imagemagick/">How to automatically watermark or batch watermark photos using ImageMagick</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/27/arm-cm4-pratice-2-lab-led/">ARM CM4 Pratice (2): 實驗軟體專案規劃和LED閃滅實驗</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-27T19:14:27+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:14 pm</span></time>
        
           | <a href="/blog/2016/06/27/arm-cm4-pratice-2-lab-led/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/06/27/arm-cm4-pratice-2-lab-led/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p>閉著眼睛學東西最困擾的是資料很多，但是完全不知道怎麼從那邊下手。這次運氣很好終於找到大大推荐的<a href="http://homes.soic.indiana.edu/geobrown/index.cgi/teaching">入門教材: Discovering the STM32 Microcontroller</a>作為一個突破點。雖然他上面講的是STM32F1，不過改一下還是可以在開發版上面動，短期內的自學大概會以這本書為主。</p>

<p>本篇文章主要是介紹在GNU/Linux下的STM32F429　開發軟體，這次以LED閃滅為實習題目，以後的實習會基於這次的專案為主。有興趣的朋友請自行到我的<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice">Github repository</a>取用。注意是這個專案單純自爽，常常會<code>git push -f</code>變動commit，如果有人fork我再調整。</p>

<h2>目錄</h2>

<ul>
<li><a href="#STM-ENV">測試環境</a></li>
<li><a href="#STM_PRJ">專案規劃</a></li>
<li><a href="#STM_MK">Makefile撰寫</a>

<ul>
<li><a href="#STM_MK_COMM">共用變數</a></li>
<li><a href="#STM_MK_TEMP">專案Makefile template</a></li>
</ul>
</li>
<li><a href="#STM_LED">第一支程式: LED閃滅</a>

<ul>
<li><a href="#STM_LED_LK_STRP">Linker script 和 start up檔案</a></li>
<li><a href="#STM_LED_GPIO">GPIO API</a></li>
<li><a href="#STM_LED_TIMER_ISR">Timer ISR</a></li>
<li><a href="#STM_LED_CODE">程式碼</a></li>
<li><a href="#STM_LED_VERIFY">燒錄和測試</a></li>
</ul>
</li>
<li><a href="#STM-SPL-REF">參考資料</a></li>
</ul>


<p><a name="STM-ENV"></a></p>

<h2>測試環境</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.4 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span><span class='line'>
</span><span class='line'>$ arm-none-eabi-gcc --version
</span><span class='line'>arm-none-eabi-gcc (GNU Tools for ARM Embedded Processors) 5.4.1 20160609 (release) [ARM/embedded-5-branch revision 237715]
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p></p>

<ul>
<li>SPL版本： STM32F4xx_DSP_StdPeriph_Lib_V1.6.1</li>
<li>開發板： STM32F4 Dicovery, <a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">STM32F429-Disco</a></li>
<li>SPL 目錄架構</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ tree -d -L 4
</span><span class='line'>.
</span><span class='line'>└── STM32F4xx_DSP_StdPeriph_Lib_V1.6.1
</span><span class='line'>    ├── _htmresc
</span><span class='line'>    ├── Libraries
</span><span class='line'>    │   ├── CMSIS
</span><span class='line'>    │   │   ├── Device
</span><span class='line'>    │   │   ├── Documentation
</span><span class='line'>    │   │   ├── DSP_Lib
</span><span class='line'>    │   │   ├── Include
</span><span class='line'>    │   │   ├── Lib
</span><span class='line'>    │   │   └── RTOS
</span><span class='line'>    │   └── STM32F4xx_StdPeriph_Driver
</span><span class='line'>    │       ├── inc
</span><span class='line'>    │       └── src
</span><span class='line'>    ├── Project
</span><span class='line'>    │   ├── STM32F4xx_StdPeriph_Examples
</span><span class='line'>    │   └── STM32F4xx_StdPeriph_Templates
</span><span class='line'>    └── Utilities
</span><span class='line'>        ├── Media
</span><span class='line'>        ├── ST
</span><span class='line'>        ├── STM32_EVAL
</span><span class='line'>        └── Third_Party
</span></code></pre></td></tr></table></div></figure>


<p><a name="STM_PRJ"></a></p>

<h2>專案規劃</h2>

<p>看<a href="http://www.cs.indiana.edu/~geobrown/book.pdf">Discovering the STM32 Microcontroller</a>這本書後啟發的。想法整理如下：</p>

<ul>
<li>目的：建立一個練習STM32F4開發版的專案</li>
<li>專案需要的資料

<ul>
<li>STM 函式庫 source code

<ul>
<li>這部份要去官方網站下載，不會放到github上面</li>
</ul>
</li>
<li>Build code 共用的設定如toolchain、路徑、compile flag等</li>
<li>一些template 檔案加入開發如Makefile、linker script、config header file</li>
</ul>
</li>
</ul>


<p>最後的目錄就是這樣。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ tree -L 3
</span><span class='line'>.
</span><span class='line'>├── conf
</span><span class='line'>│   ├── build.def
</span><span class='line'>│   ├── Makefile.template
</span><span class='line'>│   ├── stm32f4xx_conf.h
</span><span class='line'>│   └── template-bared.ld
</span><span class='line'>├── labs
</span><span class='line'>│   └── 0_led
</span><span class='line'>│       ├── led.c
</span><span class='line'>│       ├── led.ld
</span><span class='line'>│       ├── Makefile
</span><span class='line'>│       └── stm32f4xx_conf.h
</span><span class='line'>├── libraries
</span><span class='line'>│   ├── readme.txt
</span><span class='line'>│   └── STM32F4xx_DSP_StdPeriph_Lib_V1.6.1
</span><span class='line'>├── LICENSE
</span><span class='line'>└── README.md
</span></code></pre></td></tr></table></div></figure>


<p>請注意SPL可能會因為下載版本不同，變數宣告、常數宣告、和檔案名稱路徑可能不同造成編譯失敗，這時候就當組裝作業自己解決吧。</p>

<p><a name="STM_MK"></a></p>

<h2>Makefile撰寫</h2>

<p><a name="STM_MK_COMM"></a></p>

<h3>共用變數</h3>

<p>這邊我們需要一個共用的設定，在實習的時候直接include。詳細說明如下，懶得看的可以直接看<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice/blob/master/conf/build.def">檔案內容</a>。</p>

<ul>
<li>Toolchain設定

<ul>
<li>安裝請參考<a href="http://wen00072.github.io/blog/2016/04/06/arm-cm4-pratice-0-environment-setup/">這邊</a></li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">TOOL_CHAIN_PREFIX</span><span class="o">=</span>arm-none-eabi
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>路徑設定

<ul>
<li>我們需要<strong>定位</strong>專案的最頂端位址才能設定其他路徑的相對位址</li>
<li>除了您自己的檔案，ST 提供的函式庫和ARM的CMSIS在開發都會用到</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">PRJ_ROOT</span><span class="o">?=</span>..
</span><span class='line'><span class="nv">LIB_DIR</span><span class="o">=</span><span class="k">$(</span>PRJ_ROOT<span class="k">)</span>/libraries/STM32F4xx_DSP_StdPeriph_Lib_V1.6.1/Libraries
</span><span class='line'><span class="nv">STM_DIR</span><span class="o">=</span><span class="k">$(</span>LIB_DIR<span class="k">)</span>/STM32F4xx_StdPeriph_Driver
</span><span class='line'><span class="nv">CMSIS_DIR</span><span class="o">=</span><span class="k">$(</span>LIB_DIR<span class="k">)</span>/CMSIS
</span><span class='line'><span class="nv">LDSCRIPT</span><span class="o">?=</span><span class="k">$(</span>PRJ_ROOT<span class="k">)</span>/conf/bared.ld
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>指定開發平台</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">PLATFORM</span> <span class="o">=</span> STM32F429_439xx
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>設定header file路徑</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">SPL_INC</span><span class="o">=</span><span class="k">$(</span>STM_DIR<span class="k">)</span>/inc
</span><span class='line'><span class="nv">CMSIS_COMMON_INC</span> <span class="o">=</span> <span class="k">$(</span>CMSIS_DIR<span class="k">)</span>/Include
</span><span class='line'><span class="nv">CMSIS_STM32_INC</span>  <span class="o">=</span> <span class="k">$(</span>CMSIS_DIR<span class="k">)</span>/Device/ST/STM32F4xx/Include
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>指令所有產生的檔案都放到build目錄</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">OUT_DIR</span><span class="o">=</span><span class="k">$(</span>PRJ_ROOT<span class="k">)</span>/build
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>設定start up檔案和system檔案路徑</li>
</ul>


<p>除非你要自己從flash搬資料到RAM、設定ISR vector、RCC等，不然一定會用到start up 檔案和system檔案。start up 檔案在SPL中有很多範本，我們使用了<code>gcc_ride7</code>這個版本，原因是其他的都沒有<code>gcc</code>這個字眼。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">CMSIS_STARTUP_SRC</span> <span class="o">=</span> <span class="k">$(</span>CMSIS_DIR<span class="k">)</span>/Device/ST/STM32F4xx/Source/Templates/gcc_ride7/startup_stm32f429_439xx.s
</span><span class='line'><span class="nv">CMSIS_SYSTEM_SRC</span>  <span class="o">=</span> <span class="k">$(</span>CMSIS_DIR<span class="k">)</span>/Device/ST/STM32F4xx/Source/Templates/system_stm32f4xx.c
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>設定debug mode</li>
</ul>


<p>SPL提供assertion，使用USE_FULL_ASSERT打開。打開以後需要自行實作函數<code>void assert_failed(uint8_t* file, uint32_t line)</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">BUILD_MODE</span> <span class="o">=</span> DEBUG
</span><span class='line'>
</span><span class='line'><span class="cp">ifeq ($(BUILD_MODE), DEBUG)</span>
</span><span class='line'>        CFLAGS +<span class="o">=</span> -DUSE_FULL_ASSERT -g3
</span><span class='line'><span class="cp">endif</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>CPU相關compile flags</li>
</ul>


<p>STM32F4使用Cotex M4。題外話，對於toolchain有興趣的可以用<code>arm-none-eabi-gcc -Q --help=target</code>查詢有支援哪些平台。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">ARCH_FLAGS</span> <span class="o">=</span> -mthumb -mcpu<span class="o">=</span>cortex-m4
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Compile flag分為

<ul>
<li>增加嚴格的錯誤檢查</li>
<li>設定include 路徑</li>
<li>叫toolchain不要用使用內建的函式庫如libc</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">LDFLAGS</span> <span class="o">+=</span> -T<span class="k">$(</span>LDSCRIPT<span class="k">)</span> <span class="k">$(</span>ARCH_FLAGS<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">CFLAGS</span> <span class="o">+=</span> <span class="k">$(</span>ARCH_FLAGS<span class="k">)</span>
</span><span class='line'><span class="nv">CFLAGS</span> <span class="o">+=</span> -I. -I<span class="k">$(</span>SPL_INC<span class="k">)</span> -I<span class="k">$(</span>CMSIS_COMMON_INC<span class="k">)</span> -I<span class="k">$(</span>CMSIS_STM32_INC<span class="k">)</span>
</span><span class='line'><span class="nv">CFLAGS</span> <span class="o">+=</span> -D<span class="k">$(</span>PLATFORM<span class="k">)</span> -DUSE_STDPERIPH_DRIVER <span class="k">$(</span>FULLASSERT<span class="k">)</span>
</span><span class='line'><span class="nv">CFLAGS</span> <span class="o">+=</span> -Wall -Werror -MMD -std<span class="o">=</span>c99
</span><span class='line'><span class="nv">CFLAGS</span> <span class="o">+=</span> -fno-common -ffreestanding -O0
</span></code></pre></td></tr></table></div></figure>


<p><a name="STM_MK_TEMP"></a></p>

<h3>專案Makefile template</h3>

<p>這邊直接把LED閃滅的Makefile拿來當template，詳細說明如下，一樣懶得看的可以去<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice/blob/master/conf/Makefile.template">這邊</a>看檔案內容。</p>

<ul>
<li>產生的binary 檔名、定位專案的最頂端位址、並且載入<a href="#STM_MK_COMM">前面</a>的設定檔。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">TARGET</span><span class="o">=</span>led
</span><span class='line'><span class="nv">PRJ_ROOT</span><span class="o">=</span><span class="k">$(</span>shell <span class="nb">cd</span> ../../ <span class="p">;</span> <span class="nb">pwd</span><span class="k">)</span>
</span><span class='line'><span class="cp">include $(PRJ_ROOT)/conf/build.def</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>指定要編譯的SPL 檔案</li>
</ul>


<p>除了前面<a href="#STM_MK_COMM">前面</a>提到的start up檔案、system檔、還有你自己的程式碼外，根據你的需求，還會需要SPL的驅動程式。這個專案我們需要<code>GPIO</code>和<code>RCC</code> (reset clock control)這兩個部份。一個是用來控制LED、另外一個用來計算時間產生以控制閃滅。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">SRCS</span>  <span class="o">=</span> <span class="k">$(</span>CMSIS_STARTUP_SRC<span class="k">)</span> <span class="k">$(</span>CMSIS_SYSTEM_SRC<span class="k">)</span>
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> <span class="k">$(</span>STM_DIR<span class="k">)</span>/src/stm32f4xx_gpio.c
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> <span class="k">$(</span>STM_DIR<span class="k">)</span>/src/stm32f4xx_rcc.c
</span><span class='line'><span class="nv">SRCS</span> <span class="o">+=</span> led.c
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>檔名轉換</li>
</ul>


<p>上面的是source檔案，但是我們編譯需要把source檔案轉成object檔案並且存在./build目錄下。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nv">C_OBJS</span> <span class="o">=</span> <span class="k">$(</span>patsubst %.c, %.o, <span class="k">$(</span>SRCS<span class="k">))</span>   <span class="c"># translate *.c to *.o</span>
</span><span class='line'><span class="nv">OBJS</span>   <span class="o">=</span> <span class="k">$(</span>patsubst %.s, %.o, <span class="k">$(</span>C_OBJS<span class="k">))</span> <span class="c"># also *.s to *.o files</span>
</span><span class='line'>
</span><span class='line'><span class="nv">OUT_OBJS</span> <span class="o">=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>OUT_DIR<span class="k">)</span>/, <span class="k">$(</span>OBJS<span class="k">))</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>產生led.bin</li>
</ul>


<p>不要被符號嚇到，說明如下</p>

<pre><code>* 產生build/led.bin檔，前提是上面的object 檔案都編譯完成
* 產生方式
    * 叫gcc 從前面的object檔案中，透過led.ld linker script產生出build/led.elf、build/led.map (debug用)
    * 從build/led.elf產生build/led.bin
    * 從build/led.elf產生build/led.list (debug用)
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nf">$(OUT_DIR)/$(TARGET).bin</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OUT_OBJS</span><span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-gcc -Wl,-Map<span class="o">=</span><span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.map,-T<span class="k">$(</span>TARGET<span class="k">)</span>.ld -nostartfiles <span class="se">\</span>
</span><span class='line'>      <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>OUT_OBJS<span class="k">)</span> -o <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.elf
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-objcopy -Obinary <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.elf <span class="nv">$@</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-objdump -S <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.elf &gt; <span class="k">$(</span>OUT_DIR<span class="k">)</span>/<span class="k">$(</span>TARGET<span class="k">)</span>.list
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>編譯並產生object 檔案</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nf">$(OUT_DIR)/%.o</span><span class="o">:</span> %.<span class="n">s</span>
</span><span class='line'>  @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-gcc -c <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="nv">$&lt;</span> -o <span class="nv">$@</span>
</span><span class='line'>
</span><span class='line'><span class="nf">$(OUT_DIR)/%.o</span><span class="o">:</span> %.<span class="n">c</span>
</span><span class='line'>  @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>TOOL_CHAIN_PREFIX<span class="k">)</span>-gcc -c <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="nv">$&lt;</span> -o <span class="nv">$@</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>燒錄</li>
</ul>


<p>可以下<code>make flash</code>燒錄。使用<code>openocd</code>的原因是因為<code>st-flash</code>偶爾會有寫燒錄完成但是實際上沒有燒進去的情況</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nf">flash</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OUT_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">TARGET</span><span class="k">)</span>.<span class="n">bin</span>
</span><span class='line'>  openocd -f interface/stlink-v2.cfg  <span class="se">\</span>
</span><span class='line'>            -f target/stm32f4x.cfg      <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;init&quot;</span>                   <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;reset init&quot;</span>             <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;stm32f2x unlock 0&quot;</span>      <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;flash probe 0&quot;</span>          <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;flash info 0&quot;</span>           <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;flash write_image erase $&lt; 0x8000000&quot;</span> <span class="se">\</span>
</span><span class='line'>            -c <span class="s2">&quot;reset run&quot;</span> -c shutdown
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>以下不解釋</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Makefile'><span class='line'><span class="nf">clean</span><span class="o">:</span>
</span><span class='line'>  rm -fr <span class="k">$(</span>OUT_DIR<span class="k">)</span> gdb.txt
</span></code></pre></td></tr></table></div></figure>


<p><a name="STM_LED"></a></p>

<h2>第一支程式: LED閃滅</h2>

<p><a name="STM_LED_LK_STRP"></a></p>

<h3>Linker script 和 start up檔案</h3>

<h4>Linker script</h4>

<p>linker script (<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice/blob/master/labs/0_led/led.ld">全文</a>)，這個script是從<a href="http://wiki.csie.ncku.edu.tw/embedded/rtenv">成大課程作業</a>修改的，簡單解釋如下</p>

<ul>
<li>有兩塊記憶體，一個是FLASH一個是RAM，FLASH 不可寫入。</li>
<li>那些<code>.text</code>、<code>.data</code>、<code>.bss</code>就不解釋了。我們這次關注下列的symbols

<ul>
<li><code>_sidata</code></li>
<li><code>_sdata</code></li>
<li><code>_edata</code></li>
<li><code>_sbss</code></li>
<li><code>_ebss</code></li>
<li><code>_estack</code></li>
</ul>
</li>
</ul>


<h4>Start up檔案</h4>

<p>上面的這些symbol，可以<a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S">對照</a>這邊的start up 程式碼中的<code>reset_handler</code>，可以發現：</p>

<ul>
<li><a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L49">第49行</a> 到 <a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L57">第57行</a>就宣告了這些symbol</li>
<li><a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L76">第76行</a> 到 <a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L89">第89行</a>使用了這些symbol將FLASH中的<code>.data</code>資料搬到<code>RAM</code>中</li>
<li><a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L89">第90行</a> 到 <a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L100">第100行</a>使用了這些symbol將<code>.bss</code>區段的值全部設成0</li>
</ul>


<p>搞定<code>.bss</code>和<code>.data</code>後，接下來start up會去<a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L103">呼叫systemInit</a>，而<code>systemInit</code>就在<code>system_stm32f4xx.c</code>裏面。設定完系統後就是你寫的程式碼<a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L105">main</a>上場了。</p>

<p>start up 檔案剩下的部份就是<a href="https://github.com/jserv/stm32f429-r3d/blob/master/startup_stm32f429_439xx.S#L128">.isr_vector</a>，可以想像成一個function pointer陣列(除了最開始的stack pointer，注意stack pointer初始值也是在linker script中設定的)。</p>

<p>另外一個要注意的是start up source code的順序和放在記憶體的順序不一致，真正在記憶體的順序請參考<a href="https://github.com/zzz0072/STM32F429-Discovery-Disco-Pratice/blob/master/labs/0_led/led.ld">linker script</a>。
<a name="STM_LED_GPIO"></a></p>

<h3>GPIO API</h3>

<p>設定順序如下</p>

<ul>
<li>看<a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">開發版手冊</a>找出要控制燈號的GPIO

<ul>
<li>我程式就是輪流點亮點滅LED 3和LED 4，手冊上說是GPIO G的第13和14腳位</li>
</ul>
</li>
<li>打開GPIO的clock（猜測嵌入式系統的電耗考慮，沒再用的設備都不開clock省電）</li>
<li>設定GPIO腳位的為輸出頻率為2MHz</li>
</ul>


<figure class='code'><figcaption><span>GPIO設定</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">setupLED</span><span class="p">(</span><span class="n">GPIO_InitTypeDef</span> <span class="o">*</span><span class="n">LED_InitStruct</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* Setup LED GPIO */</span>
</span><span class='line'>    <span class="n">RCC_AHB1PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHB1Periph_GPIOG</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">GPIO_StructInit</span><span class="p">(</span><span class="n">LED_InitStruct</span><span class="p">);</span>
</span><span class='line'>    <span class="n">LED_InitStruct</span><span class="o">-&gt;</span><span class="n">GPIO_Pin</span>   <span class="o">=</span> <span class="n">GPIO_Pin_13</span> <span class="o">|</span> <span class="n">GPIO_Pin_14</span> <span class="p">;</span>
</span><span class='line'>    <span class="n">LED_InitStruct</span><span class="o">-&gt;</span><span class="n">GPIO_Mode</span>  <span class="o">=</span> <span class="n">GPIO_Mode_OUT</span><span class="p">;</span>
</span><span class='line'>    <span class="n">LED_InitStruct</span><span class="o">-&gt;</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_2MHz</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOG</span><span class="p">,</span> <span class="n">LED_InitStruct</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>輸出資料到GPIO範例如下</li>
</ul>


<figure class='code'><figcaption><span>輸出資料到GPIO範例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GPIO_WriteBit</span><span class="p">(</span><span class="n">GPIOG</span><span class="p">,</span> <span class="n">GPIO_Pin_13</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="STM_LED_TIMER_ISR"></a></p>

<h3>Timer ISR</h3>

<p>要做的是</p>

<ul>
<li>設定timer interrupt 出現的週期，設定成nano second的程式碼如下</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Setup timer interrupt interval to nano second */</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">SysTick_Config</span><span class="p">(</span><span class="n">SystemCoreClock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Trap here if failed */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>time out的ISR，基本上就是計數counter加上busy waiting而已</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="n">__IO</span> <span class="kt">uint32_t</span> <span class="n">g_timeToWakeUp</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">sleep</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">nSec</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">g_timeToWakeUp</span> <span class="o">=</span> <span class="n">nSec</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Busy waiting */</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">g_timeToWakeUp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="STM_LED_CODE"></a></p>

<h3>程式碼</h3>

<p>這邊的assertion 實作單純是一個無限迴圈，當assertion失敗就會陷入這個迴圈。這時候用除錯器就可以找到出現assertion的行號了。</p>

<p>寫了以後開始修改程式碼或<code>Makefile</code>直到編譯過以後才針對程式行為除錯。</p>

<figure class='code'><figcaption><span>led.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &quot;stm32f4xx_conf.h&quot;</span>
</span><span class='line'><span class="cp">#include &lt;stm32f4xx.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stm32f4xx_gpio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* A Led blink lab for STM32 Discovry Disco                   *</span>
</span><span class='line'><span class="cm"> * Based on:                                                  *</span>
</span><span class='line'><span class="cm"> *   Discovering the STM32 Microcontroller by Geoffrey Brown. */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setupLED</span><span class="p">(</span><span class="n">GPIO_InitTypeDef</span> <span class="o">*</span><span class="n">LED_InitStruct</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">sleep</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">nSec</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">int</span> <span class="n">LEDVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GPIO_InitTypeDef</span> <span class="n">LED_InitStruct</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Setup LED */</span>
</span><span class='line'>    <span class="n">setupLED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LED_InitStruct</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Setup timer interrupt interval to nano second */</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">SysTick_Config</span><span class="p">(</span><span class="n">SystemCoreClock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Trap here if failed */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Blinking LED3 and LED4 */</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">GPIO_WriteBit</span><span class="p">(</span><span class="n">GPIOG</span><span class="p">,</span> <span class="n">GPIO_Pin_13</span> <span class="p">,</span> <span class="n">LEDVal</span><span class="p">);</span>
</span><span class='line'>        <span class="n">GPIO_WriteBit</span><span class="p">(</span><span class="n">GPIOG</span><span class="p">,</span> <span class="n">GPIO_Pin_14</span> <span class="p">,</span> <span class="o">!</span><span class="n">LEDVal</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
</span><span class='line'>        <span class="n">LEDVal</span> <span class="o">=</span> <span class="o">!</span><span class="n">LEDVal</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setupLED</span><span class="p">(</span><span class="n">GPIO_InitTypeDef</span> <span class="o">*</span><span class="n">LED_InitStruct</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* Setup LED GPIO */</span>
</span><span class='line'>    <span class="n">RCC_AHB1PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHB1Periph_GPIOG</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">GPIO_StructInit</span><span class="p">(</span><span class="n">LED_InitStruct</span><span class="p">);</span>
</span><span class='line'>    <span class="n">LED_InitStruct</span><span class="o">-&gt;</span><span class="n">GPIO_Pin</span>   <span class="o">=</span> <span class="n">GPIO_Pin_13</span> <span class="o">|</span> <span class="n">GPIO_Pin_14</span> <span class="p">;</span>
</span><span class='line'>    <span class="n">LED_InitStruct</span><span class="o">-&gt;</span><span class="n">GPIO_Mode</span>  <span class="o">=</span> <span class="n">GPIO_Mode_OUT</span><span class="p">;</span>
</span><span class='line'>    <span class="n">LED_InitStruct</span><span class="o">-&gt;</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_2MHz</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOG</span><span class="p">,</span> <span class="n">LED_InitStruct</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">__IO</span> <span class="kt">uint32_t</span> <span class="n">g_timeToWakeUp</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">sleep</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">nSec</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">g_timeToWakeUp</span> <span class="o">=</span> <span class="n">nSec</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Busy waiting */</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">g_timeToWakeUp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* ISR for system tick */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">SysTick_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">g_timeToWakeUp</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">g_timeToWakeUp</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Trap here for gdb if asserted */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">assert_failed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">line</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>比較有趣的是<code>int LEDVal = 0;</code>一定要宣告成<code>static</code>，否則LED完全沒反應。在網路上請教似乎和進出ISR的時候context備份有關係，這部份有空再找時間了解一下，這次先跳過。</p>

<ul>
<li>更新，後來測試不管是沒有<code>static</code>，把<code>static</code>改成<code>volatile</code>，都出現第一次燒錄行為不正常，多燒幾次又正常的情況。需要再重新釐清。</li>
</ul>


<p><a name="STM_LED_VERIFY"></a></p>

<h3>燒錄和測試</h3>

<ul>
<li>直接在工作目錄下執行make</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>STM32F429-Discovery-Disco-Pratice/labs/0_led$ make
</span><span class='line'>arm-none-eabi-gcc -c -DUSE_FULL_ASSERT -g3 -mthumb -mcpu=cortex-m4 -I. -I../../libraries/STM32F4xx_DSP_StdPeriph_Lib_V1.6.1/Libraries/STM32F4xx_StdPeriph_Driver/inc -I../../libraries/
</span><span class='line'>...
</span><span class='line'>arm-none-eabi-objcopy -Obinary ../../build/led.elf ../../build/led.bin
</span><span class='line'>arm-none-eabi-objdump -S ../../build/led.elf &gt; ../../build/led.list
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>燒錄指令如下</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>STM32F429-Discovery-Disco-Pratice/labs/0_led$ st-flash write ../../build/led.bin  0x8000000
</span><span class='line'>2016-07-25T11:31:28 INFO src/stlink-common.c: Loading device parameters....
</span><span class='line'>2016-07-25T11:31:28 INFO src/stlink-common.c: Device connected is: F42x and F43x device, id 0x10036419
</span><span class='line'>...
</span><span class='line'>enabling 32-bit flash writes
</span><span class='line'>size: 11596
</span><span class='line'>2016-07-25T11:31:28 INFO src/stlink-common.c: Starting verification of write complete
</span><span class='line'>2016-07-25T11:31:29 INFO src/stlink-common.c: Flash written and verified! jolly good!
</span></code></pre></td></tr></table></div></figure>


<p>以下是LED點亮結果</p>

<center><img src="/files/stm32/STM_LED.jpg"></img></center>


<p><a name="STM-SPL-REF"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://homes.soic.indiana.edu/geobrown/index.cgi/teaching">Geoffrey Brown: Teaching </a>

<ul>
<li>請找 Lab Manual 裏面的link, 書名是<code>Discovering the STM32 Microcontroller</code></li>
</ul>
</li>
<li><a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits/32f429idiscovery.html">STM32F4 Discovry Disco 開發版手冊</a></li>
<li><a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32065.html">STM32F4 DSP and standard peripherals library</a></li>
<li><a href="http://regalis.com.pl/en/arm-cortex-stm32-gnulinux/">Programming ARM Cortex (STM32) under GNU/Linux</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/25/stm32-f4xx-standard-peripherals-libraryshou-ce-zheng-li/">ARM CM4 Pratice (1): STM32 F4xx Standard Peripherals Library手冊整理</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-25T14:03:46+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>2:03 pm</span></time>
        
           | <a href="/blog/2016/06/25/stm32-f4xx-standard-peripherals-libraryshou-ce-zheng-li/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/06/25/stm32-f4xx-standard-peripherals-libraryshou-ce-zheng-li/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p>以前在寫作業的時候，從來沒有想過那些週邊到底怎麼使用，只大概印象和<a href="http://www.arm.com/products/processors/cortex-m/cortex-microcontroller-software-interface-standard.php">CMSIS</a>有關。後來想應該是要去了解到底這些廠商提供的函式庫在軟體開發中扮演了什麼樣的角色？因此花了時間整理如下。</p>

<p>在使用之前，請自行到<a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32065.html">官方網站</a>下載STM32F4 DSP and standard peripherals library。</p>

<h2>目錄</h2>

<ul>
<li><a href="#AST-%E7%B0%A1%E4%BB%8B">簡介</a>

<ul>
<li><a href="#AST-CMSIS">CMSIS和Standard Peripherals Library說明</a></li>
</ul>
</li>
<li><a href="#AST-Rules">Coding rules and conventions</a>

<ul>
<li><a href="#AST-Rules-general">一般命名規則</a></li>
<li><a href="#AST-Rules-reg">週邊 Register 命名規則</a></li>
</ul>
</li>
<li><a href="#AST-Ref">參考資料</a></li>
</ul>


<p><a name="AST-簡介"></a></p>

<h2>簡介</h2>

<p>手冊上提到Standard Peripherals Library (以下簡稱SPL)的特點</p>

<ul>
<li>提供STM32F4 XX的週邊驅動程式和常用的資料結構</li>
<li>基於CMSIS開發</li>
<li>ANSI C開發</li>
<li>使用SPL表示週邊設備存取效能和佔用的記憶體空間是由SPL決定，因此有特別限制的話必須要自行最佳化或是實作</li>
</ul>


<p>SPL包含:</p>

<ul>
<li>週邊設備暫存器的位址mapping，包含這些暫存器的bit</li>
<li>所有週邊的控制function以及對應的資料結構</li>
<li>範例程式</li>
</ul>


<p><a name="AST-CMSIS"></a></p>

<h3>CMSIS和Standard Peripherals Library說明</h3>

<p>整體的架構圖如下(參考手冊資料）</p>

<center><img src="/files/stm32/SPL_Diag.jpg"></img></center>


<p>簡單說明如下</p>

<ul>
<li>CMSIS 提供了

<ul>
<li>統一的暫存器定義、位址定義</li>
<li>協助開發的函數</li>
<li>RTOS 介面</li>
<li>DSP 相關函數</li>
</ul>
</li>
<li>開發版上實體的週邊驅動程式是透過SPL和CMSIS來控制硬體</li>
</ul>


<p><a name="AST-Rules"></a></p>

<h2>Coding rules and conventions</h2>

<p><a name="AST-Rules-general"></a></p>

<h3>一般命名規則</h3>

<ul>
<li>函數名稱以<strong>大寫週邊簡寫</strong>為prefix如<code>USART_SendData</code></li>
<li>文件舉例的API，請自行望文生義

<ul>
<li><code>週邊名稱_Init</code></li>
<li><code>週邊名稱_DeInit</code></li>
<li><code>週邊名稱_StructInit</code></li>
<li><code>週邊名稱_Cmd</code></li>
<li><code>週邊名稱_ITConfig</code>

<ul>
<li>IT: interrupt</li>
</ul>
</li>
<li><code>週邊名稱_DMAConfig</code></li>
<li><code>週邊名稱_XXXConfig</code>

<ul>
<li>週邊設備的XXX設定</li>
</ul>
</li>
<li><code>週邊名稱_GetFlagStatus</code></li>
<li><code>週邊名稱_ClearFlag</code></li>
<li><code>週邊名稱_ClearITPendingBit</code></li>
</ul>
</li>
</ul>


<p><a name="AST-Rules-reg"></a></p>

<h3>週邊 Register 命名規則</h3>

<ul>
<li>週邊 Register 一律包裝在<code>struct</code>中，名稱一律為大寫。在 stm32f4xx.h 另外已經宣告了週邊設備位址的結構如：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define SPI1                  ((SPI_TypeDef *) SPI1_BASE)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>SPI_TypeDef</code>為一個struct，因此你可以使用下面方式直接存取週邊設備暫存器。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SPI1</span><span class="o">-&gt;</span><span class="n">CR1</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>有了大概概念後，接下來就是開幹時間，敬請期待。</p>

<p><a name="AST-Ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32065.html">STM32F4 DSP and standard peripherals library</a>

<ul>
<li>本篇絕大部分參考解開套件後的stm32f4xx_dsp_stdperiph_lib_um.chm　這個文件檔案</li>
</ul>
</li>
<li><a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32cube-embedded-software/stm32cubef4.html">STM32CubeF4網頁</a>

<ul>
<li>有SPL的相關資料</li>
</ul>
</li>
<li><a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32062.html">STM32F2 standard peripherals library手冊</a>

<ul>
<li>交叉比對用</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/10/use-strace-to-trace-missing-files/">使用strace找出程式缺少的檔案路徑</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-10T01:14:38+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>1:14 am</span></time>
        
           | <a href="/blog/2016/04/10/use-strace-to-trace-missing-files/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/04/10/use-strace-to-trace-missing-files/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這算極短篇。在組裝別人軟體的時候，常常出現缺少檔案的錯誤，運氣不好的不會跟你說缺少的檔案的期待路徑；運氣更差的就會連錯誤都不印，直接程式crash。我後來知道strace之後，才發覺它可以結省很多印log和trace程式碼的時間。</p>

<p>這次就以前一篇執行openocd遇到的問題為例：第一次編譯openocd後，直接執行會出現找不到openocd.cfg檔案。經過一些試誤後才有上一篇整理出來的指令。</p>

<p>錯誤訊息如下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openocd 
</span><span class='line'>Open On-Chip Debugger 0.10.0-dev-00250-g9c37747 (2016-04-07-22:20)
</span><span class='line'>Licensed under GNU GPL v2
</span><span class='line'>For bug reports, read
</span><span class='line'>  http://openocd.org/doc/doxygen/bugs.html
</span><span class='line'>embedded:startup.tcl:60: Error: Can't find openocd.cfg
</span><span class='line'>in procedure 'script' 
</span><span class='line'>at file "embedded:startup.tcl", line 60
</span><span class='line'>Error: Debug Adapter has to be specified, see "interface" command
</span><span class='line'>embedded:startup.tcl:60: Error: 
</span><span class='line'>in procedure 'script' 
</span><span class='line'>at file "embedded:startup.tcl", line 60</span></code></pre></td></tr></table></div></figure>


<p>用strace 觀察輸出訊息如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ strace -f openocd 2&gt;&1  | grep cfg
</span><span class='line'>open("openocd.cfg", O_RDONLY)           = -1 ENOENT (No such file or directory)
</span><span class='line'>open("/home/asdf/.openocd/openocd.cfg", O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>open("/usr/local/share/openocd/site/openocd.cfg", O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>open("/usr/local/share/openocd/scripts/openocd.cfg", O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>write(2, "embedded:startup.tcl:60: Error: "..., 118embedded:startup.tcl:60: Error: Can't find openocd.cfg</span></code></pre></td></tr></table></div></figure>


<p>從輸出訊息可以知道，openocd會依下面的順序讀取openocd.cfg</p>

<ul>
<li>目前目錄的openocd.cfg</li>
<li>~/.openocd/openocd.cfg</li>
<li>/usr/local/share/openocd/site/openocd.cfg</li>
<li>/usr/local/share/openocd/scripts/openocd.cfg</li>
</ul>


<p>所以接下來就是在openocd的原始碼中挑和你開發target可以使用config 檔案，放入~/.openocd、改成openocd.cfg。當然事情沒那麼簡單，解掉這個問題接下來還會有一些缺少檔案的問題，一樣靠strace就可以搞定。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/06/arm-cm4-pratice-0-environment-setup/">ARM CM4 Pratice (0): Environment Setup</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-06T22:15:15+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:15 pm</span></time>
        
           | <a href="/blog/2016/04/06/arm-cm4-pratice-0-environment-setup/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/04/06/arm-cm4-pratice-0-environment-setup/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>很久以前買了<a href="http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/PF259090">STM32F4 Disco的開發版</a>（<a href="http://wiki.csie.ncku.edu.tw/embedded/STM32F429">繁體中文資訊</a>），最近開始想要學習ARM架構和硬體控制等技術。在設定目標，規劃進度前，一定要先把編譯和燒錄環境架設起來，整理如下：</p>

<h2>目錄</h2>

<ul>
<li><a href="#cm4-0-env">安裝作業系統環境</a></li>
<li><a href="#cm4-0-steps">安裝步驟</a>

<ul>
<li><a href="#cm4-0-steps-tl">安裝Toolchain</a></li>
<li><a href="#cm4-0-steps-pkg-install">手動安裝燒錄和除錯工具</a>

<ul>
<li><a href="#cm4-0-steps-pkg-install-prepare">安裝需要套件</a></li>
<li><a href="#cm4-0-steps-pkg-install-stlink">手動安裝st-link</a></li>
<li><a href="#cm4-0-steps-pkg-install-openocd">手動安裝OpenOCD</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cm4-0-test">驗證燒錄</a>

<ul>
<li><a href="#cm4-0-test-prepare">事前準備</a></li>
<li><a href="#cm4-0-test-stflash">使用st-flash 開發版燒錄</a></li>
<li><a href="#cm4-0-test-openocd">使用openocd 開發版燒錄</a></li>
</ul>
</li>
<li><a href="#cm4-0-ref">參考資料</a></li>
</ul>


<p><a name="cm4-0-env"></a></p>

<h2>安裝作業系統環境</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.4 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty</span></code></pre></td></tr></table></div></figure>


<p><a name="cm4-0-steps"></a></p>

<h2>安裝步驟</h2>

<p>要開發非本機的平台，我們會需要安裝</p>

<ul>
<li>Toolchain：提供編譯，函數，分析binary等功能</li>
<li>燒錄軟體</li>
<li>除錯工具</li>
</ul>


<p>st-link和openocd同時有燒錄和開發版軟體除錯的功能，因此我們兩個都安裝。</p>

<p><a name="cm4-0-steps-tl"></a></p>

<h3>安裝Toolchain</h3>

<p>網路上找到<a href="https://launchpad.net/gcc-arm-embedded">GCC ARM Embedded (ARM R和M系列使用 )</a>的PPA。簡單找一下網路，<strong><font color="red">沒有直接證據說這邊的PPA是由ARM官方維護</font></strong>。不過在<a href="http://yottadocs.mbed.com/#installing-on-linux">mbed(ARM 成立的IoT作業系統)網站裏面</a>的確有提到這個PPA，暫時當作間接證據。<strong><font color="red">目前我還沒有驗證這個Toolchain編譯出來的binary是否可以在開發版上正常動作</font></strong>。</p>

<figure class='code'><figcaption><span>安裝Toolchain指令</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sudo add-apt-repository ppa:team-gcc-arm-embedded/ppa
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install gcc-arm-embedded
</span></code></pre></td></tr></table></div></figure>


<p><a name="cm4-0-steps-pkg-install"></a></p>

<h3>手動安裝燒錄和除錯工具</h3>

<p><a name="cm4-0-steps-pkg-install-prepare"></a></p>

<h4>安裝需要套件</h4>

<figure class='code'><figcaption><span>系統安裝設定STM32F4環境相關套件 </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sudo apt-get install git
</span><span class='line'>sudo apt-get install libtool
</span><span class='line'>sudo apt-get install automake
</span><span class='line'>sudo apt-get install autoconf
</span><span class='line'>sudo apt-get install pkg-config
</span><span class='line'>sudo apt-get install libusb-1.0-0-dev
</span><span class='line'>sudo apt-get install libftdi-dev   # 當openocd要支援MPSSE mode才需要裝，這是啥我不知道。
</span><span class='line'>sudo apt-get install libhidapi-dev # 當openocd要支援CMSIS-DAP才會用到，這是啥我不知道。
</span></code></pre></td></tr></table></div></figure>


<p>我自己的習慣是非必要不會放在系統中，<strong>接下來的指令都是預設<code>st-link</code>和<code>openocd</code>裝到<code>$HOME/bin</code>中</strong>，Ubuntu在登入時會自動將<code>~/bin</code>加入<code>PATH</code>中。</p>

<p>如果您沒有~/bin的話，請使用下面指令建立。</p>

<figure class='code'><figcaption><span>系統安裝設定STM32F4環境相關套件 </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>mkdir ~/bin/
</span><span class='line'>. ~/.profile # 強迫系統自動將`~/bin`加入`PATH`中
</span></code></pre></td></tr></table></div></figure>


<p><a name="cm4-0-steps-pkg-install-stlink"></a></p>

<h4>手動安裝st-link</h4>

<p>簡單講一下，就是下載、編譯、安裝軟體。特別要注意的是，為了要讓你的PC在使用Mini USB連到開發版後能夠讓Ubuntu的<code>udev</code>服務可以順利地偵測到開發版，需要加入相關設定並重新啟動<code>udev</code>服務。</p>

<p>下載Source code</p>

<figure class='code'><figcaption><span>下載Source code  </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>git clone https://github.com/texane/stlink
</span></code></pre></td></tr></table></div></figure>


<p>編譯stlink</p>

<figure class='code'><figcaption><span>編譯</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>cd stlink/
</span><span class='line'>./autogen.sh
</span><span class='line'>./configure
</span><span class='line'>make
</span><span class='line'>cp st-* ~/bin
</span></code></pre></td></tr></table></div></figure>


<p>設定並重新起動udev</p>

<figure class='code'><figcaption><span>設定並重新起動udev</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sudo cp 49-stlinkv* /etc/udev/rules.d/ -rv
</span><span class='line'>sudo service udev restart
</span></code></pre></td></tr></table></div></figure>


<p>驗證一下是否可以偵測到開發版，請確定測試前開發版已經和您的電腦透過Mini USB連線，以及有設定<code>udev</code>並且重新啟動。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ st-probe
</span><span class='line'>Found 1 stlink programmers
</span><span class='line'>30303030303030303030303100
</span><span class='line'>   flash: 2097152 (pagesize: 16384)
</span><span class='line'>    sram: 262144
</span><span class='line'>  chipid: 0x0419
</span><span class='line'>   descr: F42x and F43x device
</span></code></pre></td></tr></table></div></figure>


<p><a name="cm4-0-steps-pkg-install-openocd"></a></p>

<h4>手動安裝OpenOCD</h4>

<p>下載Source code</p>

<figure class='code'><figcaption><span>下載Source code</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>git clone git://git.code.sf.net/p/openocd/code openocd-code
</span></code></pre></td></tr></table></div></figure>


<p>編譯</p>

<figure class='code'><figcaption><span>編譯</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>cd openocd-code/
</span><span class='line'>./bootstrap
</span><span class='line'>./configure # script會自動偵測系統是否有相依開發套件
</span><span class='line'>make
</span></code></pre></td></tr></table></div></figure>


<p>安裝</p>

<figure class='code'><figcaption><span>安裝</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>cp src/openocd ~/bin
</span><span class='line'>cp tcl/board/stm32f429discovery.cfg ~/.openocd/openocd.cfg
</span><span class='line'>cp tcl/* ~/.openocd
</span></code></pre></td></tr></table></div></figure>


<p>驗證一下是否可以偵測到開發版，請確定測試前開發版已經和您的電腦透過Mini USB連線。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ openocd
</span><span class='line'>Open On-Chip Debugger 0.10.0-dev-00250-g9c37747 (2016-04-07-22:20)
</span><span class='line'>Licensed under GNU GPL v2
</span><span class='line'>For bug reports, read
</span><span class='line'>  http://openocd.org/doc/doxygen/bugs.html
</span><span class='line'>Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
</span><span class='line'>adapter speed: 2000 kHz
</span><span class='line'>adapter_nsrst_delay: 100
</span><span class='line'>none separate
</span><span class='line'>srst_only separate srst_nogate srst_open_drain connect_deassert_srst
</span><span class='line'>Info : Unable to match requested speed 2000 kHz, using 1800 kHz
</span><span class='line'>Info : Unable to match requested speed 2000 kHz, using 1800 kHz
</span><span class='line'>Info : clock speed 1800 kHz
</span><span class='line'>Info : STLINK v2 JTAG v17 API v2 SWIM v0 VID 0x0483 PID 0x3748
</span><span class='line'>Info : using stlink api v2
</span><span class='line'>Info : Target voltage: 2.862887
</span><span class='line'>Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints
</span></code></pre></td></tr></table></div></figure>


<p><a name="cm4-0-test"></a></p>

<h2>驗證燒錄</h2>

<p><a name="cm4-0-test-parepare"></a></p>

<h3>事前準備</h3>

<p>下載jserv整理的STM 軔體</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>git clone https://github.com/jserv/stm32f429-demos
</span></code></pre></td></tr></table></div></figure>


<p>將source中的hex轉成binary</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>cd stm32f429-demos/
</span><span class='line'>make
</span></code></pre></td></tr></table></div></figure>


<p>使用下載提供的Makefile燒錄，裏面會先用openocd燒錄，失敗的話自動切到st-flash燒錄，非常建議讀一下Makefile。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>make flash-demo檔案
</span></code></pre></td></tr></table></div></figure>


<p>目前套件內蒐集的demo檔案</p>

<ul>
<li>flash-GamesInJava</li>
<li>flash-STM32F429I-DISCOVERY_Demo_V1.0.1</li>
<li>flash-Paint</li>
<li>flash-TouchGFX-demo2014</li>
<li>flash-STM32CubeDemo_STM32F429I-Discovery</li>
</ul>


<p><a name="cm4-0-test-stflash"></a></p>

<h3>使用st-flash 開發版燒錄</h3>

<ul>
<li><code>st-flash write 軔體binary檔案名稱 0x8000000</code></li>
</ul>


<p>為什麼是<code>0x800000</code>呢？可以查一下<a href="http://www.st.com/web/en/resource/technical/document/datasheet/DM00071990.pdf">手冊</a>，上面有說這塊記憶體是分配給flash memory。</p>

<p><a name="cm4-0-test-openocd"></a></p>

<h4>使用openocd 開發版燒錄</h4>

<p>從<a href="https://github.com/jserv/stm32f429-demos">GitHub: jserv/stm32f429-demos</a>裏面的Makefile抄來的。指令比較長，不過這是因為openocd可以把一系列的命令連發的關係</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>openocd -f interface/stlink-v2.cfg  -f target/stm32f4x.cfg  -c &quot;init&quot;  -c &quot;reset init&quot;  -c &quot;stm32f2x unlock 0&quot;  -c &quot;flash probe 0&quot;  -c &quot;flash info 0&quot;  -c &quot;flash write_image erase 軔體binary檔案名稱 0x8000000&quot;  -c &quot;reset run&quot; -c shutdown
</span></code></pre></td></tr></table></div></figure>


<p>使用比較好看的排版</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>openocd -f interface/stlink-v2.cfg  \
</span><span class='line'>        -f target/stm32f4x.cfg      \
</span><span class='line'>        -c &quot;init&quot;                   \
</span><span class='line'>        -c &quot;reset init&quot;             \
</span><span class='line'>        -c &quot;stm32f2x unlock 0&quot;      \
</span><span class='line'>        -c &quot;flash probe 0&quot;          \
</span><span class='line'>        -c &quot;flash info 0&quot;           \
</span><span class='line'>        -c &quot;flash write_image erase 軔體binary檔案名稱 0x8000000&quot; \
</span><span class='line'>        -c &quot;reset run&quot; -c shutdown
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>參數說明</h4>

<ul>
<li><code>-f</code>

<ul>
<li>指定config檔案。你可能會想問說interface目錄在那邊，還記得<a href="cm4-0-steps-pkg-install-openocd">前面</a>的動作嘛？</li>
<li>可以指定

<ul>
<li>interface: 除錯使用的介面</li>
<li>target: 執行的平台CPU如STM32F4</li>
<li>board: 開發版</li>
</ul>
</li>
</ul>
</li>
<li><code>-c</code>

<ul>
<li>執行openocd指令</li>
</ul>
</li>
</ul>


<h4>指令說明</h4>

<ul>
<li><code>-f interface/stlink-v2.cfg</code></li>
<li><code>-f target/stm32f4x.cfg</code></li>
<li><code>-c "init"</code>

<ul>
<li>結束config stage，開始進入run stage (<a href="http://openocd.org/doc/html/Daemon-Configuration.html#Entering-the-Run-Stage">出處</a>)</li>
</ul>
</li>
<li><code>-c "reset init"</code>

<ul>
<li>reset 開發版，重新開機(<a href="http://openocd.org/doc/html/General-Commands.html#Target-State-handling">出處</a>)後進入init狀態。</li>
</ul>
</li>
<li><code>-c "stm32f2x unlock 0"</code>

<ul>
<li>將開發版的flash解鎖(<a href="http://openocd.org/doc/html/Flash-Commands.html#Flash-Configuration-Commands">出處</a>)</li>
</ul>
</li>
<li><code>-c "flash probe 0"</code>

<ul>
<li>偵測開發版的flash(<a href="http://openocd.org/doc/html/Flash-Commands.html#Flash-Configuration-Commands">出處</a>)</li>
</ul>
</li>
<li><code>-c "flash info 0"</code>

<ul>
<li>顯示開發版的flash資訊(<a href="http://openocd.org/doc/html/Flash-Commands.html#Flash-Configuration-Commands">出處</a>)</li>
</ul>
</li>
<li><code>-c "flash write_image erase 軔體binary檔案名稱 0x8000000"</code>

<ul>
<li>將檔案寫入flash(<a href="http://openocd.org/doc/html/Flash-Commands.html#Flash-Configuration-Commands">出處</a>)</li>
</ul>
</li>
<li><code>-c "reset run" -c shutdown</code>

<ul>
<li>正常重新開機(<a href="http://openocd.org/doc/html/General-Commands.html#Target-State-handling">出處</a>)</li>
</ul>
</li>
</ul>


<p><a name="cm4-0-ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://yottadocs.mbed.com/#installing-on-linux">yotta Documentation: Install on Linux</a></li>
<li><a href="https://launchpad.net/gcc-arm-embedded">ARM Embedded PPA網站</a></li>
<li><a href="https://launchpad.net/~team-gcc-arm-embedded/+archive/ubuntu/ppa">GNU ARM Embedded Toolchain</a></li>
<li><a href="https://github.com/jserv/stm32f429-demos">GitHub: jserv/stm32f429-demos</a></li>
<li><a href="http://openocd.org/doc/html/">OpenOCD手冊</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/24/talk-more-about-git-remote/">再談 Git Remote</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-24T20:30:32+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:30 pm</span></time>
        
           | <a href="/blog/2016/01/24/talk-more-about-git-remote/#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io/blog/2016/01/24/talk-more-about-git-remote/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li>更新：

<ul>
<li>Apr/09/2016：感謝網友柏瑀的告知，修正白字。</li>
</ul>
</li>
</ul>


<p>git remote 是一個常常被忽略的東西，這次就來看看這個指令和對應的觀念吧。</p>

<p>一樣，先講測試環境，避免無法reproduce的問題。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.3 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span><span class='line'>
</span><span class='line'>$ git --version
</span><span class='line'>git version 2.7.0
</span></code></pre></td></tr></table></div></figure>


<p>本次介紹目錄如下</p>

<ul>
<li><a href="#gr_gb">背景說明</a></li>
<li><a href="#gr_cmd">git remote指令介紹</a>

<ul>
<li><a href="#gr_cmd_status">查詢remote資訊</a></li>
<li><a href="#gr_cmd_add">新增remote</a></li>
<li><a href="#gr_cmd_fetch">拉remote repository</a></li>
<li><a href="#gr_cmd_push">remote的branch操作</a></li>
<li><a href="#gr_cmd_rm">刪除remote</a></li>
</ul>
</li>
</ul>


<p><a name="gr_gb"></a></p>

<h2>背景說明</h2>

<p>先來問問男人<code>git remote</code>是什麼吧？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>GIT-REMOTE(1)                                     Git Manual                                    GIT-REMOTE(1)
</span><span class='line'>
</span><span class='line'>NAME
</span><span class='line'>       git-remote - Manage set of tracked repositories
</span></code></pre></td></tr></table></div></figure>


<p>白話來說，<code>git remote</code>是用來管理<font color="red">多個</font>tracked repositories。（中文難翻，意思是你要追蹤的git repository）。在大部分的情況，<code>git clone</code>下來後只需要和原本clone的遠端互動的話，你只有一個remote，那麼你機乎不會感受到remote的運作，我天生駑鈍，剛開始只是覺得奇怪怎麼有時候後會有個<code>origin</code>跑出來而已。</p>

<p>如果夠幸運（還是不幸？）你不太會需要遇到需要處理remote的情況。不過在github上面，倒是蠻有機會要用到remote，情境如下。</p>

<ul>
<li>你在github上面有帳號，要fork別人的project <code>A</code>，fork來的稱為<code>A+</code></li>
<li>你在<code>A+</code>開發，同時<code>A</code>也在開發</li>
<li><code>A+</code>有需要和<code>A</code>同步，也許是<code>A</code>有新功能，或是你要回饋程式碼總不能回饋和<code>A</code>差異太大的程式碼</li>
</ul>


<p><code>A+</code>和<code>A</code>同步，是remote常用的情境。常用到github直接給<a href="https://help.github.com/articles/configuring-a-remote-for-a-fork/">懶人包</a>。大概描述如下：</p>

<ul>
<li><code>A+</code>加一個remote，URL為<code>A</code>的URL。白話來說，就是<code>A+</code>要track repository <code>A</code>。

<ul>
<li>remote必須給個名字，github的<a href="https://help.github.com/articles/configuring-a-remote-for-a-fork/">懶人包</a>上給的名字叫upstream。</li>
</ul>
</li>
<li>既然加了一個tracked repository，你就可以做

<ul>
<li>拉remote程式碼下來</li>
<li>切換到remote下面的branch</li>
<li><strong>merge remote 的branch</strong></li>
</ul>
</li>
</ul>


<p><a name="gr_cmd"></a></p>

<h2>git remote指令介紹</h2>

<p>在介紹指令之前，先建立示範git repository 以便下面的說明。情境如下</p>

<ol>
<li>建立新的git repository，稱為<code>repo_1</code></li>
<li>clone <code>repo_1</code>到<code>repo_2</code></li>
<li>clone <code>repo_2</code>到<code>repo_3</code></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git init repo_1
</span><span class='line'>Initialized empty Git repository in /tmp/test_remote/repo_1/.git/
</span><span class='line'>
</span><span class='line'>$ cd repo_1/
</span><span class='line'>/repo_1$ touch test_file &amp;&amp; git add test_file &amp;&amp; git commit -a -m &quot;init for test&quot;
</span><span class='line'>[master (root-commit) 6847c3c] init for test
</span><span class='line'> 1 file changed, 0 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 test_file
</span><span class='line'>
</span><span class='line'>$ cd ../
</span><span class='line'>
</span><span class='line'>$ git clone --bare repo_1 repo_2
</span><span class='line'>Cloning into bare repository &#39;repo_2&#39;...
</span><span class='line'>done.
</span><span class='line'>
</span><span class='line'>$ git clone repo_2/ repo_3
</span><span class='line'>Cloning into &#39;repo_3&#39;...
</span><span class='line'>done.
</span></code></pre></td></tr></table></div></figure>


<p>關於repo_2的&ndash;bare部份，一言難盡。長話短說，不這樣幹repo_3不能push到repo_2，有興趣可以看<a href="http://stackoverflow.com/questions/2816369/git-push-error-remote-rejected-master-master-branch-is-currently-checked">這邊</a>。</p>

<p>如果你的git repository是clone過來的，一定會有一個預設remote。沒意外的會叫<code>origin</code> <del>(什麼？你的remote叫<code>aosp</code>? 呃太複雜不討論)</del>，接下來你可以對於remote 操作，分別說明如下：</p>

<ul>
<li><a href="#gr_cmd_status">查詢remote資訊</a></li>
<li><a href="#gr_cmd_add">新增remote</a></li>
<li><a href="#gr_cmd_fetch">拉remote repository</a></li>
<li><a href="#gr_cmd_push">remote的branch操作</a></li>
<li><a href="#gr_cmd_rm">刪除remote</a></li>
</ul>


<p><a name="gr_cmd_status"></a></p>

<h2>查詢remote資訊</h2>

<ul>
<li><code>git remote</code>

<ul>
<li>顯示remote名稱</li>
</ul>
</li>
<li><code>git remote -v</code>

<ul>
<li>顯示remote名稱及remote URL</li>
</ul>
</li>
<li><code>git remote show remote名稱</code>

<ul>
<li>顯示<code>remote名稱</code>的詳細資訊</li>
</ul>
</li>
</ul>


<p>直接看範例</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ cd /tmp/test_remote/repo_3
</span><span class='line'>
</span><span class='line'>$ git remote
</span><span class='line'>origin
</span><span class='line'>
</span><span class='line'>$ git remote -v
</span><span class='line'>origin    /tmp/test_remote/repo_2/ (fetch)
</span><span class='line'>origin    /tmp/test_remote/repo_2/ (push)
</span><span class='line'>
</span><span class='line'>$ git remote show origin
</span><span class='line'>* remote origin
</span><span class='line'>  Fetch URL: /tmp/test_remote/repo_2/
</span><span class='line'>  Push  URL: /tmp/test_remote/repo_2/
</span><span class='line'>  HEAD branch: master
</span><span class='line'>  Remote branch:
</span><span class='line'>    master tracked
</span><span class='line'>  Local branch configured for &#39;git pull&#39;:
</span><span class='line'>    master merges with remote master
</span><span class='line'>  Local ref configured for &#39;git push&#39;:
</span><span class='line'>    master pushes to master (up to date)
</span></code></pre></td></tr></table></div></figure>


<p><a name="gr_cmd_add"></a></p>

<h2>新增remote</h2>

<ul>
<li><code>git add remote名稱 remote_repository_URL</code></li>
</ul>


<p>範例如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git remote add upstream /tmp/test_remote/repo_1/
</span><span class='line'>
</span><span class='line'>$ git remote -v
</span><span class='line'>origin    /tmp/test_remote/repo_2/ (fetch)
</span><span class='line'>origin    /tmp/test_remote/repo_2/ (push)
</span><span class='line'>upstream  /tmp/test_remote/repo_1/ (fetch)
</span><span class='line'>upstream  /tmp/test_remote/repo_1/ (push)
</span></code></pre></td></tr></table></div></figure>


<p>新增完畢後，請記得<code>remote_名稱</code>、<code>remote_名稱 remote_branch_名稱</code>或<code>remote_名稱/remote_branch_名稱</code>是你要操作remote的參數。</p>

<p>另外你還可以加入多個remote來場大亂鬥。例如你從<code>A</code> fork <code>A+</code>，也許有人fork 出來的<code>A++</code>有你想要的功能，就可以再把<code>A++</code>加入你<code>A</code> repository的remote。</p>

<p><a name="gr_cmd_fetch"></a></p>

<h2>拉remote repository</h2>

<ul>
<li><code>git fetch remote_名稱</code></li>
<li><code>git pull remote_名稱/remote_branch_名稱</code></li>
</ul>


<p>我們先在<code>repo_1</code>開一個branch稱為<code>br1</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ cd /tmp/test_remote/repo_1/
</span><span class='line'>
</span><span class='line'>$ git checkout -b br1
</span><span class='line'>Switched to a new branch &#39;br1&#39;
</span><span class='line'>
</span><span class='line'>$ touch test_on_branch &amp;&amp; git add test_on_branch &amp;&amp; git commit test_on_branch -m &quot;test&quot;
</span><span class='line'>[br1 cc7222f] test
</span><span class='line'> 1 file changed, 0 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 test_on_branch
</span></code></pre></td></tr></table></div></figure>


<p>接下來就是範例時間</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git fetch upstream
</span><span class='line'>From /tmp/test_remote/repo_1
</span><span class='line'> * [new branch]      br1        -&gt; upstream/br1
</span><span class='line'> * [new branch]      master     -&gt; upstream/master
</span><span class='line'>
</span><span class='line'>$ ls
</span><span class='line'>test_file
</span><span class='line'>
</span><span class='line'>$ git pull upstream br1
</span><span class='line'>From /tmp/test_remote/repo_1
</span><span class='line'> * branch            br1        -&gt; FETCH_HEAD
</span><span class='line'>Updating 6847c3c..cc7222f
</span><span class='line'>Fast-forward
</span><span class='line'> test_on_branch | 0
</span><span class='line'> 1 file changed, 0 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 test_on_branch
</span><span class='line'>
</span><span class='line'>$ ls
</span><span class='line'>test_file  test_on_branch
</span><span class='line'>
</span><span class='line'>$ git status
</span><span class='line'>On branch master
</span><span class='line'>Your branch is ahead of &#39;origin/master&#39; by 1 commit.
</span><span class='line'>  (use &quot;git push&quot; to publish your local commits)
</span><span class='line'>nothing to commit, working directory clean
</span></code></pre></td></tr></table></div></figure>


<p>注意最後的指令，因為我們pull了<code>upstream/br1</code>，所以local多了一個commit。因此訊息中有說你目前repository 比<code>origin/master</code>(你clone的remote/branch)多一個commit。你可以push回<code>origin/master</code>。</p>

<p><a name="gr_cmd_push"></a></p>

<h2>remote的branch操作</h2>

<p>原則就是命令中有參數會是<code>remote_名稱</code>、<code>remote_名稱 remote_branch_名稱</code>或<code>remote_名稱/remote_branch_名稱</code>。</p>

<ul>
<li>切換</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git checkout upstream/br1
</span><span class='line'>Note: checking out &#39;upstream/br1&#39;.
</span><span class='line'>
</span><span class='line'>You are in &#39;detached HEAD&#39; state. You can look around, make experimental
</span><span class='line'>changes and commit them, and you can discard any commits you make in this
</span><span class='line'>state without impacting any branches by performing another checkout.
</span><span class='line'>
</span><span class='line'>If you want to create a new branch to retain commits you create, you may
</span><span class='line'>do so (now or later) by using -b with the checkout command again. Example:
</span><span class='line'>
</span><span class='line'>  git checkout -b &lt;new-branch-name&gt;
</span><span class='line'>
</span><span class='line'>HEAD is now at bd026e3... test
</span></code></pre></td></tr></table></div></figure>


<p>中間的一堆英文簡單來說是因為git checkout沒特別參數，git只是把HEAD指到命令中的hash而已。如果你要同時在local開一個branch，可以這樣幹：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git checkout --track  upstream/br1
</span><span class='line'>Branch br1 set up to track remote branch br1 from upstream.
</span><span class='line'>Switched to a new branch &#39;br1&#39;
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>merge</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># 先在upstream/br1建立新的commit
</span><span class='line'>$ cd /tmp/test_remote/repo_1/
</span><span class='line'>
</span><span class='line'>$ touch test1_on_branch &amp;&amp; git add test1_on_branch &amp;&amp; git commit test1_on_branch -m &quot;test1&quot;
</span><span class='line'>[br1 d82612a] test1
</span><span class='line'> 1 file changed, 0 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 test1_on_branch
</span><span class='line'>
</span><span class='line'># 切回repo_3
</span><span class='line'>cd /tmp/test_remote/repo_3
</span><span class='line'>
</span><span class='line'># 先fetch
</span><span class='line'>$ git fetch upstream
</span><span class='line'>remote: Counting objects: 2, done.
</span><span class='line'>remote: Compressing objects: 100% (2/2), done.
</span><span class='line'>remote: Total 2 (delta 0), reused 0 (delta 0)
</span><span class='line'>Unpacking objects: 100% (2/2), done.
</span><span class='line'>From /tmp/test_remote/repo_1
</span><span class='line'>   bd026e3..d82612a  br1        -&gt; upstream/br1
</span><span class='line'>
</span><span class='line'># 再merge，事實上和git pull upstream br1 一樣效果（默）
</span><span class='line'>$ git merge upstream/br1
</span><span class='line'>Updating bd026e3..d82612a
</span><span class='line'>Fast-forward
</span><span class='line'> test1_on_branch | 0
</span><span class='line'> 1 file changed, 0 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 test1_on_branch
</span></code></pre></td></tr></table></div></figure>


<p><a name="gr_cmd_rm"></a></p>

<h2>刪除remote</h2>

<ul>
<li>git remote remove remote名稱</li>
</ul>


<p>範例如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git remote remove upstream
</span><span class='line'>
</span><span class='line'>$ git remote -v
</span><span class='line'>origin    /tmp/test_remote/repo_2 (fetch)
</span><span class='line'>origin    /tmp/test_remote/repo_2 (push)
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/08/05/glibc-obj-file-symbols/">Glibc Obj File Symbols</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/04/hello-world-disassm/">Hello World 反組譯輸出</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/03/load-elf-binary-trace/">Load_elf_binary Trace</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/15/field-investigation-link-objs/">田野調查：Ubuntu 18.04.2 產生執行檔細節</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/08/glibc-build-observing/">觀察編譯glibc的產出</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Top Categories</h1>
    <ul id="top-category-list"><li><a href='/blog/categories/linux'>linux (46)</a></li><li><a href='/blog/categories/c'>c (38)</a></li><li><a href='/blog/categories/debian'>debian (16)</a></li><li><a href='/blog/categories/presentation'>presentation (14)</a></li><li><a href='/blog/categories/binutils'>binutils (14)</a></li><li><a href='/blog/categories/arm'>arm (12)</a></li><li><a href='/blog/categories/octopress'>octopress (9)</a></li><li><a href='/blog/categories/gan-xiang'>感想 (8)</a></li><li><a href='/blog/categories/make'>make (6)</a></li><li><a href='/blog/categories/glibc'>glibc (5)</a></li></ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/arm'>arm (12)</a></li><li><a href='/blog/categories/asm'>asm (1)</a></li><li><a href='/blog/categories/assembler'>assembler (2)</a></li><li><a href='/blog/categories/assembly'>assembly (3)</a></li><li><a href='/blog/categories/autotools'>autotools (4)</a></li><li><a href='/blog/categories/banana-pi'>banana pi (1)</a></li><li><a href='/blog/categories/bash'>bash (1)</a></li><li><a href='/blog/categories/binutil'>binutil (1)</a></li><li><a href='/blog/categories/binutils'>binutils (14)</a></li><li><a href='/blog/categories/buildroot'>buildroot (2)</a></li><li><a href='/blog/categories/c'>c (38)</a></li><li><a href='/blog/categories/c-preprocessor'>c preprocessor (1)</a></li><li><a href='/blog/categories/c99'>c99 (2)</a></li><li><a href='/blog/categories/cmake'>cmake (2)</a></li><li><a href='/blog/categories/cscope'>cscope (1)</a></li><li><a href='/blog/categories/ctags'>ctags (1)</a></li><li><a href='/blog/categories/dbdoclet'>dbdoclet (1)</a></li><li><a href='/blog/categories/debian'>debian (16)</a></li><li><a href='/blog/categories/debootstrap'>debootstrap (1)</a></li><li><a href='/blog/categories/debug'>debug (1)</a></li><li><a href='/blog/categories/doxygen'>doxygen (1)</a></li><li><a href='/blog/categories/elf'>elf (2)</a></li><li><a href='/blog/categories/f9'>f9 (1)</a></li><li><a href='/blog/categories/free-software'>free software (1)</a></li><li><a href='/blog/categories/freertos'>freertos (1)</a></li><li><a href='/blog/categories/fsf'>fsf (1)</a></li><li><a href='/blog/categories/gcc'>gcc (2)</a></li><li><a href='/blog/categories/gdb'>gdb (4)</a></li><li><a href='/blog/categories/getopt'>getopt (1)</a></li><li><a href='/blog/categories/gettext'>gettext (2)</a></li><li><a href='/blog/categories/git'>git (4)</a></li><li><a href='/blog/categories/git-remote'>git remote (2)</a></li><li><a href='/blog/categories/github-flavored-markdown'>github flavored markdown (1)</a></li><li><a href='/blog/categories/github-pages'>github pages (1)</a></li><li><a href='/blog/categories/glibc'>glibc (5)</a></li><li><a href='/blog/categories/gnu'>gnu (2)</a></li><li><a href='/blog/categories/gnu-as'>gnu as (1)</a></li><li><a href='/blog/categories/gpl'>gpl (1)</a></li><li><a href='/blog/categories/gstreamer'>gstreamer (1)</a></li><li><a href='/blog/categories/hole'>hole (1)</a></li><li><a href='/blog/categories/inline'>inline (1)</a></li><li><a href='/blog/categories/javadoc'>javadoc (2)</a></li><li><a href='/blog/categories/kernel'>kernel (2)</a></li><li><a href='/blog/categories/ld'>ld (1)</a></li><li><a href='/blog/categories/libtool'>libtool (2)</a></li><li><a href='/blog/categories/linker'>linker (2)</a></li><li><a href='/blog/categories/linker-script'>linker script (5)</a></li><li><a href='/blog/categories/linux'>linux (46)</a></li><li><a href='/blog/categories/linux-kernel'>linux kernel (3)</a></li><li><a href='/blog/categories/linux-utilities'>linux utilities (2)</a></li><li><a href='/blog/categories/live-cd'>live cd (1)</a></li><li><a href='/blog/categories/lseek'>lseek (1)</a></li><li><a href='/blog/categories/macro'>macro (1)</a></li><li><a href='/blog/categories/make'>make (6)</a></li><li><a href='/blog/categories/markdown'>markdown (2)</a></li><li><a href='/blog/categories/octopress'>octopress (9)</a></li><li><a href='/blog/categories/osm'>osm (1)</a></li><li><a href='/blog/categories/patch'>patch (1)</a></li><li><a href='/blog/categories/pbuilder'>pbuilder (2)</a></li><li><a href='/blog/categories/pomodoro-technique'>pomodoro technique (1)</a></li><li><a href='/blog/categories/presentation'>presentation (14)</a></li><li><a href='/blog/categories/python'>python (4)</a></li><li><a href='/blog/categories/qemu'>qemu (5)</a></li><li><a href='/blog/categories/quilt'>quilt (1)</a></li><li><a href='/blog/categories/regex'>regex (2)</a></li><li><a href='/blog/categories/rtenv'>rtenv (1)</a></li><li><a href='/blog/categories/rtos'>rtos (1)</a></li><li><a href='/blog/categories/semihosting'>semihosting (1)</a></li><li><a href='/blog/categories/shell-script'>shell script (4)</a></li><li><a href='/blog/categories/software-development'>software development (1)</a></li><li><a href='/blog/categories/stm32'>stm32 (5)</a></li><li><a href='/blog/categories/strip'>strip (1)</a></li><li><a href='/blog/categories/trace'>trace (1)</a></li><li><a href='/blog/categories/ubuntu'>ubuntu (1)</a></li><li><a href='/blog/categories/upnp'>upnp (1)</a></li><li><a href='/blog/categories/usb'>usb (1)</a></li><li><a href='/blog/categories/valgrind'>valgrind (2)</a></li><li><a href='/blog/categories/vim'>vim (5)</a></li><li><a href='/blog/categories/vim-plugin'>vim plugin (1)</a></li><li><a href='/blog/categories/virtualbox'>virtualbox (2)</a></li><li><a href='/blog/categories/vundle'>vundle (1)</a></li><li><a href='/blog/categories/wireless'>wireless (1)</a></li><li><a href='/blog/categories/wpa-supplicant'>wpa_supplicant (1)</a></li><li><a href='/blog/categories/tai-wan-xiao-chi'>台灣小吃 (1)</a></li><li><a href='/blog/categories/gan-xiang'>感想 (8)</a></li><li><a href='/blog/categories/kuang-rou'>爌肉 (1)</a></li><li><a href='/blog/categories/bi-ji'>筆記 (2)</a></li><li><a href='/blog/categories/zu-zhuang'>組裝 (3)</a></li><li><a href='/blog/categories/lao-jian-zhu'>老建築 (3)</a></li><li><a href='/blog/categories/guo-qi'>過期 (3)</a></li></ul>
</section>
<section>
  <h1>Category Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/arm' style='font-size: 115.65217391304348%'>arm(12)</a> <a href='/blog/categories/asm' style='font-size: 101.30434782608695%'>asm(1)</a> <a href='/blog/categories/assembler' style='font-size: 102.6086956521739%'>assembler(2)</a> <a href='/blog/categories/assembly' style='font-size: 103.91304347826087%'>assembly(3)</a> <a href='/blog/categories/autotools' style='font-size: 105.21739130434783%'>autotools(4)</a> <a href='/blog/categories/banana-pi' style='font-size: 101.30434782608695%'>banana pi(1)</a> <a href='/blog/categories/bash' style='font-size: 101.30434782608695%'>bash(1)</a> <a href='/blog/categories/binutil' style='font-size: 101.30434782608695%'>binutil(1)</a> <a href='/blog/categories/binutils' style='font-size: 118.26086956521739%'>binutils(14)</a> <a href='/blog/categories/buildroot' style='font-size: 102.6086956521739%'>buildroot(2)</a> <a href='/blog/categories/c' style='font-size: 149.56521739130434%'>c(38)</a> <a href='/blog/categories/c-preprocessor' style='font-size: 101.30434782608695%'>c preprocessor(1)</a> <a href='/blog/categories/c99' style='font-size: 102.6086956521739%'>c99(2)</a> <a href='/blog/categories/cmake' style='font-size: 102.6086956521739%'>cmake(2)</a> <a href='/blog/categories/cscope' style='font-size: 101.30434782608695%'>cscope(1)</a> <a href='/blog/categories/ctags' style='font-size: 101.30434782608695%'>ctags(1)</a> <a href='/blog/categories/dbdoclet' style='font-size: 101.30434782608695%'>dbdoclet(1)</a> <a href='/blog/categories/debian' style='font-size: 120.86956521739131%'>debian(16)</a> <a href='/blog/categories/debootstrap' style='font-size: 101.30434782608695%'>debootstrap(1)</a> <a href='/blog/categories/debug' style='font-size: 101.30434782608695%'>debug(1)</a> <a href='/blog/categories/doxygen' style='font-size: 101.30434782608695%'>doxygen(1)</a> <a href='/blog/categories/elf' style='font-size: 102.6086956521739%'>elf(2)</a> <a href='/blog/categories/f9' style='font-size: 101.30434782608695%'>f9(1)</a> <a href='/blog/categories/free-software' style='font-size: 101.30434782608695%'>free software(1)</a> <a href='/blog/categories/freertos' style='font-size: 101.30434782608695%'>freertos(1)</a> <a href='/blog/categories/fsf' style='font-size: 101.30434782608695%'>fsf(1)</a> <a href='/blog/categories/gcc' style='font-size: 102.6086956521739%'>gcc(2)</a> <a href='/blog/categories/gdb' style='font-size: 105.21739130434783%'>gdb(4)</a> <a href='/blog/categories/getopt' style='font-size: 101.30434782608695%'>getopt(1)</a> <a href='/blog/categories/gettext' style='font-size: 102.6086956521739%'>gettext(2)</a> <a href='/blog/categories/git' style='font-size: 105.21739130434783%'>git(4)</a> <a href='/blog/categories/git-remote' style='font-size: 102.6086956521739%'>git remote(2)</a> <a href='/blog/categories/github-flavored-markdown' style='font-size: 101.30434782608695%'>github flavored markdown(1)</a> <a href='/blog/categories/github-pages' style='font-size: 101.30434782608695%'>github pages(1)</a> <a href='/blog/categories/glibc' style='font-size: 106.52173913043478%'>glibc(5)</a> <a href='/blog/categories/gnu' style='font-size: 102.6086956521739%'>gnu(2)</a> <a href='/blog/categories/gnu-as' style='font-size: 101.30434782608695%'>gnu as(1)</a> <a href='/blog/categories/gpl' style='font-size: 101.30434782608695%'>gpl(1)</a> <a href='/blog/categories/gstreamer' style='font-size: 101.30434782608695%'>gstreamer(1)</a> <a href='/blog/categories/hole' style='font-size: 101.30434782608695%'>hole(1)</a> <a href='/blog/categories/inline' style='font-size: 101.30434782608695%'>inline(1)</a> <a href='/blog/categories/javadoc' style='font-size: 102.6086956521739%'>javadoc(2)</a> <a href='/blog/categories/kernel' style='font-size: 102.6086956521739%'>kernel(2)</a> <a href='/blog/categories/ld' style='font-size: 101.30434782608695%'>ld(1)</a> <a href='/blog/categories/libtool' style='font-size: 102.6086956521739%'>libtool(2)</a> <a href='/blog/categories/linker' style='font-size: 102.6086956521739%'>linker(2)</a> <a href='/blog/categories/linker-script' style='font-size: 106.52173913043478%'>linker script(5)</a> <a href='/blog/categories/linux' style='font-size: 160.0%'>linux(46)</a> <a href='/blog/categories/linux-kernel' style='font-size: 103.91304347826087%'>linux kernel(3)</a> <a href='/blog/categories/linux-utilities' style='font-size: 102.6086956521739%'>linux utilities(2)</a> <a href='/blog/categories/live-cd' style='font-size: 101.30434782608695%'>live cd(1)</a> <a href='/blog/categories/lseek' style='font-size: 101.30434782608695%'>lseek(1)</a> <a href='/blog/categories/macro' style='font-size: 101.30434782608695%'>macro(1)</a> <a href='/blog/categories/make' style='font-size: 107.82608695652173%'>make(6)</a> <a href='/blog/categories/markdown' style='font-size: 102.6086956521739%'>markdown(2)</a> <a href='/blog/categories/octopress' style='font-size: 111.73913043478261%'>octopress(9)</a> <a href='/blog/categories/osm' style='font-size: 101.30434782608695%'>osm(1)</a> <a href='/blog/categories/patch' style='font-size: 101.30434782608695%'>patch(1)</a> <a href='/blog/categories/pbuilder' style='font-size: 102.6086956521739%'>pbuilder(2)</a> <a href='/blog/categories/pomodoro-technique' style='font-size: 101.30434782608695%'>pomodoro technique(1)</a> <a href='/blog/categories/presentation' style='font-size: 118.26086956521739%'>presentation(14)</a> <a href='/blog/categories/python' style='font-size: 105.21739130434783%'>python(4)</a> <a href='/blog/categories/qemu' style='font-size: 106.52173913043478%'>qemu(5)</a> <a href='/blog/categories/quilt' style='font-size: 101.30434782608695%'>quilt(1)</a> <a href='/blog/categories/regex' style='font-size: 102.6086956521739%'>regex(2)</a> <a href='/blog/categories/rtenv' style='font-size: 101.30434782608695%'>rtenv(1)</a> <a href='/blog/categories/rtos' style='font-size: 101.30434782608695%'>rtos(1)</a> <a href='/blog/categories/semihosting' style='font-size: 101.30434782608695%'>semihosting(1)</a> <a href='/blog/categories/shell-script' style='font-size: 105.21739130434783%'>shell script(4)</a> <a href='/blog/categories/software-development' style='font-size: 101.30434782608695%'>software development(1)</a> <a href='/blog/categories/stm32' style='font-size: 106.52173913043478%'>stm32(5)</a> <a href='/blog/categories/strip' style='font-size: 101.30434782608695%'>strip(1)</a> <a href='/blog/categories/trace' style='font-size: 101.30434782608695%'>trace(1)</a> <a href='/blog/categories/ubuntu' style='font-size: 101.30434782608695%'>ubuntu(1)</a> <a href='/blog/categories/upnp' style='font-size: 101.30434782608695%'>upnp(1)</a> <a href='/blog/categories/usb' style='font-size: 101.30434782608695%'>usb(1)</a> <a href='/blog/categories/valgrind' style='font-size: 102.6086956521739%'>valgrind(2)</a> <a href='/blog/categories/vim' style='font-size: 106.52173913043478%'>vim(5)</a> <a href='/blog/categories/vim-plugin' style='font-size: 101.30434782608695%'>vim plugin(1)</a> <a href='/blog/categories/virtualbox' style='font-size: 102.6086956521739%'>virtualbox(2)</a> <a href='/blog/categories/vundle' style='font-size: 101.30434782608695%'>vundle(1)</a> <a href='/blog/categories/wireless' style='font-size: 101.30434782608695%'>wireless(1)</a> <a href='/blog/categories/wpa-supplicant' style='font-size: 101.30434782608695%'>wpa_supplicant(1)</a> <a href='/blog/categories/tai-wan-xiao-chi' style='font-size: 101.30434782608695%'>台灣小吃(1)</a> <a href='/blog/categories/gan-xiang' style='font-size: 110.43478260869566%'>感想(8)</a> <a href='/blog/categories/kuang-rou' style='font-size: 101.30434782608695%'>爌肉(1)</a> <a href='/blog/categories/bi-ji' style='font-size: 102.6086956521739%'>筆記(2)</a> <a href='/blog/categories/zu-zhuang' style='font-size: 103.91304347826087%'>組裝(3)</a> <a href='/blog/categories/lao-jian-zhu' style='font-size: 103.91304347826087%'>老建築(3)</a> <a href='/blog/categories/guo-qi' style='font-size: 103.91304347826087%'>過期(3)</a> </span>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.<br>
  Copyright &copy; 2019 - Wen Liao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'httpwen00072githubio';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
