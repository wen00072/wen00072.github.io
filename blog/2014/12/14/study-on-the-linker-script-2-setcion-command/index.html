
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>GNU LD 手冊略讀 (2): Chapter 3.6 SETCIONS - My code works, I don&#8217;t know why.</title>
  <meta name="author" content="Wen Liao">
  <meta property="og:image" content="https://wen00072.github.io/files/pb.jpg" />


  
  <meta name="description" content="上一篇
下一篇
回總目錄 本篇目錄 SECTIONS命令
輸出object檔案的section描述 輸入object檔案的section 基礎概念
輸入object檔案的section 語法的萬用字元
輸入object檔案的COMMOM section
KEEP指令 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-2-setcion-command/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My code works, I don't know why." type="application/atom+xml">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My code works, I don&#8217;t know why.</a></h1>
  
    <h2>國王的耳朵是驢耳朵</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="wen00072.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">GNU LD 手冊略讀 (2): Chapter 3.6 SETCIONS</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-14T23:59:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:59 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://wen00072.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1">上一篇</a>
<a href="http://wen00072.github.io/blog/2014/12/15/study-on-the-linker-script-3">下一篇</a>
<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-0-table-of-contents">回總目錄</a></p>

<h2>本篇目錄</h2>

<ul>
<li><a href="#sec">SECTIONS命令</a></li>
<li><a href="#sec-output-desc">輸出object檔案的section描述</a>

<ul>
<li><a href="#sec-input-desc-basic">輸入object檔案的section 基礎概念</a></li>
<li><a href="#sec-input-desc-wildcard">輸入object檔案的section 語法的萬用字元</a></li>
<li><a href="#sec-input-desc-comm">輸入object檔案的COMMOM section</a></li>
<li><a href="#sec-input-desc-keep">KEEP指令</a></li>
<li><a href="#sec-input-desc-ex">輸入object檔案放到輸出object檔案範例</a></li>
</ul>
</li>
<li><a href="#sec-output-name">輸出object檔案section 命名</a></li>
<li><a href="#sec-output-addr">輸出object檔案section 命令: address欄位</a></li>
<li><a href="#sec-input-desc">輸入object檔案的section描述</a></li>
<li><a href="#sec-output-data">輸出object檔案內指定固定資料長度</a></li>
<li><a href="#sec-output-discard">輸出object檔案捨棄的section</a></li>
<li><a href="#sec-output-attr">輸出object檔案section其他屬性</a>

<ul>
<li><a href="#sec-output-attr-type">輸出object檔案 Section Type</a></li>
<li><a href="#sec-output-attr-lma">輸出object檔案 Section LMA</a></li>
<li><a href="#sec-output-attr-output-align">強制輸出object檔案的 Alignment</a></li>
<li><a href="#sec-output-attr-input-align">強制輸入object檔案的 Alignment</a></li>
<li><a href="#sec-output-attr-limit">輸出object檔案 Section 限制</a></li>
<li><a href="#sec-output-attr-region">輸出object檔案 Section Region</a></li>
<li><a href="#sec-output-attr-output-phdr">輸出object檔案 Section Phdr</a></li>
<li><a href="#sec-output-attr-output-fill">指定輸出object檔案 Section 填空的資料</a></li>
</ul>
</li>
<li><a href="#sec-overlay">OVERLAY命令</a></li>
</ul>


<p><a name="sec"></a></p>

<h2>SETCIONS命令</h2>

<p>其實一開始是為了看懂這個命令才會想看linker script的。如果接觸過很小型的Embedded OS就會發現很多都是自幹linker script；而這些scripts主要的描述命令就是<code>SETCIONS</code>命令。</p>

<p>好了，廢話少說，進入主題。SETCIONS命令命令的功用是</p>

<ul>
<li>告訴linker怎麼把輸入object檔案中的SETCIONS命令對應到輸出object檔案中的sections</li>
<li>告訴loader object檔案中的sections要放到記憶體那些地方</li>
</ul>


<p>SECTIONS命令長這樣子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">sections</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>  <span class="n">sections</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>望文生義地猜測可以這樣理解：
輸出object有一些大方向的規範，並且分為不同的section，每個section有他自己的規範。</p>

<p>而<code>sections-command</code>可以分為下面幾種功能</p>

<ul>
<li><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#cmd">ENTRY命令</a></li>
<li><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#assign">設定symbol的值</a></li>
<li><a href="#sec-output-desc">描述輸出object檔案的setcion</a></li>
<li>Overlay描述 (不知道是三小)</li>
</ul>


<p>要注意的事，如果你自幹的linker script沒有描述輸出object檔案的setcion的話，linker會</p>

<ul>
<li>讀輸入object檔案section時，如果該section第一次出現，就在輸出object檔案中加入同樣名稱的section，直到處理完所有的輸入object檔案</li>
<li>第一個吃到的輸入object檔案section將當作位址0的起始點</li>
</ul>


<p><a name="sec-output-desc"></a></p>

<h2>輸出object檔案的section描述</h2>

<figure class='code'><figcaption><span>輸出object檔案的section描述格式</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">section</span> <span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="p">[(</span><span class="n">type</span><span class="p">)]</span> <span class="o">:</span>
</span><span class='line'>  <span class="p">[</span><span class="n">AT</span><span class="p">(</span><span class="n">lma</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">[</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">section_align</span><span class="p">)</span> <span class="o">|</span> <span class="n">ALIGN_WITH_INPUT</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="n">SUBALIGN</span><span class="p">(</span><span class="n">subsection_align</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">[</span><span class="n">constraint</span><span class="p">]</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span> <span class="p">[</span><span class="o">&gt;</span><span class="n">region</span><span class="p">]</span> <span class="p">[</span><span class="n">AT</span><span class="o">&gt;</span><span class="n">lma_region</span><span class="p">]</span> <span class="p">[</span><span class="o">:</span><span class="nl">phdr</span> <span class="p">:</span><span class="n">phdr</span> <span class="p">...]</span> <span class="p">[</span><span class="o">=</span><span class="n">fillexp</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>output-section-command</code>的功能有</p>

<ul>
<li><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#assign">設定symbol的值</a></li>
<li>描述輸入object檔案中的section要怎麼放到輸出object檔案的setcion</li>
<li>輸出object檔案的setcion的資料存放格式如alignment等</li>
<li>其他</li>
</ul>


<p>這邊很多術語需要先搞清楚，先列出來，希望之後可以看到解答</p>

<ul>
<li>type</li>
<li>region</li>
<li>AT(lma)</li>
<li>lma_region</li>
</ul>


<p><a name="sec-output-name"></a></p>

<h2>輸出object檔案的section 命名</h2>

<ul>
<li>必須符合你要輸出object檔案binary format規定。</li>
</ul>


<p><a name="sec-output-addr"></a></p>

<h2>輸出object檔案section 命令: address欄位</h2>

<p>address是<a href="#sec-output-desc">section</a>的一個optional欄位，使用的記憶體空間為<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">VMA</a>。如果沒有指定的話，linker會依下面的方式設定輸出object檔案section 的VMA。該VMA會遵循section 的alignment規範。</p>

<ul>
<li>有設定<code>region</code>的話就從region內剩餘空間開始位址</li>
<li>有使用<code>MEMORY</code>命令定義硬體記憶區塊的話，從定義的區塊中挑<strong>第一個</strong>符合SECTION的區塊。再將address設成該區塊內剩餘空間開始位址</li>
<li>以上皆非的情況下，位址設成locale counter</li>
</ul>


<p>address欄位因為可以使用exression所以可能有下面的陷阱</p>

<ul>
<li><code>.text . : { *(.text) }</code></li>
<li><code>.text : { *(.text) }</code>
這兩個差一個<code>.</code>，意義就差很多。沒有<code>.</code>那個，表示沒有設定address，所以就是設成locale counter，並且linker會保證alignment。而有<code>.</code>的就表示hardcode成locale counter，所以有可能會有alignment的問題。</li>
</ul>


<p>另外一點要注意的設定後locale counter也會跟著改變。</p>

<p><a name="sec-input-desc"></a></p>

<h2>輸入object檔案的section描述</h2>

<p>這部份可以說是整個<code>output-section-command</code>的重點，目的是告訴linker讀取輸入object檔案後，怎麼把這些檔案裏面的section複製到輸出object檔案裏面<strong>適當地</strong>section。</p>

<p>輸入object檔案的section描述可以被分為下面幾個部份</p>

<ul>
<li><a href="#sec-input-desc-basic">輸入object檔案的section 基礎概念</a></li>
<li><a href="#sec-input-desc-wildcard">輸入object檔案的section 語法的萬用字元</a></li>
<li><a href="#sec-input-desc-comm">輸入object檔案的COMMOM section</a></li>
<li><a href="#sec-input-desc-keep">KEEP指令</a></li>
<li><a href="#sec-input-desc-ex">輸入object檔案放到輸出object檔案範例</a></li>
</ul>


<p><a name="sec-input-desc-basic"></a></p>

<h2>輸入object檔案的section 基礎概念</h2>

<p>格式為<code>檔案(section1  section2 ...)</code>，檔案支援<a href="https://sourceware.org/binutils/docs/ld/Input-Section-Wildcards.html#Input-Section-Wildcards">萬用字元</a>。</p>

<p>所以常看到的<code>*(.text)</code>的意思是：所有輸入object檔案裏面的<code>.text</code> section。</p>

<p>指定多個section的方式有兩種</p>

<ul>
<li><p><code>*(.sec1 .sec2)</code>：如果輸入object有兩個檔案的話，輸出object檔案裏面section會變成
<img src="https://www.dropbox.com/s/ewidzi9p7gktx0u/ld1_section.png?raw=1" alt="" /></p></li>
<li><p><code>*(.sec1) *(.sec2)</code>: 如果輸入object有兩個檔案的話，輸出object檔案裏面section會變成
<img src="https://www.dropbox.com/s/xb81bwchmisgxtx/ld2_section2.png?raw=1" alt="test" /></p></li>
</ul>


<p>你也可以根據flag區分object檔案的section，範例如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">text</span> <span class="p">:</span> <span class="p">{</span> <span class="n">INPUT_SECTION_FLAGS</span> <span class="p">(</span><span class="n">SHF_MERGE</span> <span class="o">&amp;</span> <span class="n">SHF_STRINGS</span><span class="p">)</span> <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">text2</span> <span class="p">:</span>  <span class="p">{</span> <span class="n">INPUT_SECTION_FLAGS</span> <span class="p">(</span><span class="o">!</span><span class="n">SHF_WRITE</span><span class="p">)</span> <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>望文生義可以看到上面的規範就是</p>

<ul>
<li><strong>所有</strong>輸入object檔案的<code>.text</code>section flag有SHF_MERGE 和 SHF_STRINGS的，請放在輸出object檔案的<code>.text</code> section</li>
<li><strong>所有</strong>輸入object檔案的<code>.text</code>section flag沒有SHF_WRITE的，請放在輸出object檔案的<code>.text2</code> section</li>
</ul>


<p>你如果對於範例中的flag有興趣，可以看<a href="http://refspecs.linuxfoundation.org/elf/gabi4+/ch4.sheader.html">這邊</a>, <a href="http://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/sections.html">這邊</a>，還有<a href="http://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/specialsections.html">這邊</a>。我目前還不想看就是了。</p>

<p>另外指定輸入object檔案部份，除了指定單獨的輸入object檔案，還可以指定archieve (如libwen.a, libc.a)裏面的object檔案，用法如下
<code>archive:file</code>，隨便猜一個範例<code>libc.a:fprintf.o</code></p>

<p><a name="sec-input-desc-wildcard"></a></p>

<h2>輸入object檔案的section 語法的萬用字元</h2>

<p>支援
<code>*</code>：任何長度的任何字元
<code>?</code>：單一任何字元
<code>[]</code>：單一字元有效的範圍如<code>[a-z]</code>指小寫英文字母
<code>\</code>：接下來的字元<strong>不是</strong>萬用字元，如<code>\*</code></p>

<p>由於linker複製section的方式是多個條件滿足的話，選第一個條件滿足就處理，所以配合萬用字元可能會產生意想不到的錯誤，範例如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">.</span><span class="nl">data</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">.</span><span class="nl">data1</span> <span class="p">:</span> <span class="p">{</span> <span class="n">data</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>由於複製section的方式是第一個條件滿足就處理，所以會造成data.o的<code>.data</code> section放字輸出object檔案的<code>.data</code> section而不是<code>.data1</code> section。手冊提供了建議處理方式，有興趣的可以<a href="https://sourceware.org/binutils/docs/ld/Input-Section-Wildcards.html#Input-Section-Wildcards">參考</a>。</p>

<p><a name="sec-input-desc-comm"></a></p>

<h2>輸入object檔案的COMMOM section</h2>

<ul>
<li><a href="http://wen00072.github.io/blog/2014/12/09/global-variables-from-common-symbol-on-the-c-programming-language#elf-concl">這邊</a>有提到common symbol存在的原因。手冊中更進一步的提到在輸出object檔案時的命令大概是這樣：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">.</span><span class="n">bss</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">bss</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">COMMON</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是說，最後沒特別狀況，就把輸入object 檔案的COMMON section放在<code>.bss</code> section。</p>

<p><a name="sec-input-desc-keep"></a></p>

<h2>KEEP指令</h2>

<ul>
<li><code>KEEP(要保留的section)</code>：因為linker有garbage collection，如果要保證section不會被回收，可以用該指令。</li>
</ul>


<p><a name="sec-input-desc-ex"></a></p>

<h2>輸入object檔案放到輸出object檔案範例</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">outputa</span> <span class="mh">0x10000</span> <span class="o">:</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">all</span><span class="p">.</span><span class="n">o</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">o</span> <span class="p">(.</span><span class="n">input1</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nl">outputb</span> <span class="p">:</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">o</span> <span class="p">(.</span><span class="n">input2</span><span class="p">)</span>
</span><span class='line'>      <span class="n">foo1</span><span class="p">.</span><span class="n">o</span> <span class="p">(.</span><span class="n">input1</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nl">outputc</span> <span class="p">:</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="p">(.</span><span class="n">input1</span><span class="p">)</span>
</span><span class='line'>      <span class="o">*</span><span class="p">(.</span><span class="n">input2</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以圖示就是
<img src="https://www.dropbox.com/s/1ptw7s31ynun4o0/ld2_section3.png?raw=1" alt="" /></p>

<p><a name="sec-output-data"></a></p>

<h2>輸出object檔案內指定固定資料長度</h2>

<ul>
<li><code>長度單位命令(expression)</code>

<ul>
<li>長度單位命令

<ul>
<li><code>BYTE</code>：1 byte</li>
</ul>
</li>
<li><code>SHORT</code>：2 bytes</li>
<li><code>LONG</code>：4 bytes</li>
<li><code>QUAD</code>：8 byte</li>
</ul>
</li>
</ul>


<p>以下的命令將會佔 5 bytes，第一個byte後面4個bytes將用來存放addr (如果我英文沒看錯的話，原文是store the byte 1 followed by the four byte value of the symbol <code>addr':)。
</code>BYTE(1)<code>
</code>LONG(addr)`</p>

<p>關於64-bit的目前沒心情看，跳過。</p>

<p>至於endian的部份，如果輸出的object檔案有規範，則依該規範存放，否則則遵守第一個讀入的輸入object檔案。</p>

<ul>
<li><code>FILL(expression)</code>：section內沒使用的空間將被填入expression計算後的數字。同樣效果的命令是<code>[=fillexp]</code>，忘記這是啥嗎?我也忘了，所以回去<a href="#sec-output-desc">找了一下</a></li>
</ul>


<h2>3.6.6看不懂，跳過。</h2>

<p><a name="sec-output-discard"></a></p>

<h2>輸出object檔案捨棄的section</h2>

<p>為什麼要丟掉？原因是在設定輸出section的script有提到特定的section，但是link完畢後發現所有輸入object檔案都沒有該section的symbol。最後就是把這些section丟掉。</p>

<p>另外一個情況是輸入object檔案有<code>/DISCARD/</code>既然就說要丟了就恭敬不如從命了。</p>

<p><a name="sec-output-attr"></a></p>

<h2>輸出object檔案section其他屬性</h2>

<p>還記得前面的格式嘛？再複習一下:</p>

<figure class='code'><figcaption><span>輸出object檔案的section描述格式</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">section</span> <span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="p">[(</span><span class="n">type</span><span class="p">)]</span> <span class="o">:</span>
</span><span class='line'>  <span class="p">[</span><span class="n">AT</span><span class="p">(</span><span class="n">lma</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">[</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">section_align</span><span class="p">)</span> <span class="o">|</span> <span class="n">ALIGN_WITH_INPUT</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="n">SUBALIGN</span><span class="p">(</span><span class="n">subsection_align</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">[</span><span class="n">constraint</span><span class="p">]</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span> <span class="p">[</span><span class="o">&gt;</span><span class="n">region</span><span class="p">]</span> <span class="p">[</span><span class="n">AT</span><span class="o">&gt;</span><span class="n">lma_region</span><span class="p">]</span> <span class="p">[</span><span class="o">:</span><span class="nl">phdr</span> <span class="p">:</span><span class="n">phdr</span> <span class="p">...]</span> <span class="p">[</span><span class="o">=</span><span class="n">fillexp</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>前面篇幅已經說明了<code>section</code>，<code>address</code>，以及<code>output-section-command</code>等語法和命令，我們接著要介紹其他部份如下</p>

<ul>
<li><a href="#sec-output-attr-type">輸出object檔案 Section Type</a></li>
<li><a href="#sec-output-attr-lma">輸出object檔案 Section LMA</a></li>
<li><a href="#sec-output-attr-output-align">強制輸出的 Alignment</a></li>
<li><a href="#sec-output-attr-input-align">強制輸入的 Alignment</a></li>
<li><a href="#sec-output-attr-limit">輸出object檔案 Section 限制</a></li>
<li><a href="#sec-output-attr-region">輸出object檔案 Section Region</a></li>
<li><a href="#sec-output-attr-output-phdr">輸出object檔案 Section Phdr</a></li>
<li><a href="#sec-output-attr-output-fill">指定輸出object檔案 Section 填空的資料</a></li>
</ul>


<p><a name="sec-output-attr-type"></a></p>

<h2>輸出object檔案 Section Type</h2>

<p>有支援</p>

<ul>
<li><code>NOLOAD</code>

<ul>
<li>當程式執行的時候不載入到記憶體（想像ROM或是NOR FLASH）</li>
</ul>
</li>
<li><code>DSECT</code></li>
<li><code>COPY</code></li>
<li><code>INFO</code></li>
<li><code>OVERLAY</code>

<ul>
<li>上面四個是為了往前相容保留的type，基本上很少用了。用途都相同，指定該區段不可以分配記憶體。不過我本身不懂什麼情況下不要分配記憶體就是了。</li>
</ul>
</li>
</ul>


<p>基本上type繼承輸入object中的type，不過你要硬上就是在輸出object檔案描述，範例如下。該範例顯示ROM 區段起始位址為0，並且在該section執行程式不要載入到記憶體。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">ROM</span> <span class="mi">0</span> <span class="p">(</span><span class="n">NOLOAD</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="sec-output-attr-lma"></a></p>

<h2>輸出object檔案 Section LMA</h2>

<p>前情回顧</p>

<ul>
<li><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">VMA</a></li>
<li><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">LMA</a></li>
</ul>


<p>設定輸出object檔案的<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">VMA</a>是在<a href="#sec-output-addr"><code>address欄位</code></a>中指定。請比對<a href="#sec-output-attr">section描述格式</a>的<code>address</code>。</p>

<p>而<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">LMA</a>就是<a href="#sec-output-attr">section描述格式</a>的<code>AT(lma)</code>和<code>AT&gt;lma_region</code>這兩個部份了。這兩個指令是optional的。他們的差別是：</p>

<ul>
<li><code>AT(lma)</code>中間的lma是透過expression算出來的lma位址</li>
<li><code>AT&gt;lma_region</code>是指定<code>MEMORY</code>裏面描述的region</li>
</ul>


<p>如果你的section沒有指定<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">LMA</a>的話，linker會使用下面的規則決定<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#bkg-layout">LMA</a></p>

<ul>
<li><a href="#sec-output-addr"><code>address欄位</code></a>中指定VMA，則LMA = VMA</li>
<li>section為<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1#fmt">allocatable</a>，則LMA = VMA</li>
<li>有設定region的情況在滿足下面的條件下，把VMA和LMA的差距會被設成該region裏面最後一個section中VMA和LMA的差距。

<ul>
<li>section滿足region條件(三小條件?)</li>
<li>該region已經有最少一個section</li>
</ul>
</li>
<li>沒有設定region的情況在找不到相容的region，linker會指令預設包含所有memory space的region，從裏面挑一個section，把VMA和LMA的差距會被設成該region裏面最後一個section中VMA和LMA的差距。 (三小？為什麼要這樣做？）</li>
<li>找不到合適的region放section的話，就閉著眼睛把LMA = VMA吧。</li>
</ul>


<p>來點範例，這是一個嵌入式系統，假設所有的資料都放在唯讀記憶體中。那麼會發生什麼事呢？那就是你的<code>i++</code>就GG了，所以要把變數部份還有其他需要寫入的部份放在RAM中，所以這個script顯示了</p>

<ul>
<li>VMA的0x1000的位址放程式碼</li>
<li>VMA的0x2000放有初始化的全域變數，而這些初始值從那邊搬到記憶體呢來呢？就是LMA描述的東西，望文生義可以知道是接在.text之後的資料。</li>
<li>VMA的0x3000就是放未初始化的全域變數</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="p">.</span><span class="n">text</span> <span class="mh">0x1000</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="n">_etext</span> <span class="o">=</span> <span class="p">.</span> <span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">.</span><span class="n">mdata</span> <span class="mh">0x2000</span> <span class="o">:</span>
</span><span class='line'>          <span class="n">AT</span> <span class="p">(</span> <span class="n">ADDR</span> <span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">SIZEOF</span> <span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>          <span class="p">{</span> <span class="n">_data</span> <span class="o">=</span> <span class="p">.</span> <span class="p">;</span> <span class="o">*</span><span class="p">(.</span><span class="n">data</span><span class="p">);</span> <span class="n">_edata</span> <span class="o">=</span> <span class="p">.</span> <span class="p">;</span>  <span class="p">}</span>
</span><span class='line'>      <span class="p">.</span><span class="n">bss</span> <span class="mh">0x3000</span> <span class="o">:</span>
</span><span class='line'>          <span class="p">{</span> <span class="n">_bstart</span> <span class="o">=</span> <span class="p">.</span> <span class="p">;</span>  <span class="o">*</span><span class="p">(.</span><span class="n">bss</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">COMMON</span><span class="p">)</span> <span class="p">;</span> <span class="n">_bend</span> <span class="o">=</span> <span class="p">.</span> <span class="p">;}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>當然事情沒那麼簡單，這邊只有講layout。在沒有OS幫你搞定的時候什麼事都要自己來，所以你還要自己把有初始化的全域變數一個一個搬到RAM裏面如下。請仔細比對變數和script的symbol。另外如果有興趣看<a href="http://www.arm.com/products/processors/cortex-m/cortex-microcontroller-software-interface-standard.php">CMSIS(Cortex Microcontroller Software Interface Standard)</a>的source code也可以看到類似的行為。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">extern</span> <span class="kt">char</span> <span class="n">_etext</span><span class="p">,</span> <span class="n">_data</span><span class="p">,</span> <span class="n">_edata</span><span class="p">,</span> <span class="n">_bstart</span><span class="p">,</span> <span class="n">_bend</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* ROM has data at end of text; copy it.  */</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">_edata</span><span class="p">)</span>
</span><span class='line'>  <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Zero bss.  */</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_bstart</span><span class="p">;</span> <span class="n">dst</span><span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">_bend</span><span class="p">;</span> <span class="n">dst</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>  <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="sec-output-attr-output-align"></a></p>

<h2>強制輸出object檔案的 Alignment</h2>

<p>請使用<code>ALIGN</code>，或是使用<code>ALIGN_WITH_INPUT</code>將讀入的object檔案中的section設定成你要的alignment。</p>

<p><a name="sec-output-attr-input-align"></a></p>

<h2>強制輸入object檔案的 Alignment</h2>

<p>請使用<code>SUBALIGN</code> 去指定輸入object檔案單一個section的alignment。</p>

<p><a name="sec-output-attr-limit"></a></p>

<h2>輸出object檔案 Section 限制</h2>

<ul>
<li><code>ONLY_IF_RO</code>

<ul>
<li>當輸入object檔案符合條件的section為唯讀才產生你要的輸出object檔案section</li>
</ul>
</li>
<li><code>ONLY_IF_RW</code>

<ul>
<li>當輸入object檔案符合條件的section為可讀寫才產生你要的輸出object檔案section</li>
</ul>
</li>
</ul>


<p><a name="sec-output-attr-region"></a></p>

<h3>輸出object檔案 Section Region</h3>

<p>使用<code>&gt;MEMORY_指令_宣告的region</code></p>

<p>範例，把<code>.text</code>放ROM section，該section位址是在硬體rom記憶體區塊。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">MEMORY</span> <span class="p">{</span> <span class="nl">rom</span> <span class="p">:</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">LENGTH</span> <span class="o">=</span> <span class="mh">0x1000</span> <span class="p">}</span>
</span><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span> <span class="nl">ROM</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span> <span class="o">&gt;</span><span class="n">rom</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="sec-output-attr-output-phdr"></a></p>

<h2>輸出object檔案 Section Phdr</h2>

<p>PHDR 是<a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a>的program header縮寫，又稱為segment。當ELF loader載入ELF執行檔的時候，會看這些segment決定要如何把讀入的檔案放在記憶體中，這部份和<a href="http://en.wikipedia.org/wiki/Application_binary_interface">ABI</a>有關係，按下不表，等我那天心情好再來看ELF和ABI。</p>

<p><a href="#sec-output-attr">section描述格式</a>中<code>phdr</code>的用法是</p>

<ul>
<li>宣告一個phdr</li>
<li>指令特定的section屬於該phdr</li>
</ul>


<p>範例如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">PHDRS</span> <span class="p">{</span> <span class="n">text</span> <span class="n">PT_LOAD</span> <span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span> <span class="p">.</span><span class="nl">text</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span> <span class="o">:</span><span class="n">text</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="sec-output-attr-output-fill"></a></p>

<h2>指定輸出object檔案 Section 填空的資料</h2>

<p><a href="#sec-output-data">前面FILL</a>講到指令填空的資料。而<a href="#sec-output-attr">section描述格式</a>中<code>=fillexp</code>也有相同效果，範例如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span> <span class="p">.</span><span class="nl">text</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span> <span class="o">=</span><span class="mh">0x90909090</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="sec-overlay"></a></p>

<h2>OVERLAY命令</h2>

<p><a href="http://en.wikipedia.org/wiki/Overlay_%28programming%29">Overlay</a>是一種在記憶體小於執行檔案時的技巧。其基本概念就是</p>

<ul>
<li>把程式切成不同模組</li>
<li>載入單個模組到記憶體並執行，當程式行為Z要另外一個模組的話，就釋放目前模組，再載入新的模組到記憶體並執行。</li>
</ul>


<p>對應到linker script就會格式這樣</p>

<figure class='code'><figcaption><span>OVERLAY命令格式</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">OVERLAY</span> <span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="n">NOCROSSREFS</span><span class="p">]</span> <span class="p">[</span><span class="n">AT</span> <span class="p">(</span> <span class="n">ldaddr</span> <span class="p">)]</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">secname1</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span> <span class="p">[</span><span class="o">:</span><span class="n">phdr</span><span class="p">...]</span> <span class="p">[</span><span class="o">=</span><span class="n">fill</span><span class="p">]</span>
</span><span class='line'>  <span class="n">secname2</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="n">output</span><span class="o">-</span><span class="n">section</span><span class="o">-</span><span class="n">command</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span> <span class="p">[</span><span class="o">:</span><span class="n">phdr</span><span class="p">...]</span> <span class="p">[</span><span class="o">=</span><span class="n">fill</span><span class="p">]</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span> <span class="p">[</span><span class="o">&gt;</span><span class="n">region</span><span class="p">]</span> <span class="p">[</span><span class="o">:</span><span class="n">phdr</span><span class="p">...]</span> <span class="p">[</span><span class="o">=</span><span class="n">fill</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>OVERLAY命令中除了<code>OVERLAY</code>和<code>section 名稱</code>以外其他都是optional。另外要注意的是<code>OVERLAY</code>命令不允許region和address的描述。而在<code>OVERLAY</code>最後面的資料固定為<code>OVERLAY起始位址</code> + <code>最大section的size</code></p>

<p>由於OVERLAY就是動態切換並執行不同section，所以在VMA的位址會固定。這表示所有的section的VMA會相同。為了方便，linker會把所有<code>OVERLAY</code>中的section串接成連續的空間。</p>

<p>OVERLAY用法如下</p>

<ul>
<li>linker script設定OVERLAY</li>
<li>程式語言視情況需要切換時「人肉」搬移OVERLAY裏面的section到記憶體</li>
</ul>


<p>「人肉」搬移表示我們需要</p>

<ul>
<li>section 起始位址</li>
<li>section 結束位址</li>
</ul>


<p>這部份linker會自動幫我們加入symbol，規則如下，很容易望文生義所以就不解釋了。</p>

<ul>
<li><code>__load_start_section_名稱</code></li>
<li><code>__load_stop_section_名稱</code></li>
</ul>


<p>那麼現在看一下手冊上面的範例</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">OVERLAY</span> <span class="mh">0x1000</span> <span class="o">:</span> <span class="n">AT</span> <span class="p">(</span><span class="mh">0x4000</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="n">text0</span> <span class="p">{</span> <span class="n">o1</span><span class="o">/*</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">text1</span> <span class="p">{</span> <span class="n">o2</span><span class="o">/*</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>還記得<a href="#sec-output-addr">address</a>和<a href="#sec-output-attr-lma">AT</a>命令嗎？一個是指定VMA另外一個是指定LMA。所以上面的設定白話文就是</p>

<ul>
<li>我要一個overlay，從0x4000載入到0x1000的記憶體內</li>
<li>這個overlay有<code>.text0</code>和<code>.text1</code>兩個section</li>
<li><code>.text0</code>裏面放的是o1目錄下所有object檔案中的<code>.text</code></li>
<li><code>.text1</code>裏面放的是o2目錄下所有object檔案中的<code>.text</code></li>
</ul>


<p>那麼人肉搬移要怎麼處理呢？手冊列出如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">extern</span> <span class="kt">char</span> <span class="n">__load_start_text1</span><span class="p">,</span> <span class="n">__load_stop_text1</span><span class="p">;</span>
</span><span class='line'><span class="n">memcpy</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__load_start_text1</span><span class="p">,</span>
</span><span class='line'>          <span class="o">&amp;</span><span class="n">__load_stop_text1</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">__load_start_text1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，我們說要從LMA搬到VMA，LMA的位址就由symbol內容提供。</p>

<p>另外手冊這個<a href="https://sourceware.org/binutils/docs/ld/Overlay-Description.html#Overlay-Description">section</a>我跳過一些東西，有興趣的朋友可以去超級比一比。</p>

<p><a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-1">上一篇</a>
<a href="http://wen00072.github.io/blog/2014/12/15/study-on-the-linker-script-3">下一篇</a>
<a href="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-0-table-of-contents">回總目錄</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Wen Liao</span></span>

      




<time class='entry-date' datetime='2014-12-14T23:59:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:59 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/binutils/'>binutils</a>, <a class='category' href='/blog/categories/linker-script/'>linker script</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-2-setcion-command/" data-via="" data-counturl="http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-2-setcion-command/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/14/study-on-the-linker-script-1/" title="Previous Post: GNU LD  手冊略讀  (1): Chapter 3 ~ Chapter 3.5">&laquo; GNU LD  手冊略讀  (1): Chapter 3 ~ Chapter 3.5</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/12/15/study-on-the-linker-script-3/" title="Next Post: GNU LD 手冊略讀 (3): Chapter 3.7 ~ Chapter 3.11">GNU LD 手冊略讀 (3): Chapter 3.7 ~ Chapter 3.11 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/07/24/notes-on-how-to-c-2016/">Notes on How to C 2016</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/15/vim-setup-for-trace-c-code/">給自己剪貼用的vim設定</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/04/qemu-x86-64-with-gdb/">Fix: Qemu X86_64下gdb Debug kernel出現Remote &#39;g&#8217; Packet Reply Is Too Long:</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/28/gvim-remote-tabzi-dong-wan-cheng/">Bash下自動完成gvim &#8211;remote-tab</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/18/review-gnu-coding-style/">筆記 - GNU Coding Style</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Top Categories</h1>
    <ul id="top-category-list"><li><a href='/blog/categories/linux'>linux (41)</a></li><li><a href='/blog/categories/c'>c (32)</a></li><li><a href='/blog/categories/debian'>debian (16)</a></li><li><a href='/blog/categories/presentation'>presentation (14)</a></li><li><a href='/blog/categories/binutils'>binutils (14)</a></li><li><a href='/blog/categories/arm'>arm (12)</a></li><li><a href='/blog/categories/octopress'>octopress (8)</a></li><li><a href='/blog/categories/gan-xiang'>感想 (8)</a></li><li><a href='/blog/categories/make'>make (6)</a></li><li><a href='/blog/categories/stm32'>stm32 (5)</a></li></ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/arm'>arm (12)</a></li><li><a href='/blog/categories/asm'>asm (1)</a></li><li><a href='/blog/categories/assembler'>assembler (2)</a></li><li><a href='/blog/categories/assembly'>assembly (3)</a></li><li><a href='/blog/categories/autotools'>autotools (4)</a></li><li><a href='/blog/categories/banana-pi'>banana pi (1)</a></li><li><a href='/blog/categories/bash'>bash (1)</a></li><li><a href='/blog/categories/binutils'>binutils (14)</a></li><li><a href='/blog/categories/buildroot'>buildroot (2)</a></li><li><a href='/blog/categories/c'>c (32)</a></li><li><a href='/blog/categories/c-preprocessor'>c preprocessor (1)</a></li><li><a href='/blog/categories/c99'>c99 (2)</a></li><li><a href='/blog/categories/cmake'>cmake (2)</a></li><li><a href='/blog/categories/cscope'>cscope (1)</a></li><li><a href='/blog/categories/ctags'>ctags (1)</a></li><li><a href='/blog/categories/dbdoclet'>dbdoclet (1)</a></li><li><a href='/blog/categories/debian'>debian (16)</a></li><li><a href='/blog/categories/debootstrap'>debootstrap (1)</a></li><li><a href='/blog/categories/doxygen'>doxygen (1)</a></li><li><a href='/blog/categories/f9'>f9 (1)</a></li><li><a href='/blog/categories/free-software'>free software (1)</a></li><li><a href='/blog/categories/freertos'>freertos (1)</a></li><li><a href='/blog/categories/fsf'>fsf (1)</a></li><li><a href='/blog/categories/gcc'>gcc (2)</a></li><li><a href='/blog/categories/gdb'>gdb (3)</a></li><li><a href='/blog/categories/getopt'>getopt (1)</a></li><li><a href='/blog/categories/gettext'>gettext (2)</a></li><li><a href='/blog/categories/git'>git (4)</a></li><li><a href='/blog/categories/git-remote'>git remote (2)</a></li><li><a href='/blog/categories/github-flavored-markdown'>github flavored markdown (1)</a></li><li><a href='/blog/categories/github-pages'>github pages (1)</a></li><li><a href='/blog/categories/gnu'>gnu (2)</a></li><li><a href='/blog/categories/gnu-as'>gnu as (1)</a></li><li><a href='/blog/categories/gpl'>gpl (1)</a></li><li><a href='/blog/categories/gstreamer'>gstreamer (1)</a></li><li><a href='/blog/categories/hole'>hole (1)</a></li><li><a href='/blog/categories/inline'>inline (1)</a></li><li><a href='/blog/categories/javadoc'>javadoc (2)</a></li><li><a href='/blog/categories/kernel'>kernel (1)</a></li><li><a href='/blog/categories/ld'>ld (1)</a></li><li><a href='/blog/categories/libtool'>libtool (2)</a></li><li><a href='/blog/categories/linker'>linker (1)</a></li><li><a href='/blog/categories/linker-script'>linker script (5)</a></li><li><a href='/blog/categories/linux'>linux (41)</a></li><li><a href='/blog/categories/linux-kernel'>linux kernel (3)</a></li><li><a href='/blog/categories/linux-utilities'>linux utilities (2)</a></li><li><a href='/blog/categories/live-cd'>live cd (1)</a></li><li><a href='/blog/categories/lseek'>lseek (1)</a></li><li><a href='/blog/categories/macro'>macro (1)</a></li><li><a href='/blog/categories/make'>make (6)</a></li><li><a href='/blog/categories/markdown'>markdown (2)</a></li><li><a href='/blog/categories/octopress'>octopress (8)</a></li><li><a href='/blog/categories/osm'>osm (1)</a></li><li><a href='/blog/categories/patch'>patch (1)</a></li><li><a href='/blog/categories/pbuilder'>pbuilder (2)</a></li><li><a href='/blog/categories/pomodoro-technique'>pomodoro technique (1)</a></li><li><a href='/blog/categories/presentation'>presentation (14)</a></li><li><a href='/blog/categories/python'>python (4)</a></li><li><a href='/blog/categories/qemu'>qemu (5)</a></li><li><a href='/blog/categories/quilt'>quilt (1)</a></li><li><a href='/blog/categories/regex'>regex (1)</a></li><li><a href='/blog/categories/rtenv'>rtenv (1)</a></li><li><a href='/blog/categories/rtos'>rtos (1)</a></li><li><a href='/blog/categories/semihosting'>semihosting (1)</a></li><li><a href='/blog/categories/shell-script'>shell script (4)</a></li><li><a href='/blog/categories/software-development'>software development (1)</a></li><li><a href='/blog/categories/stm32'>stm32 (5)</a></li><li><a href='/blog/categories/strip'>strip (1)</a></li><li><a href='/blog/categories/ubuntu'>ubuntu (1)</a></li><li><a href='/blog/categories/upnp'>upnp (1)</a></li><li><a href='/blog/categories/usb'>usb (1)</a></li><li><a href='/blog/categories/valgrind'>valgrind (2)</a></li><li><a href='/blog/categories/vim'>vim (4)</a></li><li><a href='/blog/categories/vim-plugin'>vim plugin (1)</a></li><li><a href='/blog/categories/virtualbox'>virtualbox (2)</a></li><li><a href='/blog/categories/vundle'>vundle (1)</a></li><li><a href='/blog/categories/wireless'>wireless (1)</a></li><li><a href='/blog/categories/wpa-supplicant'>wpa_supplicant (1)</a></li><li><a href='/blog/categories/tai-wan-xiao-chi'>台灣小吃 (1)</a></li><li><a href='/blog/categories/gan-xiang'>感想 (8)</a></li><li><a href='/blog/categories/kuang-rou'>爌肉 (1)</a></li><li><a href='/blog/categories/bi-ji'>筆記 (2)</a></li><li><a href='/blog/categories/zu-zhuang'>組裝 (3)</a></li><li><a href='/blog/categories/lao-jian-zhu'>老建築 (3)</a></li><li><a href='/blog/categories/guo-qi'>過期 (3)</a></li></ul>
</section>
<section>
  <h1>Category Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/arm' style='font-size: 117.5609756097561%'>arm(12)</a> <a href='/blog/categories/asm' style='font-size: 101.46341463414635%'>asm(1)</a> <a href='/blog/categories/assembler' style='font-size: 102.92682926829268%'>assembler(2)</a> <a href='/blog/categories/assembly' style='font-size: 104.39024390243902%'>assembly(3)</a> <a href='/blog/categories/autotools' style='font-size: 105.85365853658537%'>autotools(4)</a> <a href='/blog/categories/banana-pi' style='font-size: 101.46341463414635%'>banana pi(1)</a> <a href='/blog/categories/bash' style='font-size: 101.46341463414635%'>bash(1)</a> <a href='/blog/categories/binutils' style='font-size: 120.48780487804878%'>binutils(14)</a> <a href='/blog/categories/buildroot' style='font-size: 102.92682926829268%'>buildroot(2)</a> <a href='/blog/categories/c' style='font-size: 146.8292682926829%'>c(32)</a> <a href='/blog/categories/c-preprocessor' style='font-size: 101.46341463414635%'>c preprocessor(1)</a> <a href='/blog/categories/c99' style='font-size: 102.92682926829268%'>c99(2)</a> <a href='/blog/categories/cmake' style='font-size: 102.92682926829268%'>cmake(2)</a> <a href='/blog/categories/cscope' style='font-size: 101.46341463414635%'>cscope(1)</a> <a href='/blog/categories/ctags' style='font-size: 101.46341463414635%'>ctags(1)</a> <a href='/blog/categories/dbdoclet' style='font-size: 101.46341463414635%'>dbdoclet(1)</a> <a href='/blog/categories/debian' style='font-size: 123.41463414634146%'>debian(16)</a> <a href='/blog/categories/debootstrap' style='font-size: 101.46341463414635%'>debootstrap(1)</a> <a href='/blog/categories/doxygen' style='font-size: 101.46341463414635%'>doxygen(1)</a> <a href='/blog/categories/f9' style='font-size: 101.46341463414635%'>f9(1)</a> <a href='/blog/categories/free-software' style='font-size: 101.46341463414635%'>free software(1)</a> <a href='/blog/categories/freertos' style='font-size: 101.46341463414635%'>freertos(1)</a> <a href='/blog/categories/fsf' style='font-size: 101.46341463414635%'>fsf(1)</a> <a href='/blog/categories/gcc' style='font-size: 102.92682926829268%'>gcc(2)</a> <a href='/blog/categories/gdb' style='font-size: 104.39024390243902%'>gdb(3)</a> <a href='/blog/categories/getopt' style='font-size: 101.46341463414635%'>getopt(1)</a> <a href='/blog/categories/gettext' style='font-size: 102.92682926829268%'>gettext(2)</a> <a href='/blog/categories/git' style='font-size: 105.85365853658537%'>git(4)</a> <a href='/blog/categories/git-remote' style='font-size: 102.92682926829268%'>git remote(2)</a> <a href='/blog/categories/github-flavored-markdown' style='font-size: 101.46341463414635%'>github flavored markdown(1)</a> <a href='/blog/categories/github-pages' style='font-size: 101.46341463414635%'>github pages(1)</a> <a href='/blog/categories/gnu' style='font-size: 102.92682926829268%'>gnu(2)</a> <a href='/blog/categories/gnu-as' style='font-size: 101.46341463414635%'>gnu as(1)</a> <a href='/blog/categories/gpl' style='font-size: 101.46341463414635%'>gpl(1)</a> <a href='/blog/categories/gstreamer' style='font-size: 101.46341463414635%'>gstreamer(1)</a> <a href='/blog/categories/hole' style='font-size: 101.46341463414635%'>hole(1)</a> <a href='/blog/categories/inline' style='font-size: 101.46341463414635%'>inline(1)</a> <a href='/blog/categories/javadoc' style='font-size: 102.92682926829268%'>javadoc(2)</a> <a href='/blog/categories/kernel' style='font-size: 101.46341463414635%'>kernel(1)</a> <a href='/blog/categories/ld' style='font-size: 101.46341463414635%'>ld(1)</a> <a href='/blog/categories/libtool' style='font-size: 102.92682926829268%'>libtool(2)</a> <a href='/blog/categories/linker' style='font-size: 101.46341463414635%'>linker(1)</a> <a href='/blog/categories/linker-script' style='font-size: 107.3170731707317%'>linker script(5)</a> <a href='/blog/categories/linux' style='font-size: 160.0%'>linux(41)</a> <a href='/blog/categories/linux-kernel' style='font-size: 104.39024390243902%'>linux kernel(3)</a> <a href='/blog/categories/linux-utilities' style='font-size: 102.92682926829268%'>linux utilities(2)</a> <a href='/blog/categories/live-cd' style='font-size: 101.46341463414635%'>live cd(1)</a> <a href='/blog/categories/lseek' style='font-size: 101.46341463414635%'>lseek(1)</a> <a href='/blog/categories/macro' style='font-size: 101.46341463414635%'>macro(1)</a> <a href='/blog/categories/make' style='font-size: 108.78048780487805%'>make(6)</a> <a href='/blog/categories/markdown' style='font-size: 102.92682926829268%'>markdown(2)</a> <a href='/blog/categories/octopress' style='font-size: 111.70731707317073%'>octopress(8)</a> <a href='/blog/categories/osm' style='font-size: 101.46341463414635%'>osm(1)</a> <a href='/blog/categories/patch' style='font-size: 101.46341463414635%'>patch(1)</a> <a href='/blog/categories/pbuilder' style='font-size: 102.92682926829268%'>pbuilder(2)</a> <a href='/blog/categories/pomodoro-technique' style='font-size: 101.46341463414635%'>pomodoro technique(1)</a> <a href='/blog/categories/presentation' style='font-size: 120.48780487804878%'>presentation(14)</a> <a href='/blog/categories/python' style='font-size: 105.85365853658537%'>python(4)</a> <a href='/blog/categories/qemu' style='font-size: 107.3170731707317%'>qemu(5)</a> <a href='/blog/categories/quilt' style='font-size: 101.46341463414635%'>quilt(1)</a> <a href='/blog/categories/regex' style='font-size: 101.46341463414635%'>regex(1)</a> <a href='/blog/categories/rtenv' style='font-size: 101.46341463414635%'>rtenv(1)</a> <a href='/blog/categories/rtos' style='font-size: 101.46341463414635%'>rtos(1)</a> <a href='/blog/categories/semihosting' style='font-size: 101.46341463414635%'>semihosting(1)</a> <a href='/blog/categories/shell-script' style='font-size: 105.85365853658537%'>shell script(4)</a> <a href='/blog/categories/software-development' style='font-size: 101.46341463414635%'>software development(1)</a> <a href='/blog/categories/stm32' style='font-size: 107.3170731707317%'>stm32(5)</a> <a href='/blog/categories/strip' style='font-size: 101.46341463414635%'>strip(1)</a> <a href='/blog/categories/ubuntu' style='font-size: 101.46341463414635%'>ubuntu(1)</a> <a href='/blog/categories/upnp' style='font-size: 101.46341463414635%'>upnp(1)</a> <a href='/blog/categories/usb' style='font-size: 101.46341463414635%'>usb(1)</a> <a href='/blog/categories/valgrind' style='font-size: 102.92682926829268%'>valgrind(2)</a> <a href='/blog/categories/vim' style='font-size: 105.85365853658537%'>vim(4)</a> <a href='/blog/categories/vim-plugin' style='font-size: 101.46341463414635%'>vim plugin(1)</a> <a href='/blog/categories/virtualbox' style='font-size: 102.92682926829268%'>virtualbox(2)</a> <a href='/blog/categories/vundle' style='font-size: 101.46341463414635%'>vundle(1)</a> <a href='/blog/categories/wireless' style='font-size: 101.46341463414635%'>wireless(1)</a> <a href='/blog/categories/wpa-supplicant' style='font-size: 101.46341463414635%'>wpa_supplicant(1)</a> <a href='/blog/categories/tai-wan-xiao-chi' style='font-size: 101.46341463414635%'>台灣小吃(1)</a> <a href='/blog/categories/gan-xiang' style='font-size: 111.70731707317073%'>感想(8)</a> <a href='/blog/categories/kuang-rou' style='font-size: 101.46341463414635%'>爌肉(1)</a> <a href='/blog/categories/bi-ji' style='font-size: 102.92682926829268%'>筆記(2)</a> <a href='/blog/categories/zu-zhuang' style='font-size: 104.39024390243902%'>組裝(3)</a> <a href='/blog/categories/lao-jian-zhu' style='font-size: 104.39024390243902%'>老建築(3)</a> <a href='/blog/categories/guo-qi' style='font-size: 104.39024390243902%'>過期(3)</a> </span>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.<br>
  Copyright &copy; 2018 - Wen Liao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'httpwen00072githubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-2-setcion-command/';
        var disqus_url = 'http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-2-setcion-command/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
